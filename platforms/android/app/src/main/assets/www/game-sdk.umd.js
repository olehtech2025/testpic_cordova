(function(I,P){typeof exports=="object"&&typeof module<"u"?P(exports):typeof define=="function"&&define.amd?define(["exports"],P):(I=typeof globalThis<"u"?globalThis:I||self,P(I.coreSDK={}))})(this,(function(I){"use strict";const P="http://localhost:3000",J="http://localhost:3001",ne="http://localhost:3002",E={configUrl:P,authUrl:J,profileUrl:ne};function Oe(n){E.configUrl=n}function Be(n){E.authUrl=n}function Ue(n){E.profileUrl=n}const Ne="coreSDK_profiles_v1",Re=100,F=300*1e3,Me=600*1e3,xe=8*1024;class re{constructor(e){this.items=new Map,this.maxItems=e?.maxItems??Re,this.persist=e?.persist??!0,this.namespace=e?.namespace??null,this.storage=e?.storage,this.loadFromStorage()}get(e){const t=this.items.get(e);if(!t)return null;const s=Date.now();return s-t.cachedAt>t.ttl?(this.items.delete(e),this.saveToStorageSafe(),null):(t.lastAccessed=s,t.profile)}set(e,t){const s=Date.now(),i={profile:e,cachedAt:s,lastAccessed:s,ttl:t};this.items.set(e.id,i),this.evictIfNeeded(),this.saveToStorageSafe()}invalidate(e){this.items.delete(e)&&this.saveToStorageSafe()}invalidateAll(){this.items.clear(),this.saveToStorageSafe()}setNamespace(e){this.namespace!==e&&(this.namespace=e,this.items.clear(),this.loadFromStorage())}evictIfNeeded(){if(this.items.size<=this.maxItems)return;const e=Array.from(this.items.entries());e.sort((s,i)=>s[1].lastAccessed-i[1].lastAccessed);const t=e.length-this.maxItems;for(let s=0;s<t;s++){const[i]=e[s];this.items.delete(i)}}loadFromStorage(){if(this.persist&&this.namespace)try{const e=this.storage?this.storage.getItem(this.getStorageKey()):typeof localStorage<"u"?localStorage.getItem(this.getStorageKey()):null;if(!e)return;const t=JSON.parse(e);if(t.version!==1||!t.items||typeof t.items!="object")return;const s=Date.now();for(const[i,r]of Object.entries(t.items))!r||!r.profile||typeof r.cachedAt!="number"||typeof r.ttl!="number"||s-r.cachedAt>r.ttl||this.items.set(i,r);this.evictIfNeeded()}catch(e){console.error("[ProfileCache] loadFromStorage error:",e)}}saveToStorageSafe(){if(this.persist&&this.namespace)try{const e={};for(const[s,i]of this.items.entries())e[s]=i;const t={version:1,items:e};this.storage?this.storage.setItem(this.getStorageKey(),JSON.stringify(t)):typeof localStorage<"u"&&localStorage.setItem(this.getStorageKey(),JSON.stringify(t))}catch(e){console.error("[ProfileCache] saveToStorageSafe error:",e)}}getStorageKey(){return`${Ne}:${this.namespace}`}}class u extends Error{constructor(e,t){super(t),this.code=e,this.name="SDKError"}}const W={PROFILE_UPDATED:"profile.updated"};class oe{constructor(e,t,s,i,r){this.myProfileId=null,this.getAuthToken=e,this.events=t,this.usersClient=s,this.getBaseHeaders=i,this.selfCache=new re({persist:!0,storage:r}),this.otherCache=new re({persist:!1,storage:r})}primeSelf(e){!e||typeof e!="object"||Array.isArray(e)||!e.id||typeof e.id!="string"||(this.myProfileId=e.id,this.selfCache.set(e,F))}buildUrl(e){if(/^https?:\/\//i.test(e))return e;const t=E.profileUrl.replace(/\/+$/,""),s=e.replace(/^\/+/,"");return`${t}/${s}`}async request(e,t={}){const s=this.buildUrl(e),i=this.getAuthToken(),r={...this.getBaseHeaders?this.getBaseHeaders():{},"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`);let o;try{o=await fetch(s,{...t,headers:r,credentials:"include"})}catch{throw new u("NETWORKERROR","Network error")}if(!o.ok){const d=await o.text();let c=`Request failed with status ${o.status}`;try{const y=JSON.parse(d);Array.isArray(y.message)?c=y.message.join(", "):y.message?c=y.message:y.error&&(c=y.error)}catch{}const h=o.status===401?"UNAUTHORIZED":o.status===403?"FORBIDDEN":o.status===404?"NOTFOUND":o.status===400?"INVALIDPAYLOAD":"NETWORKERROR";throw new u(h,c)}const a=await o.text();return a?JSON.parse(a):null}emitUpdate(e){this.events.emit(W.PROFILE_UPDATED,{id:e.id,profile:e,source:"local"}),this.events.emit("profileupdated",e),typeof window<"u"&&window.dispatchEvent(new CustomEvent(W.PROFILE_UPDATED,{detail:{id:e.id,profile:e}}))}async getProfile(){if(this.myProfileId){const t=this.selfCache.get(this.myProfileId);if(t)return t}const e=await this.request("/v1/profiles/me");return this.myProfileId=e.id,this.selfCache.set(e,F),e}async getMe(){return this.getProfile()}async getProfileField(e){return(await this.request(`/v1/profiles/me/field/${e}`)).value}async updateProfile(e){if(typeof navigator<"u"&&navigator.onLine===!1)throw new u("OFFLINE","Profile update is not available offline");this.validateUpdatePayload(e);const t=await this.request("/v1/profiles/me",{method:"PATCH",body:JSON.stringify(e)});return this.myProfileId=t.id,this.selfCache.set(t,F),this.emitUpdate(t),t}async update(e){return this.updateProfile(e)}async getById(e){const t=this.otherCache.get(e);if(t)return t;if(!this.usersClient)throw new Error("UsersApiClient not configured");const s=await this.usersClient.getProfileById(e);return this.otherCache.set(s,Me),s}async getSummary(e){const t=e??this.myProfileId??"";if(t){const s=this.selfCache.get(t)||this.otherCache.get(t);if(s)return this.toSummary(s)}if(!this.usersClient)throw new Error("UsersApiClient not configured");if(!t){const s=await this.getProfile();return this.toSummary(s)}return this.usersClient.getSummary(t)}async setProfileField(e,t){const s=await this.request(`/v1/profiles/me/field/${e}`,{method:"PUT",body:JSON.stringify({value:t})});return this.myProfileId&&this.selfCache.invalidate(this.myProfileId),s.value}async mergeProfileScope(e,t){if(typeof navigator<"u"&&navigator.onLine===!1)throw new u("OFFLINE","Profile update is not available offline");this.validateUpdatePayload({scopes:{[e]:t}});const s=await this.request(`/v1/profiles/me/scope/${e}`,{method:"PATCH",body:JSON.stringify({data:t})});return this.myProfileId=s.id,this.selfCache.set(s,F),this.emitUpdate(s),s}invalidate(e){e?(this.selfCache.invalidate(e),this.otherCache.invalidate(e)):this.myProfileId&&this.selfCache.invalidate(this.myProfileId)}invalidateAll(){this.selfCache.invalidateAll(),this.otherCache.invalidateAll()}resetMyProfileId(){this.myProfileId=null}setUserIdentity(e){const t=e?.gid?String(e.gid):null;if(this.myProfileId=t,!t){this.selfCache.invalidateAll();return}this.selfCache.setNamespace(t)}toSummary(e){const t=e.scopes?.game?.level??0,s=e.scopes?.stats?.totalScore??e.scopes?.game?.score??0;return{id:e.id,name:e.base?.name??"",level:t,score:s}}validateUpdatePayload(e){if(!e||typeof e!="object"||Array.isArray(e))throw new u("INVALIDPAYLOAD","Profile update payload must be an object");let t="";try{t=JSON.stringify(e)}catch{throw new u("INVALIDPAYLOAD","Profile update payload is not serializable")}if(t.length>xe)throw new u("INVALIDPAYLOAD","Profile update payload is too large");const s=new Set(["base","scopes","custom"]);for(const i of Object.keys(e))if(!s.has(i))throw new u("INVALIDPAYLOAD",`Unknown field: ${i}`);if(e.base){const i=new Set(["name","avatar","locale"]);for(const d of Object.keys(e.base))if(!i.has(d))throw new u("INVALIDPAYLOAD",`Unknown base field: ${d}`);const{name:r,avatar:o,locale:a}=e.base;if(r!==void 0&&(typeof r!="string"||r.length>64))throw new u("INVALIDPAYLOAD","Invalid base.name");if(o!=null&&(typeof o!="string"||o.length>512))throw new u("INVALIDPAYLOAD","Invalid base.avatar");if(a!==void 0&&(typeof a!="string"||a.length>16))throw new u("INVALIDPAYLOAD","Invalid base.locale")}if(e.scopes){const i=new Set(["game","social","stats"]);for(const d of Object.keys(e.scopes))if(!i.has(d))throw new u("INVALIDPAYLOAD",`Unknown scope: ${d}`);const r=e.scopes.game;if(r&&(this.assertNumberField(r.level,"scopes.game.level"),this.assertNumberField(r.score,"scopes.game.score"),this.assertNumberField(r.xp,"scopes.game.xp"),this.assertNumberField(r.coins,"scopes.game.coins"),r.achievements!==void 0&&(!Array.isArray(r.achievements)||r.achievements.length>100||r.achievements.some(d=>typeof d!="string"||d.length>64))))throw new u("INVALIDPAYLOAD","Invalid scopes.game.achievements");const o=e.scopes.social;if(o&&(this.assertNumberField(o.friendsCount,"scopes.social.friendsCount"),o.referralCode!==void 0&&o.referralCode!==null&&(typeof o.referralCode!="string"||o.referralCode.length>64)))throw new u("INVALIDPAYLOAD","Invalid scopes.social.referralCode");const a=e.scopes.stats;a&&(this.assertNumberField(a.gamesPlayed,"scopes.stats.gamesPlayed"),this.assertNumberField(a.gamesWon,"scopes.stats.gamesWon"),this.assertNumberField(a.totalScore,"scopes.stats.totalScore"),this.assertNumberField(a.highestScore,"scopes.stats.highestScore"),this.assertNumberField(a.winRate,"scopes.stats.winRate"))}if(e.custom!==void 0&&(e.custom===null||typeof e.custom!="object"||Array.isArray(e.custom)))throw new u("INVALIDPAYLOAD","Invalid custom payload")}assertNumberField(e,t){if(e!==void 0&&(typeof e!="number"||Number.isNaN(e)))throw new u("INVALIDPAYLOAD",`Invalid ${t}`)}}class Ge{constructor(e,t){this.getAuthToken=e,this.getBaseHeaders=t}buildUrl(e){const t=E.configUrl.replace(/\/+$/,""),s=e.replace(/^\/+/,"");return`${t}/${s}`}async request(e,t={}){const s=this.buildUrl(e),i=this.getAuthToken(),r={...this.getBaseHeaders?this.getBaseHeaders():{},"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`),console.log("[API] REQUEST:",{url:s,method:t.method??"GET",headers:r,body:t.body});const o=await fetch(s,{...t,headers:r,credentials:"include"});if(!o.ok){const d=await o.text().catch(()=>"");throw console.error("[API] Request failed:",{url:s,status:o.status,body:d}),new Error(`Request failed with status ${o.status}`)}const a=await o.text();if(!a)return null;try{return JSON.parse(a)}catch(d){return console.warn("[API] Response is not JSON, returning as text:",d),a}}normalizeBody(e){return e===void 0?void 0:JSON.stringify(e)}send(e,t,s){return this.request(t,{method:e,body:this.normalizeBody(s)})}get(e){return this.send("GET",e)}post(e,t){return this.send("POST",e,t)}put(e,t){return this.send("PUT",e,t)}patch(e,t){return this.send("PATCH",e,t)}delete(e){return this.send("DELETE",e)}}class $e{constructor(){this.listeners=new Map,this.onceListeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}once(e,t){this.onceListeners.has(e)||this.onceListeners.set(e,new Set),this.onceListeners.get(e).add(t)}off(e,t){this.listeners.get(e)?.delete(t),this.onceListeners.get(e)?.delete(t)}emit(e,...t){this.listeners.get(e)?.forEach(i=>i(...t));const s=this.onceListeners.get(e);s&&(s.forEach(i=>i(...t)),this.onceListeners.delete(e))}}const Fe="coreSDK_auth_window_ctx_v1";class Ke{constructor(e){this.backdrop=null,this.state="login",this.busy=!1,this.googleEnabled=!0,this.elements={},this.options=e}show(){this.backdrop||typeof window>"u"||(this.injectStyles(),this.backdrop=document.createElement("div"),this.backdrop.className="coresdk-auth-overlay",this.backdrop.innerHTML=this.getHTML(),document.body.appendChild(this.backdrop),this.bindElements(),this.attachEvents(),this.renderState())}close(){this.backdrop&&(this.backdrop.remove(),this.backdrop=null)}setBusy(e){this.busy=e,this.renderState()}setError(e){this.elements.error&&(this.elements.error.textContent=e||"")}setState(e){this.state=e,this.renderState()}setGoogleEnabled(e){this.googleEnabled=e,this.renderState()}renderState(){const{googleBtn:e,guestBtn:t,emailBtn:s,codeBtn:i,loginStack:r,codeStack:o}=this.elements;r&&(r.style.display=this.state==="login"?"flex":"none"),o&&(o.style.display=this.state==="code"?"flex":"none"),e&&(e.disabled=this.busy||!this.googleEnabled,e.classList.toggle("disabled",!this.googleEnabled)),t&&(t.disabled=this.busy),s&&(s.disabled=this.busy),i&&(i.disabled=this.busy)}getHTML(){const e=this.options.title||"Authentication",t=this.options.subtitle||"Choose how you want to continue.";return`
      <div class="coresdk-auth-card" role="dialog" aria-modal="true">
        <button class="coresdk-auth-close" data-role="close" aria-label="Close">×</button>
        <h1 class="coresdk-auth-title">${e}</h1>
        <p class="coresdk-auth-subtitle">${t}</p>
        <div class="coresdk-auth-stack" data-role="login-stack">
          <button class="coresdk-auth-btn coresdk-auth-btn-google" data-role="google">
            Continue with Google
          </button>
          <input class="coresdk-auth-input" data-role="email" type="email" placeholder="Email address" autocomplete="email" />
          <button class="coresdk-auth-btn coresdk-auth-btn-email" data-role="email-btn">
            Continue with Email
          </button>
          <button class="coresdk-auth-btn coresdk-auth-btn-guest" data-role="guest">
            Continue as Guest
          </button>
        </div>
        <div class="coresdk-auth-stack" data-role="code-stack" style="display:none">
          <input class="coresdk-auth-input" data-role="code" type="text" placeholder="Enter code" inputmode="numeric" />
          <button class="coresdk-auth-btn coresdk-auth-btn-email" data-role="code-btn">
            Confirm Code
          </button>
          <button class="coresdk-auth-link" data-role="back" type="button">Back to login</button>
        </div>
        <div class="coresdk-auth-error" data-role="error"></div>
      </div>
    `}bindElements(){this.backdrop&&(this.elements.googleBtn=this.backdrop.querySelector('[data-role="google"]'),this.elements.guestBtn=this.backdrop.querySelector('[data-role="guest"]'),this.elements.emailBtn=this.backdrop.querySelector('[data-role="email-btn"]'),this.elements.codeBtn=this.backdrop.querySelector('[data-role="code-btn"]'),this.elements.backBtn=this.backdrop.querySelector('[data-role="back"]'),this.elements.emailInput=this.backdrop.querySelector('[data-role="email"]'),this.elements.codeInput=this.backdrop.querySelector('[data-role="code"]'),this.elements.error=this.backdrop.querySelector('[data-role="error"]'),this.elements.loginStack=this.backdrop.querySelector('[data-role="login-stack"]'),this.elements.codeStack=this.backdrop.querySelector('[data-role="code-stack"]'))}attachEvents(){if(!this.backdrop)return;this.backdrop.querySelector('[data-role="close"]')?.addEventListener("click",()=>this.options.onClose()),this.backdrop.addEventListener("click",t=>{t.target===this.backdrop&&this.options.onClose()}),this.elements.guestBtn?.addEventListener("click",()=>this.options.onGuest()),this.elements.googleBtn?.addEventListener("click",()=>this.options.onGoogle()),this.elements.emailBtn?.addEventListener("click",()=>{const t=(this.elements.emailInput?.value||"").trim();this.options.onEmail(t)}),this.elements.codeBtn?.addEventListener("click",()=>{const t=(this.elements.codeInput?.value||"").trim(),s=Number(t);this.options.onCode(s)}),this.elements.backBtn?.addEventListener("click",()=>this.options.onBack())}injectStyles(){if(document.getElementById("coresdk-inline-auth-styles"))return;const e=document.createElement("style");e.id="coresdk-inline-auth-styles",e.textContent=`
      .coresdk-auth-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.5);
        z-index: 999999;
        padding: 24px;
      }
      .coresdk-auth-card {
        position: relative;
        width: 100%;
        max-width: 380px;
        background: #fff;
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #111827;
      }
      .coresdk-auth-close {
        position: absolute;
        top: 12px;
        right: 12px;
        border: none;
        background: transparent;
        font-size: 20px;
        cursor: pointer;
        color: #6b7280;
      }
      .coresdk-auth-title {
        margin: 0 0 8px;
        font-size: 22px;
        font-weight: 700;
        text-align: center;
      }
      .coresdk-auth-subtitle {
        margin: 0 0 20px;
        text-align: center;
        font-size: 14px;
        color: #6b7280;
      }
      .coresdk-auth-stack {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .coresdk-auth-btn {
        width: 100%;
        border: 0;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        background: #111827;
        color: #fff;
        transition: transform 0.15s ease, opacity 0.15s ease;
      }
      .coresdk-auth-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .coresdk-auth-btn-google {
        background: #fff;
        color: #1f2937;
        border: 1px solid #e5e7eb;
      }
      .coresdk-auth-btn-google.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .coresdk-auth-btn-email {
        background: #2563eb;
      }
      .coresdk-auth-btn-guest {
        background: #111827;
      }
      .coresdk-auth-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
      }
      .coresdk-auth-link {
        background: transparent;
        border: none;
        color: #374151;
        font-size: 13px;
        cursor: pointer;
      }
      .coresdk-auth-error {
        margin-top: 16px;
        font-size: 12px;
        color: #b42318;
        min-height: 16px;
        text-align: center;
      }
    `,document.head.appendChild(e)}}const U=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,T=globalThis,G="10.27.0";function ae(){return V(T),T}function V(n){const e=n.__SENTRY__=n.__SENTRY__||{};return e.version=e.version||G,e[G]=e[G]||{}}function Y(n,e,t=T){const s=t.__SENTRY__=t.__SENTRY__||{},i=s[G]=s[G]||{};return i[n]||(i[n]=e())}const qe="Sentry Logger ",ce={};function He(n){if(!("console"in T))return n();const e=T.console,t={},s=Object.keys(ce);s.forEach(i=>{const r=ce[i];t[i]=e[i],e[i]=r});try{return n()}finally{s.forEach(i=>{e[i]=t[i]})}}function je(){X().enabled=!0}function Je(){X().enabled=!1}function le(){return X().enabled}function We(...n){z("log",...n)}function Ve(...n){z("warn",...n)}function Ye(...n){z("error",...n)}function z(n,...e){U&&le()&&He(()=>{T.console[n](`${qe}[${n}]:`,...e)})}function X(){return U?Y("loggerSettings",()=>({enabled:!1})):{enabled:!1}}const K={enable:je,disable:Je,isEnabled:le,log:We,warn:Ve,error:Ye},ze=Object.prototype.toString;function Xe(n,e){return ze.call(n)===`[object ${e}]`}function Qe(n){return Xe(n,"Object")}function Ze(n){return!!(n?.then&&typeof n.then=="function")}function et(n,e,t){try{Object.defineProperty(n,e,{value:t,writable:!0,configurable:!0})}catch{U&&K.log(`Failed to add non-enumerable property "${e}" to object`,n)}}function tt(n,e=0){return typeof n!="string"||e===0||n.length<=e?n:`${n.slice(0,e)}...`}function st(){const n=T;return n.crypto||n.msCrypto}let Q;function it(){return Math.random()*16}function $(n=st()){try{if(n?.randomUUID)return n.randomUUID().replace(/-/g,"")}catch{}return Q||(Q="10000000100040008000"+1e11),Q.replace(/[018]/g,e=>(e^(it()&15)>>e/4).toString(16))}const de=1e3;function he(){return Date.now()/de}function nt(){const{performance:n}=T;if(!n?.now||!n.timeOrigin)return he;const e=n.timeOrigin;return()=>(e+n.now())/de}let ue;function rt(){return(ue??(ue=nt()))()}function ot(n,e={}){if(e.user&&(!n.ipAddress&&e.user.ip_address&&(n.ipAddress=e.user.ip_address),!n.did&&!e.did&&(n.did=e.user.id||e.user.email||e.user.username)),n.timestamp=e.timestamp||rt(),e.abnormal_mechanism&&(n.abnormal_mechanism=e.abnormal_mechanism),e.ignoreDuration&&(n.ignoreDuration=e.ignoreDuration),e.sid&&(n.sid=e.sid.length===32?e.sid:$()),e.init!==void 0&&(n.init=e.init),!n.did&&e.did&&(n.did=`${e.did}`),typeof e.started=="number"&&(n.started=e.started),n.ignoreDuration)n.duration=void 0;else if(typeof e.duration=="number")n.duration=e.duration;else{const t=n.timestamp-n.started;n.duration=t>=0?t:0}e.release&&(n.release=e.release),e.environment&&(n.environment=e.environment),!n.ipAddress&&e.ipAddress&&(n.ipAddress=e.ipAddress),!n.userAgent&&e.userAgent&&(n.userAgent=e.userAgent),typeof e.errors=="number"&&(n.errors=e.errors),e.status&&(n.status=e.status)}function fe(n,e,t=2){if(!e||typeof e!="object"||t<=0)return e;if(n&&Object.keys(e).length===0)return n;const s={...n};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(s[i]=fe(s[i],e[i],t-1));return s}function ge(){return $()}const Z="_sentrySpan";function me(n,e){e?et(n,Z,e):delete n[Z]}function pe(n){return n[Z]}const at=100;class B{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._attributes={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:ge(),sampleRand:Math.random()}}clone(){const e=new B;return e._breadcrumbs=[...this._breadcrumbs],e._tags={...this._tags},e._attributes={...this._attributes},e._extra={...this._extra},e._contexts={...this._contexts},this._contexts.flags&&(e._contexts.flags={values:[...this._contexts.flags.values]}),e._user=this._user,e._level=this._level,e._session=this._session,e._transactionName=this._transactionName,e._fingerprint=this._fingerprint,e._eventProcessors=[...this._eventProcessors],e._attachments=[...this._attachments],e._sdkProcessingMetadata={...this._sdkProcessingMetadata},e._propagationContext={...this._propagationContext},e._client=this._client,e._lastEventId=this._lastEventId,me(e,pe(this)),e}setClient(e){this._client=e}setLastEventId(e){this._lastEventId=e}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&ot(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this.setTags({[e]:t})}setAttributes(e){return this._attributes={...this._attributes,...e},this._notifyScopeListeners(),this}setAttribute(e,t){return this.setAttributes({[e]:t})}removeAttribute(e){return e in this._attributes&&(delete this._attributes[e],this._notifyScopeListeners()),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return t===null?delete this._contexts[e]:this._contexts[e]=t,this._notifyScopeListeners(),this}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;const t=typeof e=="function"?e(this):e,s=t instanceof B?t.getScopeData():Qe(t)?e:void 0,{tags:i,attributes:r,extra:o,user:a,contexts:d,level:c,fingerprint:h=[],propagationContext:y}=s||{};return this._tags={...this._tags,...i},this._attributes={...this._attributes,...r},this._extra={...this._extra,...o},this._contexts={...this._contexts,...d},a&&Object.keys(a).length&&(this._user=a),c&&(this._level=c),h.length&&(this._fingerprint=h),y&&(this._propagationContext=y),this}clear(){return this._breadcrumbs=[],this._tags={},this._attributes={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._session=void 0,me(this,void 0),this._attachments=[],this.setPropagationContext({traceId:ge(),sampleRand:Math.random()}),this._notifyScopeListeners(),this}addBreadcrumb(e,t){const s=typeof t=="number"?t:at;if(s<=0)return this;const i={timestamp:he(),...e,message:e.message?tt(e.message,2048):e.message};return this._breadcrumbs.push(i),this._breadcrumbs.length>s&&(this._breadcrumbs=this._breadcrumbs.slice(-s),this._client?.recordDroppedEvent("buffer_overflow","log_item")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,attributes:this._attributes,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:pe(this)}}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata=fe(this._sdkProcessingMetadata,e,2),this}setPropagationContext(e){return this._propagationContext=e,this}getPropagationContext(){return this._propagationContext}captureException(e,t){const s=t?.event_id||$();if(!this._client)return U&&K.warn("No client configured on scope - will not capture exception!"),s;const i=new Error("Sentry syntheticException");return this._client.captureException(e,{originalException:e,syntheticException:i,...t,event_id:s},this),s}captureMessage(e,t,s){const i=s?.event_id||$();if(!this._client)return U&&K.warn("No client configured on scope - will not capture message!"),i;const r=s?.syntheticException??new Error(e);return this._client.captureMessage(e,t,{originalException:e,syntheticException:r,...s,event_id:i},this),i}captureEvent(e,t){const s=t?.event_id||$();return this._client?(this._client.captureEvent(e,{...t,event_id:s},this),s):(U&&K.warn("No client configured on scope - will not capture event!"),s)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}}function ct(){return Y("defaultCurrentScope",()=>new B)}function lt(){return Y("defaultIsolationScope",()=>new B)}class dt{constructor(e,t){let s;e?s=e:s=new B;let i;t?i=t:i=new B,this._stack=[{scope:s}],this._isolationScope=i}withScope(e){const t=this._pushScope();let s;try{s=e(t)}catch(i){throw this._popScope(),i}return Ze(s)?s.then(i=>(this._popScope(),i),i=>{throw this._popScope(),i}):(this._popScope(),s)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const e=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:e}),e}_popScope(){return this._stack.length<=1?!1:!!this._stack.pop()}}function N(){const n=ae(),e=V(n);return e.stack=e.stack||new dt(ct(),lt())}function ht(n){return N().withScope(n)}function ut(n,e){const t=N();return t.withScope(()=>(t.getStackTop().scope=n,e(n)))}function we(n){return N().withScope(()=>n(N().getIsolationScope()))}function ft(){return{withIsolationScope:we,withScope:ht,withSetScope:ut,withSetIsolationScope:(n,e)=>we(e),getCurrentScope:()=>N().getScope(),getIsolationScope:()=>N().getIsolationScope()}}function gt(n){const e=V(n);return e.acs?e.acs:ft()}function mt(){const n=ae();return gt(n).getCurrentScope()}function Rt(n){}function pt(n,e){return mt().captureException(n,void 0)}class wt{constructor(e){this.apiClient=e}async init(e){return this.apiClient.post("/v1/configs/get-init",e)}async fetch(e){return this.apiClient.post("/v1/configs/get-fetch",e)}}class yt{constructor(e,t){this.getAuthToken=e,this.getBaseHeaders=t}buildUrl(e,t){const s=(t??E.authUrl).replace(/\/+$/,""),i=e.replace(/^\/+/,"");return`${s}/${i}`}async request(e,t={},s){const i=this.buildUrl(e,s),r=this.getAuthToken(),o={...this.getBaseHeaders?this.getBaseHeaders():{},"Content-Type":"application/json",...t.headers};r&&(o.Authorization=`Bearer ${r}`);const a=await fetch(i,{...t,headers:o,credentials:"include"});if(!a.ok){const c=await a.text();let h=`Request failed with status ${a.status}`;try{const k=JSON.parse(c);Array.isArray(k.message)?h=k.message.join(", "):k.message?h=k.message:k.error&&(h=k.error)}catch{}const y=a.status===401?"UNAUTHORIZED":a.status===403?"FORBIDDEN":a.status===404?"NOTFOUND":a.status===400?"INVALIDPAYLOAD":"NETWORKERROR";throw new u(y,h)}const d=await a.text();return d?JSON.parse(d):null}async getAll(){return this.request("/v1/users")}async getById(e){return this.request(`/v1/users/${e}`)}async getSummary(e){return this.request(`/v1/profiles/${e}/summary`,{},E.profileUrl)}async getProfileById(e){return this.request(`/v1/profiles/${e}`,{},E.profileUrl)}async search(e){return this.request(`/v1/users/search?q=${encodeURIComponent(e)}`)}async create(e){return this.request("/v1/users",{method:"POST",body:JSON.stringify(e)})}async update(e,t){return this.request(`/v1/users/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.request(`/v1/users/${e}`,{method:"DELETE"})}}class vt{constructor(e,t){this.getAuthToken=e,this.getBaseHeaders=t}buildUrl(e){const t=E.authUrl.replace(/\/+$/,""),s=e.replace(/^\/+/,"");return`${t}/${s}`}async request(e,t={}){const s=this.buildUrl(e);let i=this.getAuthToken();!i&&typeof localStorage<"u"&&(i=localStorage.getItem("coreSDK_token")||void 0);const r={...this.getBaseHeaders?this.getBaseHeaders():{},"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`);const o=await fetch(s,{...t,headers:r,credentials:"include"});if(!o.ok){const d=await o.text();let c=`Request failed with status ${o.status}`;try{const h=JSON.parse(d);Array.isArray(h.message)?c=h.message.join(", "):h.message&&(c=h.message)}catch{}throw new Error(c)}const a=await o.text();return a?JSON.parse(a):null}async init(e){return this.request("/v1/auth/init",{method:"POST",body:JSON.stringify(e)})}async signin(e){return this.request("/v1/auth/signin",{method:"POST",body:JSON.stringify(e)})}async confirmCode(e){return this.request("/v1/auth/code",{method:"POST",body:JSON.stringify(e)})}async logout(){try{await this.request("/v1/auth/logout",{method:"POST"})}catch{}}async getOAuthConfig(){try{return await this.request("/v1/auth/oauth/config",{method:"GET"})}catch{try{return await this.request("/auth/oauth/config",{method:"GET"})}catch{return await this.request("/v1/oauth/config",{method:"GET"})}}}async getMe(){return this.request("/v1/auth/me",{method:"GET"})}async googleSignIn(e,t){return this.init({...t,et:e,pr:"google"})}async health(){return this.request("/v1/health",{method:"GET"})}}class St{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/events")}async send(e){return this.apiClient.post("/v1/events",e)}}class bt{constructor(e,t){this.getAuthToken=e,this.getBaseHeaders=t}buildUrl(e){const t=E.configUrl.replace(/\/+$/,""),s=e.replace(/^\/+/,"");return`${t}/${s}`}async request(e,t={}){const s=this.buildUrl(e),i=this.getAuthToken(),r={...this.getBaseHeaders?this.getBaseHeaders():{},"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`);const o=await fetch(s,{...t,headers:r,credentials:"include"});if(!o.ok){const d=await o.text();let c=`Request failed with status ${o.status}`;try{const h=JSON.parse(d);Array.isArray(h.message)?c=h.message.join(", "):h.message&&(c=h.message)}catch{}throw new Error(c)}const a=await o.text();return a?JSON.parse(a):null}async getAll(){return this.request("/v1/users/me/data",{method:"GET"})}async get(e){return this.request(`/v1/users/me/data/${encodeURIComponent(e)}`,{method:"GET"})}async getMany(e){return this.request("/v1/users/me/data/get",{method:"POST",body:JSON.stringify({keys:e})})}async set(e){return this.request("/v1/users/me/data",{method:"PUT",body:JSON.stringify({data:e})})}async delete(e){return this.request(`/v1/users/me/data/${encodeURIComponent(e)}`,{method:"DELETE"})}async deleteMany(e){const t=e.map(s=>this.delete(s));await Promise.all(t)}}class Et{constructor(e,t){this.getAuthToken=e,this.getBaseHeaders=t}buildUrl(e){const t=(E.profileUrl||E.configUrl).replace(/\/+$/,""),s=e.replace(/^\/+/,"");return`${t}/${s}`}async request(e,t={}){const s=this.buildUrl(e),i=this.getAuthToken(),r={...this.getBaseHeaders?this.getBaseHeaders():{},"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`);const o=await fetch(s,{...t,headers:r});if(!o.ok){const d=await o.text();let c=`Request failed with status ${o.status}`;try{const h=JSON.parse(d);h.message&&(c=h.message)}catch{}throw new Error(c)}const a=await o.text();return a?JSON.parse(a):null}async get(){return this.request("/v1/state",{method:"GET"})}async update(e){return this.request("/v1/state",{method:"PUT",body:JSON.stringify({meta:e})})}async getProfile(){return this.request("/v1/profile",{method:"GET"})}async updateProfile(e){return this.request("/v1/profile",{method:"PATCH",body:JSON.stringify(e)})}async getField(e){return this.request(`/v1/profile/field/${e}`,{method:"GET"})}async setField(e,t){return this.request(`/v1/profile/field/${e}`,{method:"PUT",body:JSON.stringify({value:t})})}async kvList(){return this.request("/v1/kv/list",{method:"GET"})}async kvGet(e){return this.request(`/v1/kv/${e}`,{method:"GET"})}async kvSet(e,t,s){await this.request("/v1/kv/set",{method:"POST",body:JSON.stringify({key:e,value:t,ttl:s})})}async kvDelete(e){return this.request(`/v1/kv/${e}`,{method:"DELETE"})}async kvExists(e){return this.request(`/v1/kv/exists/${e}`,{method:"GET"})}}const ee="1.0.108",te=[ee,"1.0.3","1.0.0"];function kt(n){return te.includes(n)}function ye(n){if(!kt(n)){const e=te.join(", ");throw new Error(`[SDK] Unsupported version "${n}". Supported versions: ${e}. Current SDK version: ${ee}`)}}class ve{constructor(e,t){this.response=e,this.configs=t,this.get=this.get.bind(this),this.has=this.has.bind(this),this.keys=this.keys.bind(this),this.values=this.values.bind(this),this.getAll=this.getAll.bind(this),this.getScope=this.getScope.bind(this),this.getMeta=this.getMeta.bind(this),this.raw=this.raw.bind(this)}get(e){const t=this.parsePath(e);if(t.length===0)return;const[s,...i]=t;let r=this.configs[s];for(const o of i){if(r==null)return;r=r[o]}return r}has(e){return this.get(e)!==void 0}keys(){const e=[];for(const t of Object.keys(this.configs))for(const s of Object.keys(this.configs[t]))e.push(`${t}.${s}`);return e}values(){const e=[];for(const t of Object.values(this.configs))for(const s of Object.values(t))e.push(s);return e}getAll(){return this.configs}getScope(e){return this.configs[e]}getMeta(){return{segment:this.response.segment,ab:this.response.ab,abG:this.response.abG,abExp:this.response.abExp}}raw(){return this.response}parsePath(e){return e.split(/\.|\[|\]/).filter(Boolean).map(t=>{const s=parseInt(t,10);return isNaN(s)?t:s})}}class Se{constructor(e="local"){this.memory=new Map,this.storage=this.resolveStorage(e)}getItem(e){if(this.storage)try{return this.storage.getItem(e)}catch{return null}return this.memory.get(e)??null}setItem(e,t){if(this.storage)try{this.storage.setItem(e,t);return}catch{}this.memory.set(e,t)}removeItem(e){if(this.storage)try{this.storage.removeItem(e);return}catch{}this.memory.delete(e)}resolveStorage(e){if(typeof window>"u")return null;try{if(e==="local"&&window.localStorage)return window.localStorage;if(e==="session"&&window.sessionStorage)return window.sessionStorage}catch{return null}return null}}class be{constructor(e,t,s=200){this.storage=e,this.storageKey=t,this.maxItems=s,this.items=[],this.load()}enqueue(e,t){const s={id:this.generateId(),ts:Date.now(),type:e,payload:t};return this.items.push(s),this.trim(),this.save(),s}size(){return this.items.length}async flush(e){if(!this.items.length)return;const t=[];for(const s of this.items)try{await e(s)}catch{t.push(s);break}this.items=t,this.save()}clear(){this.items=[],this.save()}load(){try{const e=this.storage.getItem(this.storageKey);if(!e)return;const t=JSON.parse(e);if(!Array.isArray(t))return;this.items=t.filter(s=>s&&s.id&&s.type)}catch{this.items=[]}}save(){try{this.storage.setItem(this.storageKey,JSON.stringify(this.items))}catch{}}trim(){this.items.length<=this.maxItems||(this.items=this.items.slice(this.items.length-this.maxItems))}generateId(){return`${Date.now().toString(36)}-${Math.random().toString(36).slice(2)}`}}class Ee{constructor(e,t,s){this.eventsClient=e,this.queue=t,this.eventBus=s,this.onlineListener=null,this.started=!1}start(){this.started||(this.started=!0,typeof window<"u"&&(this.onlineListener=()=>this.flush(),window.addEventListener("online",this.onlineListener)),this.flush(),this.eventBus.emit("analyticsready"))}stop(){this.started&&(this.started=!1,this.onlineListener&&typeof window<"u"&&window.removeEventListener("online",this.onlineListener),this.onlineListener=null)}async track(e,t){const s={name:e,data:t,timestamp:new Date().toISOString()};if(!this.isOnline()){this.queue.enqueue("event",s);return}try{await this.eventsClient.send(s)}catch{this.queue.enqueue("event",s)}}async flush(){this.isOnline()&&(await this.queue.flush(async e=>{e.type==="event"&&await this.eventsClient.send(e.payload)}),this.eventBus.emit("storagesynced",{queueSize:this.queue.size()}))}isOnline(){return typeof navigator>"u"||typeof navigator.onLine!="boolean"?!0:navigator.onLine}}class At{constructor(e,t,s,i){this.eventBus=e,this.url=t,this.autoReconnect=s,this.logger=i,this.socket=null,this.reconnectTimer=null,this.stopped=!1,this.reconnectAttempts=0}start(){this.stopped=!1,this.connect()}stop(){this.stopped=!0,this.reconnectTimer!==null&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.socket&&(this.socket.close(),this.socket=null)}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(e)}connect(){if(!this.stopped){try{this.socket=new WebSocket(this.url)}catch(e){this.logger.warn("[SDK] WebSocket init failed",e),this.scheduleReconnect();return}this.socket.onopen=()=>{this.reconnectAttempts=0,this.eventBus.emit("wsconnected",{wsUrl:this.url})},this.socket.onmessage=e=>{this.eventBus.emit("wsmessage",{data:e.data})},this.socket.onerror=e=>{this.eventBus.emit("wserror",{event:e})},this.socket.onclose=()=>{this.eventBus.emit("wsdisconnected",{wsUrl:this.url}),this.scheduleReconnect()}}}scheduleReconnect(){if(!this.autoReconnect||this.stopped)return;const e=Math.min(1e3*2**this.reconnectAttempts,15e3);this.reconnectAttempts+=1,this.reconnectTimer=setTimeout(()=>{this.connect()},e)}}class Ct{constructor(e,t){this.eventBus=e,this.heartbeatInterval=t,this.timer=null}start(){this.timer===null&&(this.eventBus.emit("sessionstarted",{heartbeatInterval:this.heartbeatInterval}),this.timer=setInterval(()=>{this.eventBus.emit("sessionheartbeat",{ts:Date.now()})},this.heartbeatInterval))}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null,this.eventBus.emit("sessionstopped",{ts:Date.now()}))}}const ke="https://accounts.google.com/gsi/client",ie=class ie{static async loadScript(){if(typeof window>"u")throw new Error("GoogleAuthHelper requires browser environment");if(!window.google?.accounts?.id)return this.scriptLoading?this.scriptLoading:(this.scriptLoading=new Promise((e,t)=>{const s=document.querySelector(`script[src="${ke}"]`);if(s){s.addEventListener("load",()=>e()),s.addEventListener("error",()=>t(new Error("Failed to load Google Sign-In")));return}const i=document.createElement("script");i.src=ke,i.async=!0,i.defer=!0,i.onload=()=>e(),i.onerror=()=>t(new Error("Failed to load Google Sign-In")),document.head.appendChild(i)}),this.scriptLoading)}static requestToken(e,t){return new Promise((s,i)=>{if(!window.google?.accounts?.id){i(new Error("Google Identity Services not loaded"));return}window.google.accounts.id.initialize({client_id:e,callback:r=>{r.credential?s(r):i(new Error("No credential received from Google"))},auto_select:!1,cancel_on_tap_outside:!1}),t?.useOneTap?window.google.accounts.id.prompt(r=>{if(r.isNotDisplayed()||r.isSkippedMoment()){const o=r.isNotDisplayed()?r.getNotDisplayedReason():r.getSkippedReason();i(new Error(`Google One Tap unavailable: ${o}. Try without useOneTap option.`))}}):this.triggerButtonPopup(e,s,i)})}static triggerButtonPopup(e,t,s){const i=document.createElement("div");i.style.position="fixed",i.style.top="-9999px",i.style.left="-9999px",document.body.appendChild(i);let r=!1;const o=()=>{i.parentNode&&i.parentNode.removeChild(i)},a=setTimeout(()=>{r||(o(),s(new Error("Google Sign-In timeout or cancelled by user")))},12e4);window.google.accounts.id.initialize({client_id:e,callback:d=>{r=!0,clearTimeout(a),o(),d.credential?t(d):s(new Error("No credential received from Google"))}}),window.google.accounts.id.renderButton(i,{type:"standard",size:"large",click_listener:()=>{console.log("[GoogleAuthHelper] Button clicked, waiting for response...")}}),requestAnimationFrame(()=>{const d=i.querySelector("div[role='button']");if(d)d.click();else{const c=i.querySelector("*");c&&c.click()}})}static isAvailable(){return typeof window<"u"&&!!window.google?.accounts?.id}static cancel(){window.google?.accounts?.id&&window.google.accounts.id.cancel()}};ie.scriptLoading=null;let R=ie;const Ae=()=>typeof window<"u"&&typeof navigator<"u",_t=()=>Ae()&&navigator.userAgent||"",It=n=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(n),Dt=()=>{if(!Ae())return{env:"unknown"};const n=window,e=_t(),t=n?.cordova,s=typeof t?.platformId=="string"?t.platformId:void 0;return t?s==="ios"?{env:"cordova-ios",platformId:s,userAgent:e}:s==="android"?{env:"cordova-android",platformId:s,userAgent:e}:{env:"unknown",platformId:s,userAgent:e}:{env:It(e)?"web-mobile":"web-desktop",userAgent:e}},Ce=n=>{const e=n?.get?.("ads")??null;if(!e||typeof e!="object")return null;const t=!!e.enabled,s=e.placements;return!s||typeof s!="object"?null:{enabled:t,defaults:e.defaults,mediators:e.mediators,placements:s}},q=n=>n==="cordova-ios"||n==="cordova-android"?"cordova":n==="web-mobile"||n==="web-desktop"?"web":null,Pt=(n,e)=>({placement:n,type:e,isReady:!1,isLoading:!1,readyTime:null,lastLoadStartTime:null,lastShowTime:null,retryCount:0,lastErrorCode:null,lastErrorMessage:null,stats:{totalLoads:0,successfulLoads:0,totalShows:0,totalRewards:0}}),Tt=(n,e,t)=>n==="linear"?t*e:n==="exponential"?t*Math.pow(2,e-1):0,Lt=(n,e,t)=>{let s;return Promise.race([n,new Promise((i,r)=>{s=setTimeout(()=>r(t),e)})]).finally(()=>clearTimeout(s))},Ot=(n,e)=>{if(n.isReady)return Promise.resolve(!0);const t=Date.now();return new Promise(s=>{const i=()=>{if(n.isReady)return s(!0);if(Date.now()-t>=e)return s(!1);setTimeout(i,100)};i()})},_e={},Bt=(n,e)=>{_e[n]=e},Ut=n=>_e[n]?.(),Ie=n=>{try{return JSON.stringify(n??{})}catch{return""}};class Nt{constructor(e){this.deps=e,this.enabled=!1,this.mediators=new Map,this.environment="unknown",this.placements=new Map,this.showingPlacement=null,this.adsConfig=null,this.mediatorsConfigHash=null,this.mediatorInitPromises=new Map;const t=e.eventBus;t&&(typeof t.emit=="function"&&(t.emit=t.emit.bind(t)),typeof t.on=="function"&&(t.on=t.on.bind(t)),typeof t.once=="function"&&(t.once=t.once.bind(t)),typeof t.off=="function"&&(t.off=t.off.bind(t)))}async init(){const{env:e,platformId:t,userAgent:s}=Dt();this.environment=e,this.deps.logger?.info?.("[AdManager] init start",{env:e,platformId:t,userAgent:s}),this.deps.eventBus?.emit?.("ads.init.start",{env:e});const i=Ce(this.deps.configService);if(this.adsConfig=i,!i){this.enabled=!1,this.deps.logger?.warn?.("[AdManager] ads config missing"),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"NO_CONFIG"});return}if(!i.enabled){this.enabled=!1,this.deps.logger?.info?.("[AdManager] ads disabled by config"),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"DISABLED"});return}const r=q(this.environment);if(!r){this.enabled=!1,this.deps.logger?.warn?.("[AdManager] unknown environment branch",{env:this.environment}),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"UNKNOWN_ENV"});return}this.mediatorsConfigHash=Ie(i.mediators),this.enabled=!0;const o=this.getMediatorsForBranch(i,r);this.deps.logger?.info?.("[AdManager] ads enabled",{env:e,branch:r,mediators:o}),this.deps.eventBus?.emit?.("ads.init.success",{env:e,branch:r,mediators:o}),this.deps.eventBus?.on?.("configsupdated",()=>{this.onConfigUpdated()});for(const[a,d]of Object.entries(i.placements))this.getPlacementState(a,d.type);if(i.defaults?.preloadOnStart)for(const[a,d]of Object.entries(i.placements))this.preloadPlacement(a,d).catch(c=>{this.deps.logger?.warn?.("[AdManager] preload failed",{placement:a,err:c})})}onConfigUpdated(){const e=Ce(this.deps.configService);if(!e){this.enabled=!1,this.adsConfig=null,this.deps.eventBus?.emit?.("ads.config.updated",{enabled:!1});return}const t=Ie(e.mediators);if(this.mediatorsConfigHash!==t){this.deps.logger?.info?.("[AdManager] mediators config changed, resetting");for(const i of this.mediators.values())i.destroy?.();this.mediators.clear(),this.mediatorsConfigHash=t}if(this.adsConfig=e,this.mediatorInitPromises.clear(),!e.enabled){this.enabled=!1,this.deps.eventBus?.emit?.("ads.config.updated",{enabled:!1});return}if(!q(this.environment)){this.enabled=!1,this.deps.eventBus?.emit?.("ads.config.updated",{enabled:!1});return}this.enabled=!0;for(const i of this.placements.keys())e.placements[i]||this.placements.delete(i);for(const[i,r]of Object.entries(e.placements))this.placements.has(i)||(this.getPlacementState(i,r.type),e.defaults?.preloadOnStart&&this.preloadPlacement(i,r).catch(()=>{}));this.deps.eventBus?.emit?.("ads.config.updated",{enabled:!0})}getMediatorsForBranch(e,t){const s=new Set;for(const i of Object.values(e.placements)){const r=i?.[t]?.mediator;r&&s.add(r)}return Array.from(s)}async getMediatorForPlacement(e,t){const s=q(this.environment);if(!s)return null;const r=t?.[s]?.mediator;if(!r)return null;let o=this.mediators.get(r);if(o)return o;let a=this.mediatorInitPromises.get(r);return a||(a=(async()=>{const d=Ut(r);if(!d)throw new Error("MEDIATOR_NOT_REGISTERED");return await d.init(this.adsConfig,this.environment),this.mediators.set(r,d),this.mediatorInitPromises.delete(r),d})(),this.mediatorInitPromises.set(r,a)),a}async showAd(e,t,s){const i=Date.now(),r=this.adsConfig,o=r?.placements?.[t];if(this.deps.eventBus?.emit?.("ads.show.request",{placement:t,type:e}),console.group(`[ADS][showAd] ${t} (${e})`),console.log("[ADS] enabled:",this.enabled),console.log("[ADS] adsConfig:",r),console.log("[ADS] placementConfig:",o),!r||!this.enabled){const p={status:"SDK_DISABLED",type:e,placement:t,canReward:!1,timestamp:i};return console.warn("[ADS] SDK disabled"),s?.(p),this.deps.eventBus?.emit?.("ads.show.failed",p),console.groupEnd(),p}const a=q(this.environment),d=a?o?.[a]:null;if(!o||o.type!==e||!d?.mediator){const p={status:"NO_CONFIG",type:e,placement:t,canReward:!1,timestamp:i};return console.warn("[ADS] NO_CONFIG for placement"),s?.(p),this.deps.eventBus?.emit?.("ads.show.failed",p),console.groupEnd(),p}let c;try{c=await this.getMediatorForPlacement(t,o)}catch(p){const w={status:"INTERNAL_ERROR",type:e,placement:t,canReward:!1,errorMessage:p instanceof Error?p.message:String(p),timestamp:i};return console.error("[ADS][ERROR] mediator init failed",p),s?.(w),this.deps.eventBus?.emit?.("ads.show.failed",w),console.groupEnd(),w}if(console.group("[ADS][DEBUG] mediator raw"),console.log("mediator:",c),console.log("typeof:",typeof c),console.groupEnd(),typeof c=="function"&&(console.warn("[ADS][DEBUG] mediator is function → invoking"),c=c()),c instanceof Promise&&(console.warn("[ADS][DEBUG] mediator is Promise → awaiting"),c=await c),console.group("[ADS][DEBUG] mediator resolved"),console.log("mediator:",c),console.log("typeof:",typeof c),console.log("keys:",c?Object.keys(c):null),console.log("has init:",typeof c?.init),console.log("has load:",typeof c?.load),console.log("has show:",typeof c?.show),console.log("proto:",c?Object.getPrototypeOf(c):null),console.groupEnd(),!c||typeof c.show!="function"){const p={status:"INTERNAL_ERROR",type:e,placement:t,canReward:!1,errorMessage:"Mediator.show is not a function",timestamp:Date.now()};return console.error("[ADS][FATAL] mediator.show missing",c),s?.(p),console.groupEnd(),p}if(this.showingPlacement){const p={status:"SHOW_FAILED",type:e,placement:t,canReward:!1,errorMessage:"Ad already showing",timestamp:i};return console.warn("[ADS] Ad already showing"),s?.(p),this.deps.eventBus?.emit?.("ads.show.failed",p),console.groupEnd(),p}const h=this.getPlacementState(t,e),y=r?.defaults?.loadTimeoutMs??15e3;if(console.log("[ADS] state before show:",h),!h.isReady&&(console.warn("[ADS] not ready → preload"),this.preloadPlacement(t,o).catch(()=>{}),!await Ot(h,y))){const w={status:"NOT_READY",type:e,placement:t,canReward:!1,errorCode:"LOAD_TIMEOUT",errorMessage:`Ad not ready after ${y}ms`,timestamp:Date.now()};return console.warn("[ADS] NOT_READY timeout"),s?.(w),this.deps.eventBus?.emit?.("ads.show.failed",w),console.groupEnd(),w}this.showingPlacement=t,h.lastShowTime=Date.now(),h.stats.totalShows++,console.log("[ADS] showingPlacement set:",t);const k=r?.defaults?.showTimeoutMs??15e3;return new Promise(p=>{let w=!1;const C=b=>{if(w)return;w=!0,this.showingPlacement=null,e!=="banner"&&(h.isReady=!1);const v={...b,type:e,placement:t,timestamp:Date.now()};typeof v.canReward!="boolean"&&(v.canReward=v.status==="REWARD_GRANTED"),v.canReward&&(v.rewardType==null&&(v.rewardType=o.rewardType??null),v.rewardAmount==null&&(v.rewardAmount=o.rewardAmount??null),h.stats.totalRewards++),console.log("[ADS] finish:",v),v.status==="REWARD_GRANTED"?(this.deps.eventBus?.emit?.("ads.reward.granted",{placement:t,type:e,rewardType:v.rewardType??null,rewardAmount:v.rewardAmount??null}),this.deps.eventBus?.emit?.("ads.show.completed",v)):v.status==="COMPLETED"?this.deps.eventBus?.emit?.("ads.show.completed",v):v.status==="CANCELLED"?this.deps.eventBus?.emit?.("ads.show.closed",v):this.deps.eventBus?.emit?.("ads.show.failed",v),s?.(v),p(v),this.preloadPlacement(t,o).catch(()=>{}),console.groupEnd()},D=setTimeout(()=>{console.warn("[ADS] SHOW TIMEOUT"),C({status:"TIMEOUT",type:e,placement:t,canReward:!1,timestamp:Date.now()})},k);try{console.log("[ADS] calling mediator.show()"),this.deps.eventBus?.emit?.("ads.show.start",{placement:t,type:e}),c.show(e,t,o,b=>{clearTimeout(D),console.log("[ADS] mediator result:",b),C(b)})}catch(b){clearTimeout(D),console.error("[ADS][ERROR] mediator.show exception",b),C({status:"INTERNAL_ERROR",type:e,placement:t,canReward:!1,errorMessage:String(b),timestamp:Date.now()})}})}getPlacementState(e,t){let s=this.placements.get(e);return s||(s=Pt(e,t),this.placements.set(e,s)),s}async preloadPlacement(e,t){const s=this.getPlacementState(e,t.type),i=this.adsConfig;if(i&&!s.isReady)return s.isLoading&&s.loadPromise||(s.isLoading=!0,s.lastLoadStartTime=Date.now(),s.stats.totalLoads++,this.deps.eventBus?.emit?.("ads.placement.preload.start",{placement:e}),s.loadPromise=(async()=>{const r=i.defaults?.retry,o=r?.strategy??"none",a=r?.maxAttempts??0,d=r?.baseDelayMs??0,c=i.defaults?.loadTimeoutMs??15e3;for(;;)try{const h=await this.getMediatorForPlacement(e,t);if(!h)throw new Error("NO_MEDIATOR");await Lt(h.load(t.type,e,t),c,new Error("LOAD_TIMEOUT")),s.isReady=!0,s.retryCount=0,s.readyTime=Date.now(),s.stats.successfulLoads++,this.deps.eventBus?.emit?.("ads.placement.preload.success",{placement:e});return}catch(h){if(s.retryCount++,s.lastErrorCode=h?.code??"LOAD_FAILED",s.lastErrorMessage=h?.message??"Ad load failed",this.deps.eventBus?.emit?.("ads.placement.preload.failed",{placement:e,errorCode:s.lastErrorCode,errorMessage:s.lastErrorMessage}),s.retryCount>a||o==="none")return;const y=Tt(o,s.retryCount,d);await new Promise(k=>setTimeout(k,y))}})().finally(()=>{s.isLoading=!1,s.loadPromise=null})),s.loadPromise}}const H={ios:1,android:2,web:3,windows:3,macos:3,linux:3,unknown:3},se="coreSDK_meta_v1",De="coreSDK_configs_v1:";class M{constructor(){this.eventBus=new $e,this.systemParams={},this.initialized=!1,this.logger=console,this.sdkMeta=null,this.lastInitContext=null,this.profileInvalidationSet=!1,this.dataContext={a:{},d:{},u:{},c:{}},this.storageScope="local",this.wsService=null,this.sessionService=null,this.configRefreshTimer=null,this.wsMessageHandler=null,this.oauthConfig=null,this.adManager=null,this.configState={configs:{}},this.detectEnvironment(),this.storage=new Se("local"),this.apiClient=new Ge(()=>this.systemParams.authToken,()=>this.getBaseHeaders()),this.configsClient=new wt(this.apiClient),this.configs={get:(e,t)=>this.getConfigSnapshotValue(e,t),getScope:e=>this.configState.configs[e]??{}},this.users=new yt(()=>this.systemParams.authToken,()=>this.getBaseHeaders()),this.auth=new vt(()=>this.systemParams.authToken,()=>this.getBaseHeaders()),this.eventsClient=new St(this.apiClient),this.gamestate=new Et(()=>this.systemParams.authToken,()=>this.getBaseHeaders()),this.kv=new bt(()=>this.systemParams.authToken,()=>this.getBaseHeaders()),this.profileClient=new oe(()=>this.systemParams.authToken,this.eventBus,this.users,()=>this.getBaseHeaders(),this.storage),this.profile={getMe:()=>this.profileClient.getMe(),getById:e=>this.profileClient.getById(e),update:e=>this.profileClient.update(e),getSummary:e=>this.profileClient.getSummary(e)},this.offlineQueue=new be(this.storage,"coreSDK_offline_queue_v1"),this.analyticsService=new Ee(this.eventsClient,this.offlineQueue,this.eventBus),this.adManagerDeps={configService:this.configs,eventBus:this.eventBus,logger:this.logger},this.ads={init:()=>this.initAds(),showAd:(e,t,s)=>this.showAd(e,t,s),setMockConfig:e=>this.setAdsMockConfig(e),registerMediator:(e,t)=>Bt(e,t)}}static getInstance(){return M.instance||(M.instance=new M),M.instance}async init(e,t){if(this.isLegacyInitOptions(e)){const s=e,i={endpoints:{baseUrl:s.configUrl||s.baseUrl||P,configUrl:s.configUrl,authUrl:s.authUrl,profileUrl:s.profileUrl,authPageUrl:s.authPageUrl},app:s.app||"default",os:s.os||"web",version:s.version||"0.0.0",region:s.region,locale:s.locale,geo:s.geo,marketing:s.marketing,device:s.device,custom:s.custom,token:s.token,modules:s.modules,configs:s.configs,logLevel:s.logLevel,onReady:s.onReady??t};return this.initPlatform(i)}return t&&(e.onReady=t),this.initPlatform(e)}isLegacyInitOptions(e){return!("endpoints"in e)}async initPlatform(e){this.setLogger(e.logLevel),this.logger.info("[SDK] init: start",e),e.endpoints||(e.endpoints={}),e.endpoints?.baseUrl||(e.endpoints.baseUrl=P),e.endpoints?.configUrl||(e.endpoints.baseUrl=P),e.endpoints?.authUrl||(e.endpoints.authUrl=J),e.endpoints?.profileUrl||(e.endpoints.profileUrl=ne);try{ye(e.version)}catch(i){throw this.logger.error("[SDK] init: version not supported",i),i}this.applyEndpoints(e),this.applySystemParams(e),this.dataContext=this.buildDataContext(e),this.lastInitContext=e,this.initStorage(e.modules?.storage?.scope);try{const i=await this.ensureDeviceId();this.systemParams.deviceId=i,this.dataContext.d.did||(this.dataContext.d.did=i)}catch(i){this.emitSdkError(i)}this.sdkMeta=this.loadSdkMeta(),(this.sdkMeta?.gid||this.sdkMeta?.uid)&&this.profileClient.setUserIdentity({uid:this.sdkMeta.uid,gid:this.sdkMeta.gid});const t=e.token||this.sdkMeta?.jwt||null;if(t||(this.systemParams.authToken=void 0),t){this.systemParams.authToken=t;const i=await this.tryValidateToken();i?this.applyAuthContext(i):(this.emitSdkError(new u("INVALIDTOKEN","Stored token invalid")),this.clearToken(),this.clearSdkMeta(),this.systemParams.authToken=void 0,this.profileClient.setUserIdentity(null),this.profileClient.invalidateAll())}if(!this.systemParams.authToken){const i=await this.loginAsGuest();this.applyAuthContext({jwt:i.jwt,uid:i.uid,gid:i.gid,anonymous:i.an,ts:Date.now()})}if(!this.systemParams.authToken)throw new Error("Authentication unavailable");this.initialized=!0,this.restoreConfigSnapshot(),this.ensureProfileInvalidation();const s=await this.refreshAll(e);return this.startBackgroundServices(e),await this.initAds(),this.eventBus.emit("sdkready",s),e.onReady?.(),s}setLogger(e){const t=()=>{},s={debug:0,info:1,warn:2,error:3},i=s[e??"debug"];this.logger={...console,debug:i<=s.debug?console.debug.bind(console):t,info:i<=s.info?console.info.bind(console):t,warn:i<=s.warn?console.warn.bind(console):t,error:console.error.bind(console)},this.adManagerDeps.logger=this.logger}initStorage(e){const t=e??"local";this.storage&&this.storageScope===t||(this.storageScope=t,this.storage=new Se(t),this.offlineQueue=new be(this.storage,"coreSDK_offline_queue_v1"),this.analyticsService=new Ee(this.eventsClient,this.offlineQueue,this.eventBus),this.profileClient=new oe(()=>this.systemParams.authToken,this.eventBus,this.users,()=>this.getBaseHeaders(),this.storage))}buildDataContext(e){return{a:{app:e.app,os:e.os,version:e.version},d:{idfa:e.device?.idfa,idfv:e.device?.idfv,gaid:e.device?.gaid,did:e.device?.did},u:{region:e.region,locale:e.locale,geo:e.geo,marketing:e.marketing},c:{...e.custom??{}}}}getBaseHeaders(){const e={},t=this.compactDataContext(this.dataContext);if(t)try{e["X-SDK-Context"]=JSON.stringify(t)}catch(s){this.logger.warn("[SDK] failed to stringify dataContext",s)}return this.dataContext.a.app&&(e["X-SDK-App"]=String(this.dataContext.a.app)),this.dataContext.a.os&&(e["X-SDK-OS"]=String(this.dataContext.a.os)),this.dataContext.a.version&&(e["X-SDK-Version"]=String(this.dataContext.a.version)),e}compactDataContext(e){const t=Object.values(e.a).some(d=>d!=null&&d!==""),s=Object.values(e.d).some(d=>d!=null&&d!==""),i=e.u.marketing??void 0,r=!!(i?.ms||i?.mc),o=!!(e.u.region||e.u.locale||e.u.geo)||r,a=Object.keys(e.c||{}).length>0;return!t&&!s&&!o&&!a?null:{a:t?e.a:{},d:s?e.d:{},u:o?{region:e.u.region,locale:e.u.locale,geo:e.u.geo,marketing:r?i:void 0}:{},c:a?e.c:{}}}buildConfigValues(e){const t={},{a:s,d:i,u:r,c:o}=this.dataContext;s.app&&(t.app=s.app),s.os&&(t.os=s.os),s.version&&(t.version=s.version),i.idfa&&(t.idfa=i.idfa),i.idfv&&(t.idfv=i.idfv),i.gaid&&(t.gaid=i.gaid),i.did&&(t.did=i.did),r.region&&(t.region=r.region),r.locale&&(t.locale=r.locale),r.geo&&(t.geo=r.geo),r.marketing?.ms&&(t.ms=r.marketing.ms),r.marketing?.mc&&(t.mc=r.marketing.mc);const a={...t,...o,...e??{}};return Object.keys(a).length?a:e}applyEndpoints(e){const t=e.endpoints.baseUrl,s=e.endpoints.configUrl||t,i=e.endpoints.authPageUrl;let r=e.endpoints.authUrl||t;const o=e.endpoints.profileUrl||t;if(!e.endpoints.authUrl&&i)try{r=(typeof window<"u"?new URL(i,window.location.href):new URL(i)).origin,this.logger.info?.("[SDK] inferred authUrl from authPageUrl",{authUrl:r,authPageUrl:i})}catch(a){this.logger.warn?.("[SDK] failed to infer authUrl from authPageUrl",a)}Oe(s),Be(r),Ue(o),this.authPageUrl=i}applySystemParams(e){this.setSystemParams({app:e.app,os:e.os,version:e.version,region:e.region,locale:e.locale,geo:e.geo,marketing:e.marketing,device:e.device}),e.device?.did&&(this.storeDeviceId(e.device.did),this.systemParams.deviceId=e.device.did)}async tryValidateToken(){try{const e=await this.auth.getMe();return{jwt:this.systemParams.authToken,uid:e.uid,gid:e.gid,anonymous:e.an,ts:Date.now()}}catch(e){return this.logger.warn("[SDK] init: token validation failed",e),null}}applyAuthContext(e){this.storeToken(e.jwt),this.systemParams.authToken=e.jwt,this.saveSdkMeta(e),this.profileClient.setUserIdentity({uid:e.uid,gid:e.gid})}async refreshAll(e){const t=this.resolveInitConfigs(e),s=this.profileClient.getMe(),i=this.initConfigsInternal({version:e.version,scopes:t.scopes,keys:t.keys,values:t.values,segment:t.segment},!1),[r,o]=await Promise.allSettled([s,i]);r.status==="fulfilled"?this.eventBus.emit("profileupdated",r.value):this.emitSdkError(r.reason);let a={};if(o.status==="fulfilled"){const d=o.value;a=d.getMeta(),this.eventBus.emit("configsfetched",d.getAll()),this.eventBus.emit("configsupdated",d.getAll()),this.saveConfigSnapshot()}else this.emitSdkError(o.reason);return{jwt:this.systemParams.authToken,user:{uid:this.sdkMeta?.uid??0,gid:this.sdkMeta?.gid??0,anonymous:this.sdkMeta?.anonymous??!1},segment:a.segment,ab:a.ab,snapshot:this.configState.configs}}resolveInitConfigs(e){const t=e.configs?.scopes??(e.modules?.configs?.defaultScope?Array.isArray(e.modules.configs.defaultScope)?e.modules.configs.defaultScope:[e.modules.configs.defaultScope]:[]),s=e.configs?.keys??e.modules?.configs?.defaultConfigs;return{scopes:t,keys:s,values:e.configs?.values,segment:e.configs?.segment}}emitSdkError(e){this.eventBus.emit("sdkerror",e)}ensureProfileInvalidation(){this.profileInvalidationSet||(this.profileInvalidationSet=!0,this.on(W.PROFILE_UPDATED,e=>{try{if(e?.source==="local")return;const t=e?.gid??e?.detail?.gid??e?.id??e?.detail?.id;t&&(this.logger.info("[SDK] profile cache invalidated for",t),this.profileClient.invalidate(t))}catch(t){this.logger.error("[SDK] profile cache invalidation error:",t)}}))}startBackgroundServices(e){this.stopBackgroundServices();const t=e.modules;if(this.analyticsService.start(),t?.session?.enabled){const r=t.session.heartbeatInterval??3e4;this.sessionService=new Ct(this.eventBus,r),this.sessionService.start()}t?.ws?.enabled&&e.endpoints.wsUrl&&typeof WebSocket<"u"&&(this.wsService=new At(this.eventBus,e.endpoints.wsUrl,t.ws.autoReconnect!==!1,this.logger),this.wsService.start(),this.wsMessageHandler=r=>this.handleWsMessage(r),this.eventBus.on("wsmessage",this.wsMessageHandler));const s=this.resolveInitConfigs(e);if(s.scopes&&s.scopes.length>0||s.keys&&s.keys.length>0){const r=t?.configs?.refreshIntervalMs??3e5;r>0&&(this.configRefreshTimer=setInterval(()=>{this.fetchConfigsInternal({version:e.version,scopes:s.scopes,keys:s.keys,values:s.values}).catch(o=>this.emitSdkError(o))},r))}}ensureAdManager(){return this.adManager||(this.adManager=new Nt(this.adManagerDeps)),this.adManager}async initAds(){try{await this.ensureAdManager().init()}catch(e){this.emitSdkError(e)}}async showAd(e,t,s){return this.ensureAdManager().showAd(e,t,s)}setAdsMockConfig(e){if(e)this.configState.configs={...this.configState.configs,ads:e};else{const{ads:t,...s}=this.configState.configs;this.configState.configs=s}this.saveConfigSnapshot(),this.eventBus.emit("configsupdated",this.configState.configs)}stopBackgroundServices(){this.sessionService&&(this.sessionService.stop(),this.sessionService=null),this.wsService&&(this.wsService.stop(),this.wsService=null),this.wsMessageHandler&&(this.eventBus.off("wsmessage",this.wsMessageHandler),this.wsMessageHandler=null),this.configRefreshTimer!==null&&(clearInterval(this.configRefreshTimer),this.configRefreshTimer=null),this.analyticsService.stop()}handleWsMessage(e){if(!e?.data)return;let t=e.data;if(typeof t=="string")try{t=JSON.parse(t)}catch{return}t?.configs&&typeof t.configs=="object"&&(this.configState.configs={...this.configState.configs,...t.configs},this.saveConfigSnapshot(),this.eventBus.emit("configsupdated",this.configState.configs))}loadSdkMeta(){try{const e=this.storage.getItem(se);return e?JSON.parse(e):null}catch(e){return this.logger.warn("[SDK] loadSdkMeta error:",e),null}}saveSdkMeta(e){this.sdkMeta={jwt:e.jwt,uid:e.uid,gid:e.gid,anonymous:e.anonymous,ts:e.ts??Date.now()};try{this.storage.setItem(se,JSON.stringify(this.sdkMeta))}catch(t){this.logger.warn("[SDK] saveSdkMeta error:",t)}}clearSdkMeta(){this.sdkMeta=null;try{this.storage.removeItem(se)}catch(e){this.logger.warn("[SDK] clearSdkMeta error:",e)}}restoreConfigSnapshot(){const e=this.sdkMeta?.gid??"anon",t=`${De}${e}`;try{const s=this.storage.getItem(t);if(!s)return;const i=JSON.parse(s);i?.configs&&(this.configState={segment:i.segment,ab:i.ab,abG:i.abG,abExp:i.abExp,configs:i.configs})}catch(s){this.logger.warn("[SDK] restoreConfigSnapshot error:",s)}}saveConfigSnapshot(){const e=this.sdkMeta?.gid??"anon",t=`${De}${e}`;try{this.storage.setItem(t,JSON.stringify({segment:this.configState.segment,ab:this.configState.ab,abG:this.configState.abG,abExp:this.configState.abExp,configs:this.configState.configs}))}catch(s){this.logger.warn("[SDK] saveConfigSnapshot error:",s)}}getConfigSnapshotValue(e,t){if(!e)return t;const s=this.parseConfigPath(e);if(s.length===0)return t;const[i,...r]=s;let o=this.configState.configs[i];for(const a of r){if(o==null)return t;o=o[a]}return o??t}parseConfigPath(e){return e.split(/\.|\[|\]/).filter(Boolean).map(t=>{const s=parseInt(t,10);return Number.isNaN(s)?t:s})}resolveAuthWindowUrl(e){if(e?.url)return e.url;if(this.authPageUrl)return this.authPageUrl;const t=E.authUrl||J;try{const s=typeof window<"u"?new URL(t,window.location.href):new URL(t),i=s.pathname.replace(/\/+$/,"");return i.includes("/auth")||i.includes("/login")||(!i||i==="/"||i==="/v1")&&(s.pathname="/auth"),s.toString()}catch{return t.includes("/auth")||t.includes("/login")?t:t.endsWith("/v1")?`${t.slice(0,-3)}/auth`:t.endsWith("/")?`${t}auth`:`${t}/auth`}}buildWindowFeatures(e){if(e?.features)return e.features;const t=e?.width??480,s=e?.height??720;if(typeof window>"u")return`width=${t},height=${s},resizable=yes,scrollbars=yes`;const i=window.screenX+(window.outerWidth-t)/2,r=window.screenY+(window.outerHeight-s)/2;return`width=${t},height=${s},left=${i},top=${r},resizable=yes,scrollbars=yes`}buildFallbackInitContext(){return{endpoints:{baseUrl:E.configUrl,configUrl:E.configUrl,authUrl:E.authUrl,profileUrl:E.profileUrl},app:this.systemParams.app||"default",os:this.systemParams.os||"web",version:this.systemParams.version||"0.0.0"}}captureError(e){try{pt(e)}catch(t){console.error("[SDK] Sentry capture error:",t)}}async authWindow(e){const s=!(e?.url||this.authPageUrl),i=s?"about:blank":this.resolveAuthWindowUrl(e),r=typeof window<"u"?s?window.location.origin:new URL(i,window.location.href).origin:new URL(i).origin,o=s?"*":r,a=this.buildWindowFeatures(e);return this.persistAuthWindowContext(),this.eventBus.emit("authwindowopen",{url:i}),this.eventBus.emit("authsigninstart",{url:i}),new Promise((d,c)=>{let h=!1,y=null,k=!1,p,w=null,C=null;const D=(l,f)=>{f&&typeof window<"u"&&window.removeEventListener("message",f),l&&!l.closed&&l.close()},b=l=>{if(!(!C||C.closed))try{C.postMessage(JSON.stringify(l),o)}catch(f){this.logger.warn("[SDK] auth window postMessage failed",f)}},v=async()=>{if(p!==void 0)return p;try{await this.loadOAuthConfig();const l=this.getGoogleClientId();if(l)return p=l,p}catch{throw new Error("Failed to fetch Google OAuth config")}if(typeof window<"u"){const l=window,f=l.GOOGLE_CLIENT_ID||l.googleClientId||l.__GOOGLE_CLIENT_ID__;if(f)return p=f,p}return p=null,p},_=l=>{k=l,w?w.setBusy(l):b({state:"busy",busy:k})},L=async l=>{try{w&&w.close(),h=!0,this.systemParams.authToken=l;const f=await this.auth.getMe(),m={jwt:l,uid:f.uid,gid:f.gid,anonymous:f.an,ts:Date.now()};this.applyAuthContext(m),this.profileClient.resetMyProfileId(),this.profileClient.invalidateAll();const g=this.lastInitContext??this.buildFallbackInitContext();await this.refreshAll(g),this.startBackgroundServices(g),m.segment=this.configState.segment,m.ab=this.configState.ab,this.eventBus.emit("authsigninsuccess",m),this.eventBus.emit("authwindowclose",{ok:!0}),d(m)}catch(f){const m=f instanceof Error?f.message:"Auth failed",g=m.includes("Failed to fetch")||m.includes("Network")?"NETWORKERROR":"INVALIDTOKEN",A=new u(g,m);this.eventBus.emit("authsigninfailed",A),this.eventBus.emit("authwindowclose",{ok:!1}),c(A)}};if(typeof window>"u"){const l=new u("AUTHFAILED","Auth window not available");this.eventBus.emit("authsigninfailed",l),this.eventBus.emit("authwindowclose",{ok:!1}),c(l);return}if(s){w=new Ke({title:e?.title,onGuest:async()=>{if(!(h||k)){_(!0);try{const l=await this.loginAsGuest();await L(l.jwt)}catch(l){const f=l instanceof Error?l.message:"Auth failed",m=l instanceof u?l:new u("AUTHFAILED",f);this.eventBus.emit("authsigninfailed",m),w?.setError(m.message)}finally{_(!1)}}},onGoogle:async()=>{if(!(h||k)){_(!0);try{if(!await v())throw new u("AUTHFAILED","Google auth is not configured");const f=await this.getGoogleIdToken(),m=await this.performGoogleLogin(f.credential);await L(m.jwt)}catch(l){const f=l instanceof Error?l.message:"Google auth failed",m=l instanceof u?l:new u("AUTHFAILED",f);this.eventBus.emit("authsigninfailed",m),w?.setError(m.message)}finally{_(!1)}}},onEmail:async l=>{if(!(h||k)){if(!l){w?.setError("Email is required");return}_(!0);try{y=(await this.signinWithEmail(l)).rid,w?.setState("code")}catch(f){const m=f instanceof Error?f.message:"Email auth failed",g=f instanceof u?f:new u("AUTHFAILED",m);this.eventBus.emit("authsigninfailed",g),w?.setError(g.message)}finally{_(!1)}}},onCode:async l=>{if(!(h||k)){if(!y){w?.setError("No pending auth request");return}if(!Number.isFinite(l)){w?.setError("Invalid code");return}_(!0);try{const f=await this.confirmCode(y,l);y=null,await L(f.jwt)}catch(f){const m=f instanceof Error?f.message:"Code confirmation failed",g=f instanceof u?f:new u("AUTHFAILED",m);this.eventBus.emit("authsigninfailed",g),w?.setError(g.message)}finally{_(!1)}}},onBack:()=>{w?.setState("login"),w?.setError("")},onClose:()=>{if(h)return;w?.close();const l=new u("AUTH_CANCELLED","Auth cancelled");this.eventBus.emit("authsigninfailed",l),this.eventBus.emit("authwindowclose",{ok:!1}),c(l)}}),w.show(),w.setGoogleEnabled(!0),v().catch(()=>{});return}const O=l=>{if(!C||C&&l.source!==C||!s&&l.origin!==r)return;const f=l.data,m=typeof f=="string"?(()=>{try{return JSON.parse(f)}catch{return null}})():f;if(m){if(m.action==="ready"&&s){v().then(g=>{b({state:"config",googleEnabled:!!g})}).catch(()=>{b({state:"config",googleEnabled:!1})});return}if(s&&m.action==="guest"){if(h||k)return;_(!0),this.loginAsGuest().then(g=>{b({jwt:g.jwt}),D(C,O),L(g.jwt).catch(c)}).catch(g=>{const A=g instanceof Error?g.message:"Auth failed",S=g instanceof u?g:new u("AUTHFAILED",A);b({error:{code:S.code,message:S.message}}),D(C,O),this.eventBus.emit("authsigninfailed",S),this.eventBus.emit("authwindowclose",{ok:!1}),c(S)}).finally(()=>{_(!1)});return}if(s&&m.action==="google"){if(h||k)return;_(!0),(async()=>{const g=await v();if(!g)throw new u("AUTHFAILED","Google auth is not configured");await R.loadScript();const A=await R.requestToken(g),S=await this.signinWithProvider("google",A.credential);b({jwt:S.jwt}),D(C,O),await L(S.jwt)})().catch(g=>{const A=g instanceof Error?g.message:"Google auth failed",S=g instanceof u?g:new u("AUTHFAILED",A);b({error:{code:S.code,message:S.message}}),this.eventBus.emit("authsigninfailed",S),this.eventBus.emit("authwindowclose",{ok:!1}),c(S)}).finally(()=>{_(!1)});return}if(s&&m.action==="email"){if(h||k)return;const g=typeof m.email=="string"?m.email:"";if(!g){b({error:{code:"INVALIDPAYLOAD",message:"Email is required"}});return}_(!0),(async()=>{y=(await this.signinWithEmail(g)).rid,b({state:"code"})})().catch(A=>{const S=A instanceof Error?A.message:"Email auth failed",x=A instanceof u?A:new u("AUTHFAILED",S);b({error:{code:x.code,message:x.message}}),this.eventBus.emit("authsigninfailed",x),this.eventBus.emit("authwindowclose",{ok:!1}),c(x)}).finally(()=>{_(!1)});return}if(s&&m.action==="code"){if(h||k)return;const g=m.code,A=typeof g=="number"?g:Number(g);if(!y){b({error:{code:"INVALIDPAYLOAD",message:"No pending auth request"}});return}if(!Number.isFinite(A)){b({error:{code:"INVALIDPAYLOAD",message:"Invalid code"}});return}_(!0),this.confirmCode(y,A).then(S=>{y=null,b({jwt:S.jwt}),D(C,O),L(S.jwt).catch(c)}).catch(S=>{const x=S instanceof Error?S.message:"Code confirmation failed",j=S instanceof u?S:new u("AUTHFAILED",x);b({error:{code:j.code,message:j.message}}),this.eventBus.emit("authsigninfailed",j),this.eventBus.emit("authwindowclose",{ok:!1}),c(j)}).finally(()=>{_(!1)});return}m?.jwt&&(h||(D(C,O),L(m.jwt).catch(c)))}},Te=window?.cordova?.InAppBrowser;if(Te?.open){const l=Te.open(i,"_blank","location=yes"),f=g=>{const A=g.data,S=typeof A=="string"?(()=>{try{return JSON.parse(A)}catch{return null}})():A;!S?.jwt||h||(l.removeEventListener("message",f),l.removeEventListener("exit",m),l.close(),L(S.jwt).catch(c))},m=()=>{if(h)return;l.removeEventListener("message",f),l.removeEventListener("exit",m);const g=new u("AUTH_CANCELLED","Auth cancelled");this.eventBus.emit("authsigninfailed",g),this.eventBus.emit("authwindowclose",{ok:!1}),c(g)};l.addEventListener("message",f),l.addEventListener("exit",m);return}if(window.addEventListener("message",O),C=window.open(i,"_blank",a),!C){D(void 0,O);const l=new u("AUTHFAILED","Unable to open auth window");this.eventBus.emit("authsigninfailed",l),this.eventBus.emit("authwindowclose",{ok:!1}),c(l);return}const Le=window.setInterval(()=>{if(h){window.clearInterval(Le);return}if(C.closed){window.clearInterval(Le),D(C,O);const l=new u("AUTH_CANCELLED","Auth cancelled");this.eventBus.emit("authsigninfailed",l),this.eventBus.emit("authwindowclose",{ok:!1}),c(l)}},300)})}async getAuthMe(){return this.auth.getMe()}async initConfigs(e){return this.initConfigsInternal(e)}async fetchConfigs(e){return this.fetchConfigsInternal(e)}persistAuthWindowContext(){if(typeof window>"u"||!window.localStorage)return;const e={authUrl:E.authUrl,app:this.systemParams.app,os:this.systemParams.os,version:this.systemParams.version,deviceId:this.systemParams.deviceId,dataContext:this.dataContext};try{window.localStorage.setItem(Fe,JSON.stringify(e))}catch(t){this.logger.warn("[SDK] unable to persist auth window context",t)}}async loginAsGuest(){try{const t=!this.getStoredDeviceId();console.log(t?"[SDK] loginAsGuest: no deviceId found, registering new guest...":"[SDK] loginAsGuest: deviceId found, logging in existing guest...");const s=await this.ensureDeviceId(),{d:i,u:r}=this.dataContext,o=H[this.systemParams.os||"web"]||3,a=this.systemParams.app||"default",d=this.getStoredToken();console.log("[SDK] loginAsGuest: calling /auth/init",{did:s,os:o,app:a,hasToken:!!d});const c=await this.auth.init({app:a,os:o,did:i.did||s,ln:this.getLanguage(),tk:d||void 0,idfa:i.idfa,idfv:i.idfv,gaid:i.gaid,geo:r.geo,region:r.region,locale:r.locale,ms:r.marketing?.ms,mc:r.marketing?.mc}),h=c?.jwt??null;if(!h)throw console.error("[SDK] loginAsGuest: ERROR missing jwt",c),new Error("Guest login failed: missing jwt token");return this.storeToken(h),this.systemParams.authToken=h,this.saveSdkMeta({jwt:h,uid:c.uid,gid:c.gid,anonymous:c.an,ts:Date.now()}),this.profileClient.setUserIdentity({uid:c.uid,gid:c.gid}),console.log(`[SDK] loginAsGuest: SUCCESS (${t?"registered":"logged in"})`,{uid:c.uid,gid:c.gid,anonymous:c.an}),c}catch(e){throw console.error("[SDK] loginAsGuest: ERROR",e),this.captureError(e),e}}async signinWithEmail(e){try{const t=H[this.systemParams.os||"web"]||3,s=this.systemParams.app||"default",i=await this.auth.signin({app:s,os:t,email:e,ln:this.getLanguage()});if("rid"in i)return{rid:i.rid};throw new Error("Unexpected response from signin")}catch(t){throw this.logger.error?.("[SDK] signinWithEmail failed",{authUrl:E.authUrl,error:t instanceof Error?t.message:t}),this.captureError(t),t}}async confirmCode(e,t){try{const s=await this.auth.confirmCode({rid:e,code:t}),i=s?.jwt??null;if(!i)throw new Error("Code confirmation failed: missing jwt token");return this.applyAuthContext({jwt:i,uid:s.uid,gid:s.gid,anonymous:s.an,ts:Date.now()}),s}catch(s){throw this.logger.error?.("[SDK] confirmCode failed",{authUrl:E.authUrl,error:s instanceof Error?s.message:s}),this.captureError(s),s}}async signinWithProvider(e,t){try{const s=H[this.systemParams.os||"web"]||3,i=this.systemParams.app||"default";let r;if(e==="google"?r=await this.performGoogleLogin(t):r=await this.auth.signin({app:i,os:s,ln:this.getLanguage(),et:t,pr:e}),"rid"in r)throw new Error("Unexpected response: got rid instead of auth response");const o=r?.jwt??null;if(!o)throw new Error("Provider signin failed: missing jwt token");return this.applyAuthContext({jwt:o,uid:r.uid,gid:r.gid,anonymous:r.an,ts:Date.now()}),r}catch(s){throw this.logger.error?.("[SDK] signinWithProvider failed",{authUrl:E.authUrl,provider:e,error:s instanceof Error?s.message:s}),this.captureError(s),s}}async loadOAuthConfig(){if(this.oauthConfig)return this.oauthConfig;try{return this.oauthConfig=await this.auth.getOAuthConfig(),this.oauthConfig}catch(e){return this.logger.warn?.("[SDK] loadOAuthConfig failed",e),null}}getGoogleClientId(){const e=this.oauthConfig;return e&&(e.google?.clientId||e.google?.client_id||e.googleClientId||e.google_client_id||e.clientId||e.client_id)||null}async getGoogleIdToken(e){await this.loadOAuthConfig();const t=this.getGoogleClientId();if(!t)throw new Error("Google Client ID not configured. Check OAuth config.");return await R.loadScript(),R.requestToken(t,e)}async loginWithGoogle(e){const t=await this.performGoogleLogin(e),s=t?.jwt??null;if(!s)throw new Error("Google login failed: missing jwt token");return this.applyAuthContext({jwt:s,uid:t.uid,gid:t.gid,anonymous:t.an,ts:Date.now()}),t}async performGoogleLogin(e){const t=await this.ensureDeviceId(),s=H[this.systemParams.os||"web"]||3,i=this.systemParams.app||"default",{d:r}=this.dataContext;return this.auth.googleSignIn(e,{app:i,os:s,did:r.did||t,ln:this.getLanguage()})}async logout(){try{try{await this.auth.logout()}catch{}this.clearToken(),this.clearSdkMeta(),this.systemParams.authToken=void 0,this.profileClient.setUserIdentity(null),this.profileClient.invalidateAll()}catch(e){throw this.captureError(e),e}}setCustomContext(e){this.dataContext.c={...this.dataContext.c,...e}}setSystemParams(e){if(this.systemParams={...this.systemParams,...e},"app"in e&&typeof e.app=="string"&&(this.dataContext.a.app=e.app),"os"in e&&typeof e.os=="string"&&(this.dataContext.a.os=e.os),"version"in e&&typeof e.version=="string"&&(this.dataContext.a.version=e.version),"region"in e&&typeof e.region=="string"&&(this.dataContext.u.region=e.region),"locale"in e&&typeof e.locale=="string"&&(this.dataContext.u.locale=e.locale),"geo"in e&&typeof e.geo=="string"&&(this.dataContext.u.geo=e.geo),"marketing"in e&&typeof e.marketing=="object"){const t=e.marketing;this.dataContext.u.marketing={ms:t.ms,mc:t.mc}}if("device"in e&&typeof e.device=="object"){const t=e.device;this.dataContext.d={idfa:t.idfa,idfv:t.idfv,gaid:t.gaid,did:t.did}}}on(e,t){this.eventBus.on(e,t)}once(e,t){this.eventBus.once(e,t)}off(e,t){this.eventBus.off(e,t)}detectEnvironment(){const e=typeof navigator<"u"?navigator.userAgent:"",t=typeof window<"u"&&typeof window.cordova<"u";this.systemParams.os=this.detectOS(e),this.systemParams.isCordova=t}detectOS(e){return/android/i.test(e)?"android":/iPad|iPhone|iPod/i.test(e)?"ios":/Win/i.test(e)?"windows":/Mac/i.test(e)?"macos":/Linux/i.test(e)?"linux":"web"}getLanguage(){const e=this.systemParams.locale;return e?e.split("-")[0]:typeof navigator<"u"&&navigator.language?navigator.language.split("-")[0]:"en"}async ensureDeviceId(){const e=this.getStoredDeviceId();if(e)return e;const t=await this.tryGetCordovaDeviceId();if(t)return this.storeDeviceId(t),t;const s=this.generateGuid();return this.storeDeviceId(s),s}getStoredDeviceId(){try{return this.storage.getItem("coreSDK_deviceId")}catch(e){return console.error("[SDK] getStoredDeviceId error:",e),null}}storeDeviceId(e){try{this.storage.setItem("coreSDK_deviceId",e)}catch(t){console.error("[SDK] storeDeviceId error:",t)}this.storeDeviceIdCookie(e)}getStoredToken(){try{return this.storage.getItem("coreSDK_token")}catch(e){return console.error("[SDK] getStoredToken error:",e),null}}storeToken(e){try{this.storage.setItem("coreSDK_token",e)}catch(t){console.error("[SDK] storeToken error:",t)}}clearToken(){try{this.storage.removeItem("coreSDK_token")}catch(e){console.error("[SDK] clearToken error:",e)}}async tryGetCordovaDeviceId(){if(typeof window>"u")return null;const t=window.device;return t?.uuid?String(t.uuid):null}hashString(e){let t=2166136261;for(let s=0;s<e.length;s+=1)t^=e.charCodeAt(s),t=t*16777619>>>0;return`w${t.toString(16)}`}getCookieValue(e){if(typeof document>"u")return null;try{const t=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),s=document.cookie.match(new RegExp(`(?:^|; )${t}=([^;]*)`));return s?decodeURIComponent(s[1]):null}catch{return null}}storeDeviceIdCookie(e){if(!(typeof document>"u"))try{document.cookie=`coreSDK_deviceId=${encodeURIComponent(e)}; Max-Age=63072000; Path=/; SameSite=Lax`}catch{}}generateGuid(){const e=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}async initConfigsInternal(e,t=!0){try{console.log("[SDK] initConfigs:",e);const s=await this.configsClient.init({v:e.version,scopes:e.scopes,keys:e.keys,values:this.buildConfigValues(e.values),segment:e.segment,ab:this.configState.ab,abG:this.configState.abG,abExp:this.configState.abExp});return this.configState={segment:s.segment,ab:s.ab,abG:s.abG,abExp:s.abExp,configs:s.configs||{}},this.saveConfigSnapshot(),t&&(this.eventBus.emit("configsfetched",this.configState.configs),this.eventBus.emit("configsupdated",this.configState.configs)),console.log("[SDK] initConfigs: SUCCESS",{segment:s.segment,ab:s.ab,abG:s.abG}),new ve(s,this.configState.configs)}catch(s){throw console.error("[SDK] initConfigs: ERROR",s),this.captureError(s),s}}async fetchConfigsInternal(e){try{console.log("[SDK] fetchConfigs:",e);const t=await this.configsClient.fetch({v:e.version,segment:this.configState.segment,scopes:e.scopes,keys:e.keys,values:this.buildConfigValues(e.values)});return t.configs&&(this.configState.configs={...this.configState.configs,...t.configs}),this.saveConfigSnapshot(),this.eventBus.emit("configsfetched",this.configState.configs),this.eventBus.emit("configsupdated",this.configState.configs),console.log("[SDK] fetchConfigs: SUCCESS",{scopes:Object.keys(t.configs||{})}),new ve(t,this.configState.configs)}catch(t){throw console.error("[SDK] fetchConfigs: ERROR",t),this.captureError(t),t}}}const Pe=M.getInstance();typeof window<"u"&&(window.coreSDK=Pe),I.SDKError=u,I.SDK_VERSION=ee,I.SUPPORTED_VERSIONS=te,I.coreSDK=Pe,I.validateVersion=ye,Object.defineProperty(I,Symbol.toStringTag,{value:"Module"})}));

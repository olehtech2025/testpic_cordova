<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <title>Find Objects â€“ Multi-level with Tutorial</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        :root{
            --safeT: max(10px, env(safe-area-inset-top));
            --safeR: max(10px, env(safe-area-inset-right));
            --safeB: max(10px, env(safe-area-inset-bottom));
            --safeL: max(10px, env(safe-area-inset-left));
            --uiGap: 10px;
        }

        html, body { width:100%; height:100%; }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #1f1f2a;
            color: #fff;
            min-height: 100dvh;
            overflow: hidden;
        }

        /* Dim active screen when auth overlay is visible */
        body.login-active .screen.active{
            opacity: 0.4;
            transform: translateZ(0);
            pointer-events: none;
        }

        .screen {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            min-height: 100dvh;
            display: none;
            overflow: hidden;
        }
        .screen.active { display: block; }

        /* ---------- SPLASH SCREEN ---------- */
        #splashScreen { min-height: 100dvh; }

        .splash-wrapper {
            width: 100%;
            height: 100%;
            min-height: 100dvh;
            padding: var(--safeT) var(--safeR) var(--safeB) var(--safeL);
            background: linear-gradient(180deg, #1a1543 0%, #0a0820 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .splash-logo-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .splash-logo-icon {
            width: 120px;
            height: 120px;
        }

        .splash-title {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 38px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.02em;
            line-height: 1.1;
        }

        .splash-subtitle {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 16px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.55);
            letter-spacing: 0.04em;
        }

        .splash-progress-wrapper {
            width: min(320px, 80%);
            margin-bottom: 60px;
        }

        .splash-progress-track {
            width: 100%;
            height: 36px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
            position: relative;
        }

        .splash-progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            border-radius: 18px;
            background: linear-gradient(90deg, #FFD966, #FFC629);
            animation: splash-fill 1.4s ease-out forwards;
        }

        .splash-progress-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.85);
            z-index: 1;
        }

        @keyframes splash-fill {
            0% { width: 0%; }
            100% { width: 65%; }
        }

        /* ---------- MAIN MENU / LEVEL SCREEN ---------- */
        .menu-wrapper {
            width: 100%;
            height: 100%;
            min-height: 100dvh;
            padding: var(--safeT) var(--safeR) var(--safeB) var(--safeL);
            background: linear-gradient(180deg, #1a1543 0%, #0a0820 100%);
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .menu-profile-btn {
            border: none;
            background: none;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0;
            cursor: pointer;
        }

        .menu-login-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.12);
            display: grid;
            place-items: center;
        }

        .menu-header-title {
            font-size: 18px;
            font-weight: 700;
            opacity: 0.9;
        }

        .menu-settings-btn {
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }
        .menu-settings-btn:active { transform: scale(0.95); }

        .menu-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            gap: 16px;
            padding: 10px 0;
            min-height: 0;
        }

        /* Compact logo row: icon + text */
        .menu-logo-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .menu-logo-icon-small {
            width: 48px;
            height: 48px;
        }

        .menu-logo-text-row {
            display: flex;
            flex-direction: column;
        }

        .menu-logo-title-main {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 700;
            font-size: 24px;
            color: #fff;
            line-height: 1.1;
        }

        .menu-logo-subtitle {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 400;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.55);
        }

        /* Level circle badge */
        .menu-level-badge {
            display: flex;
            justify-content: center;
        }

        .level-circle {
            width: min(180px, 32vw);
            height: min(180px, 32vw);
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(138, 43, 226, 0.35), rgba(75, 0, 130, 0.5));
            border: 3px solid rgba(138, 43, 226, 0.4);
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .level-number {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 700;
            font-size: 48px;
            color: #fff;
            line-height: 1;
        }

        .level-text {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 400;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Score display */
        .menu-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .menu-score-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-star {
            font-size: 28px;
        }

        .score-value {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 700;
            font-size: 36px;
            color: #FFD966;
        }

        .score-label {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 500;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.55);
        }

        /* Play button */
        .menu-play-button {
            width: min(300px, 80%);
            height: 56px;
            border: none;
            border-radius: 28px;
            background: linear-gradient(135deg, #FFD966 0%, #FFC629 100%);
            color: #1a1543;
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 700;
            font-size: 20px;
            letter-spacing: 0.05em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 201, 41, 0.35);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .menu-play-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(255, 201, 41, 0.35);
        }

        /* Ad banner */
        .menu-ad-banner {
            width: 100%;
            height: 70px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ad-placeholder {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 500;
            font-size: 14px;
            color: #999;
        }

        /* Hidden elements kept for JS compatibility */
        .menu-compat-hidden {
            display: none !important;
        }

        /* Legacy classes kept for score/other screens */
        .menu-level-info {
            padding: 14px;
            border-radius: 18px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-level-label {
            font-size: 14px;
            font-weight: 700;
            opacity: 0.95;
        }

        .menu-level-title {
            font-size: 18px;
            font-weight: 800;
        }

        .menu-level-desc {
            font-size: 13px;
            opacity: 0.9;
        }

        .play-btn-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .play-btn {
            padding: 14px 42px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            color: #1a1543;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(255, 201, 41, 0.3);
            background: linear-gradient(135deg, #FFD966, #FFC629);
        }

        .play-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(255, 201, 41, 0.3);
        }

        .play-btn.secondary {
            padding: 10px 26px;
            font-size: 14px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.8);
            box-shadow: none;
        }

        /* ---------- GAME / TUTORIAL WRAPPER ---------- */
        img { -webkit-user-drag: none; user-select: none; }

        .game-wrapper {
            width: 100%;
            height: 100%;
            min-height: 100dvh;
            padding: var(--safeT) var(--safeR) var(--safeB) var(--safeL);
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: var(--uiGap);
            min-height: 0;
        }

        .tutorial-wrapper{
            grid-template-rows: auto 1fr auto auto;
        }

        .hud {
            position: relative;
            border-radius: 18px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
            background: linear-gradient(180deg, #c97b30, #9a4b1e);
            box-shadow: 0 4px 10px rgba(0,0,0,0.45);
        }

        .hud::before {
            content: "";
            position: absolute;
            inset: 3px;
            border-radius: 14px;
            z-index: -1;
            background:
                    radial-gradient(circle at 0% 0%, rgba(255,255,255,0.36), transparent 55%),
                    linear-gradient(180deg, #f8d89e, #f0b35a);
        }

        .hud > * { position: relative; z-index: 1; }

        .hud-title-row {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .hud-title-row span.title-text {
            font-weight: 700;
            font-size: 16px;
        }

        .hud-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            font-size: 13px;
        }

        .hud-progress { opacity: 0.9; }
        .hud-score { text-align: center; font-weight: 700; }
        .hud-lives { text-align: right; }

        .hud-lives .hearts {
            font-size: 18px;
            color: #ff4a4a;
            text-shadow: 0 0 4px rgba(0,0,0,0.4);
        }

        .game {
            position: relative;
            height: 100%;
            min-height: 0;
            width: auto;
            max-width: 100%;
            max-height: 100%;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background: #000;
            margin: 0 auto;
        }

        .game-bg {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .game-top-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 20;
        }

        .menu-button,
        .hint-button {
            position: relative;
            border: none;
            background: rgba(0,0,0,0.55);
            color: #fff;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            box-shadow: 0 0 6px rgba(0,0,0,0.6);
        }

        .menu-button:active,
        .hint-button:active { transform: scale(0.95); }

        .hint-button { font-size: 0; }
        .hint-button::before {
            content: "ðŸ’¡";
            font-size: 18px;
            line-height: 1;
            display: block;
        }
        .hint-button::after {
            content: attr(data-hints);
            position: absolute;
            right: 5px;
            bottom: 4px;
            font-size: 11px;
        }
        .hint-button:disabled { opacity: 0.4; cursor: default; }

        /* Tutorial skip button (top-left of tutorial game field) */
        .tutorial-skip-btn{
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 25;
            border: none;
            background: rgba(0,0,0,0.55);
            color: #fff;
            height: 38px;
            padding: 0 14px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 800;
            letter-spacing: 0.02em;
            box-shadow: 0 0 6px rgba(0,0,0,0.6);
        }
        .tutorial-skip-btn:active{ transform: scale(0.97); }

        .item,
        .t-item {
            position: absolute;
            cursor: default;
            user-select: none;
            transition: transform 0.15s ease, opacity 0.15s ease, box-shadow 0.15s ease;
            z-index: 5;
            will-change: transform, opacity;
        }

        .item:active,
        .t-item:active { transform: scale(0.9); }

        @keyframes hint-wiggle {
            0%   { transform: translate(0, 0) scale(1); }
            20%  { transform: translate(-1px, 0) scale(1.02); }
            40%  { transform: translate(1px, 0) scale(1.02); }
            60%  { transform: translate(-1px, 0) scale(1.02); }
            80%  { transform: translate(1px, 0) scale(1.02); }
            100% { transform: translate(0, 0) scale(1); }
        }

        .item.hint-highlight,
        .t-item.hint-highlight {
            box-shadow: 0 0 12px 3px rgba(255, 240, 170, 0.9);
            border-radius: 8px;
            animation: hint-wiggle 0.6s ease-in-out 2;
        }

        .t-item.tutorial-focus {
            z-index: 50;
            box-shadow: 0 0 16px 4px rgba(255, 255, 200, 0.95);
            transform: scale(1.05);
        }

        .miss-marker {
            position: absolute;
            width: 32px;
            height: 32px;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.7);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .miss-marker::before,
        .miss-marker::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 3px;
            background: rgba(255,80,80,0.95);
            box-shadow: 0 0 6px rgba(255,0,0,0.8);
            transform-origin: center;
        }

        .miss-marker::before { transform: translate(-50%, -50%) rotate(45deg); }
        .miss-marker::after  { transform: translate(-50%, -50%) rotate(-45deg); }

        .miss-marker.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 16px;
            z-index: 40;
            opacity: 0;
            transition: opacity 0.25s ease;
            will-change: opacity;
        }

        .overlay.visible {
            display: flex;
            opacity: 1;
        }

        .overlay.win {
            position: fixed;
            inset: 0;
            background:
                    radial-gradient(60% 60% at 80% 0%, rgba(255,255,255,0.08), transparent 60%),
                    radial-gradient(70% 60% at 12% 10%, rgba(160,120,255,0.2), transparent 60%),
                    linear-gradient(180deg, #1a1543 0%, #0b0820 100%);
            align-items: stretch;
            justify-content: flex-start;
            text-align: left;
            padding: var(--safeT) var(--safeR) var(--safeB) var(--safeL);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .overlay.win .overlay-card { display: none; }

        .overlay.lose .overlay-card { display: flex; }

        .overlay.lose .overlay-win { display: none; }

        .overlay-card {
            background: linear-gradient(180deg, #2a1f5e 0%, #1a1243 100%);
            border-radius: 24px;
            padding: 28px 24px 24px;
            width: min(320px, 88%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        @keyframes overlay-pop {
            0%   { transform: scale(0.85); opacity: 0; }
            60%  { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes overlay-drop {
            0%   { transform: translateY(-20px); opacity: 0; }
            60%  { transform: translateY(2px);  opacity: 1; }
            100% { transform: translateY(0);    opacity: 1; }
        }

        .overlay.win .overlay-card { animation: overlay-pop 0.45s ease-out forwards; }
        .overlay.lose .overlay-card { animation: overlay-drop 0.4s ease-out forwards; }

        .overlay-title {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: #fff;
        }

        .overlay-icon {
            margin: 8px 0;
        }

        .overlay-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .overlay-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin-top: 8px;
        }

        .overlay-btn-primary {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px 20px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(180deg, #FFE066 0%, #FFD43B 100%);
            color: #1a1243;
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 212, 59, 0.3);
        }

        .overlay-btn-primary:active { transform: scale(0.97); }

        .overlay-btn-secondary {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px 20px;
            border-radius: 16px;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .overlay-btn-secondary:active { transform: scale(0.97); }

        .overlay-win {
            width: 100%;
            max-width: min(420px, 92vw);
            margin: 0 auto;
            display: none;
            flex-direction: column;
            gap: 14px;
            padding: 16px 18px 24px;
            min-height: 100%;
            align-items: center;
        }

        .overlay.win .overlay-win {
            display: flex;
            animation: overlay-pop 0.35s ease-out both;
        }

        .win-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 4px 0 2px;
            align-self: stretch;
        }

        .win-player {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Rubik', system-ui, sans-serif;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .win-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd27f, #ff8e4c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: #3b2312;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.25);
            background-size: cover;
            background-position: center;
        }

        .win-settings-btn {
            border: none;
            background: rgba(255,255,255,0.12);
            color: #fff;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            cursor: pointer;
        }

        .win-title {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: clamp(22px, 6vw, 28px);
            font-weight: 800;
            color: #e7c9ff;
            letter-spacing: 0.01em;
            text-align: left;
            width: 100%;
            align-self: stretch;
        }

        .win-image {
            width: min(260px, 74vw);
            aspect-ratio: 1 / 1;
            border-radius: 24px;
            background: #22164d;
            background-size: cover;
            background-position: center;
            align-self: center;
            box-shadow: 0 18px 40px rgba(7,4,18,0.55);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .win-actions-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 0 auto;
        }

        .win-action-btn {
            border: none;
            border-radius: 999px;
            padding: 11px 12px;
            background: rgba(70, 48, 145, 0.6);
            color: #fff;
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        .win-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            margin-top: 20px;
            margin-bottom: 20px;
            color: #fff;
            font-family: 'Rubik', system-ui, sans-serif;
        }

        .win-score-main {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 28px;
            font-weight: 800;
        }

        .win-score-sub {
            font-size: 11px;
            color: rgba(255,255,255,0.55);
            letter-spacing: 0.18em;
            text-transform: uppercase;
        }

        .win-next-btn {
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 14px 18px;
            background: linear-gradient(180deg, #fff1a0 0%, #ffd33f 100%);
            color: #2c1a0b;
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 15px;
            font-weight: 800;
            letter-spacing: 0.04em;
            cursor: pointer;
            box-shadow: 0 10px 22px rgba(255, 211, 63, 0.35);
            margin: 0 auto;
        }

        /* In Cordova the banner is a native view â€” hide HTML placeholders */
        body.is-cordova .win-ad,
        body.is-cordova .menu-ad-banner,
        body.is-cordova .game-ad-banner {
            display: none !important;
        }

        .win-ad {
            width: 100%;
            min-height: 52px;
            border-radius: 12px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: rgba(0,0,0,0.25);
            margin-top: 4px;
            align-self: center;
        }

        /* Desktop: reduce win-score vertical margins so Next Level + Ad are grouped tightly */
        @media (min-width: 481px) {
            .win-score {
                margin-top: 8px;
                margin-bottom: 8px;
            }
        }

        @media (max-width: 480px) {
            .overlay-win {
                --win-media-w: 264px;
                --win-media-h: 362px;
                --win-actions-w: 264px;
                --win-next-w: 300px;
                --win-next-h: 68px;
                --win-ad-w: 320px;
                --win-ad-h: 50px;
                gap: 16px;
                padding: 50px 18px 22px;
                max-width: 380px;
            }

            .win-image {
                width: var(--win-media-w);
                height: var(--win-media-h);
                aspect-ratio: auto;
                border-radius: 26px;
            }

            .win-actions-row {
                width: var(--win-actions-w);
                gap: 12px;
            }

            .win-action-btn {
                padding: 12px 12px;
                font-size: 13px;
            }

            .win-score-main {
                font-size: 30px;
            }

            .win-score-sub {
                font-size: 12px;
                letter-spacing: 0.16em;
            }

            .win-next-btn {
                width: var(--win-next-w);
                height: var(--win-next-h);
                padding: 0 18px;
                font-size: 16px;
                align-self: center;
            }

            .win-ad {
                width: var(--win-ad-w);
                min-height: var(--win-ad-h);
            }
        }

        .btn {
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: #ffb347;
            color: #40210f;
            box-shadow: 0 2px 0 rgba(0,0,0,0.25);
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.35);
        }

        .carousel {
            position: relative;
            padding: 6px 8px;
            border-radius: 18px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            height: clamp(90px, 16vh, 140px);
            align-items: center;
            background: linear-gradient(180deg, #c97b30, #8b421d);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.55);
            min-height: 0;
        }

        .carousel::before {
            content: "";
            position: absolute;
            inset: 3px;
            border-radius: 14px;
            z-index: -1;
            background:
                    radial-gradient(circle at 15% 0%, rgba(255,255,255,0.18), transparent 55%),
                    linear-gradient(180deg, #f4c77d, #e49b47);
        }

        .carousel::-webkit-scrollbar { height: 5px; }
        .carousel::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.35);
            border-radius: 3px;
        }

        .carousel-item {
            flex: 0 0 auto;
            text-align: center;
            font-size: 11px;
            opacity: 0.95;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            padding: 4px 10px 6px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.02));
            box-shadow: 0 1px 2px rgba(0,0,0,0.35);
        }

        .carousel-icon {
            width: 44px;
            height: 44px;
            object-fit: contain;
            display: block;
            margin-bottom: 2px;
        }

        .carousel-label { white-space: nowrap; }

        .carousel-item.found {
            opacity: 0.35;
            filter: grayscale(0.9);
            text-decoration: line-through;
        }

        .tutorial-text {
            margin-top: 0;
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.35;
            max-height: min(18vh, 140px);
            overflow: auto;
            padding-right: 4px;
        }
        .tutorial-text p + p { margin-top: 2px; }

        .tutorial-guide-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.55);
            display: none;
            justify-content: center;
            align-items: flex-end;
            padding: 16px;
            z-index: 30;
            pointer-events: none;
        }

        .tutorial-guide-overlay.visible { display: flex; }

        .tutorial-guide-box {
            background: rgba(0,0,0,0.9);
            border-radius: 14px;
            padding: 10px 14px;
            font-size: 13px;
            text-align: center;
            max-width: 260px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.18);
        }

        .tutorial-guide-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 14px;
        }

        /* SETTINGS OVERLAY */
        /* =========================
     SETTINGS â€” full-screen page
     ========================= */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background:
                    radial-gradient(60% 60% at 85% 0%, rgba(255,255,255,0.08), transparent 60%),
                    radial-gradient(70% 60% at 10% 10%, rgba(160,120,255,0.18), transparent 60%),
                    linear-gradient(180deg, #1a1543 0%, #0d0a1f 100%);
            display: none;
            flex-direction: column;
            z-index: 100;
            overflow: hidden;
            isolation: isolate;
            --settings-accent: #b06bff;
            --settings-accent-strong: #8a5cff;
            --settings-card: rgba(36, 26, 74, 0.88);
            --settings-card-border: rgba(255,255,255,0.08);
            --settings-row-divider: rgba(255,255,255,0.08);
            --settings-text: #f5f2ff;
            --settings-muted: rgba(255,255,255,0.6);
            --settings-shadow: 0 18px 40px rgba(7,4,18,0.55);
        }

        .settings-overlay::before {
            content: "";
            position: absolute;
            inset: 0;
            background:
                    radial-gradient(50% 40% at 80% 10%, rgba(255,255,255,0.06), transparent 60%),
                    radial-gradient(60% 50% at 15% 25%, rgba(140,95,255,0.16), transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .settings-overlay.visible { display: flex; }

        .settings-panel {
            position: relative;
            z-index: 1;
            background: none;
            width: 100%;
            height: 100%;
            max-width: 402px;
            margin: 0 auto;
            padding: calc(var(--safeT, 16px) + 8px) 16px calc(var(--safeB, 16px) + 16px);
            display: flex;
            flex-direction: column;
            gap: 14px;
            font-size: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .settings-overlay.visible .settings-panel {
            animation: settings-panel-in 240ms ease-out both;
        }

        @media (max-width: 480px) {
            .settings-panel {
                max-width: 402px;
                padding: calc(var(--safeT, 16px) + 8px) 16px calc(var(--safeB, 16px) + 16px);
            }

            .settings-content {
                align-items: center;
            }

            .settings-header {
                height: 40px;
                padding: 0;
            }

            .settings-section {
                width: min(370px, 92vw);
            }
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            height: 40px;
            padding: 0;
        }

        .settings-title {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 700;
            font-size: 18px;
            color: var(--settings-text);
            letter-spacing: 0.02em;
        }

        .settings-close {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.12);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
        }

        .settings-close:active { transform: translateY(-50%) scale(0.93); }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 14px;
            align-items: center;
        }

        .settings-overlay.visible .settings-content .settings-section {
            animation: settings-section-in 320ms ease-out both;
        }

        .settings-overlay.visible .settings-content .settings-section:nth-child(1) { animation-delay: 40ms; }
        .settings-overlay.visible .settings-content .settings-section:nth-child(2) { animation-delay: 80ms; }
        .settings-overlay.visible .settings-content .settings-section:nth-child(3) { animation-delay: 120ms; }
        .settings-overlay.visible .settings-content .settings-section:nth-child(4) { animation-delay: 160ms; }
        .settings-overlay.visible .settings-content .settings-section:nth-child(5) { animation-delay: 200ms; }

        .settings-section {
            width: min(370px, 92vw);
            border-radius: 22px;
            padding: 10px;
            background: rgba(38, 29, 76, 0.9);
            border: 1px solid var(--settings-card-border);
            box-shadow: var(--settings-shadow);
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* Keep General/Account hidden in Settings screen */
        #settingsSectionGeneral,
        #settingsSectionAccount {
            display: none;
        }

        .settings-section-title {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.24em;
            text-transform: uppercase;
            color: var(--settings-muted);
            padding: 6px 10px 4px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
        }

        .settings-section .settings-row + .settings-row {
            border-top: 1px solid var(--settings-row-divider);
        }

        .settings-row-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-row-icon {
            flex-shrink: 0;
            color: var(--settings-accent);
        }

        .settings-row-icon path,
        .settings-row-icon rect,
        .settings-row-icon circle,
        .settings-row-icon line,
        .settings-row-icon polyline {
            stroke: currentColor;
        }

        .settings-label {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--settings-text);
        }

        .settings-pill {
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.12);
            color: var(--settings-text);
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Rubik', system-ui, sans-serif;
        }

        .settings-pill:disabled {
            opacity: 0.6;
            cursor: default;
        }

        /* iOS-style toggle switch */
        .switch {
            position: relative;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            inset: 0;
            border-radius: 999px;
            background: rgba(255,255,255,0.12);
            cursor: pointer;
            transition: background 0.25s;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
        }

        .switch-slider::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            left: 3px;
            top: 3px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.25s;
        }

        .switch input:checked + .switch-slider {
            background: linear-gradient(135deg, var(--settings-accent), var(--settings-accent-strong));
        }

        .switch input:checked + .switch-slider::before {
            transform: translateX(22px);
        }

        /* Settings links */
        .settings-links {
            display: flex;
            flex-direction: column;
        }

        .settings-link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 12px;
            cursor: pointer;
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: var(--settings-text);
        }

        .settings-links .settings-link-item + .settings-link-item {
            border-top: 1px solid var(--settings-row-divider);
        }

        .settings-link-item:active {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }

        .settings-link-label {
            color: var(--settings-text);
        }

        .settings-chevron {
            flex-shrink: 0;
            opacity: 0.6;
        }

        /* ---------- AUTH SECTION ---------- */
        .settings-auth {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 4px 6px 8px;
        }

        .settings-status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
        }

        .settings-status-label {
            font-size: 11px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--settings-muted);
        }

        .settings-status {
            font-size: 13px;
            color: var(--settings-muted);
            font-weight: 600;
            text-align: right;
        }

        .settings-status.logged-in {
            color: #7dffb0;
        }

        .settings-auth-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .settings-btn-auth,
        .settings-auth-btn {
            padding: 10px 14px;
            font-size: 13px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 8px 16px rgba(5,3,14,0.35);
        }

        .settings-btn-auth:active,
        .settings-auth-btn:active {
            transform: scale(0.98);
        }

        .settings-btn-auth:disabled,
        .settings-auth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #loginGuestButton {
            background: rgba(255,255,255,0.14);
            color: var(--settings-text);
            border: 1px solid rgba(255,255,255,0.12);
        }

        #loginGoogleButton {
            background: #fff;
            color: #2e1b4f;
        }

        #logoutButton {
            background: linear-gradient(180deg, #ff6b6b, #ff3f6f);
            color: #fff;
        }

        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 8px 6px 12px;
        }

        .settings-action-btn {
            width: 100%;
            border: none;
            border-radius: 18px;
            padding: 14px 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 22px rgba(7,4,18,0.4);
        }

        .settings-action-btn.primary {
            background: linear-gradient(180deg, #ffd07a, #ff9b3c);
            color: #3a1e0e;
        }

        .settings-action-btn.danger {
            background: linear-gradient(180deg, #ff7a7a, #ff4e6e);
            color: #fff;
        }

        .settings-account-card {
            padding: 18px 16px;
            gap: 12px;
        }

        .settings-account-guest,
        .settings-account-logged {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            text-align: center;
        }

        .settings-account-logged {
            align-items: stretch;
            text-align: left;
            gap: 10px;
        }

        .settings-account-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background:
                    radial-gradient(circle at 30% 20%, rgba(255,255,255,0.25), transparent 60%),
                    linear-gradient(160deg, #3a2a79, #241757);
            display: grid;
            place-items: center;
            box-shadow: 0 10px 24px rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .settings-account-title {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--settings-text);
        }

        .settings-account-status {
            font-size: 12px;
            color: var(--settings-muted);
            margin-top: -6px;
        }

        .settings-account-status.logged-in {
            color: #7dffb0;
        }

        .settings-account-btn {
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 12px 14px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .settings-account-btn.google {
            background: #ffffff;
            color: #1f133b;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .settings-account-btn.guest {
            background: rgba(255,255,255,0.14);
            color: #f5f0ff;
            border: 1px solid rgba(255,255,255,0.12);
        }

        .settings-account-btn.logout {
            background: linear-gradient(180deg, #ff6b6b, #ff3f6f);
            color: #fff;
        }

        @keyframes settings-panel-in {
            0% { opacity: 0; transform: translateY(8px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes settings-section-in {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* ---------- PLAYER AVATAR & NAME ---------- */
        .player-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .player-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd27f, #ff8e4c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: #3b2312;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.25);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .player-name { font-size: 13px; font-weight: 600; }

        .game-player {
            position: absolute;
            top: 10px;
            left: 12px;
            z-index: 25;
        }

        /* ---------- LOGIN MODAL ---------- */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .login-overlay.visible { display: flex; }

        .login-dialog {
            background: linear-gradient(180deg, #2b1c5f 0%, #1a123f 100%);
            border-radius: 24px;
            padding: 22px 20px 20px;
            width: min(86vw, 320px);
            box-shadow: 0 18px 40px rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            text-align: center;
        }

        .login-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.25), transparent 60%),
            linear-gradient(160deg, #3a2a79, #241757);
            display: grid;
            place-items: center;
            box-shadow: 0 10px 24px rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .login-title {
            font-size: 20px;
            font-weight: 700;
            margin-top: 2px;
        }
        .login-subtitle {
            font-size: 12px;
            opacity: 0.75;
            margin-top: -6px;
        }

        .login-avatar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .login-avatar-large {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd27f, #ff8e4c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 20px;
            color: #3b2312;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.35);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: pointer;
        }

        .login-player-name { font-size: 14px; font-weight: 600; }

        .login-field {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 12px;
        }

        .login-field label { opacity: 0.9; }

        .login-field input {
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15);
            padding: 6px 8px;
            background: rgba(0,0,0,0.35);
            color: #fff;
            font-size: 13px;
            outline: none;
        }

        .login-field input:focus { border-color: #ffb347; }

        .login-btn { margin-top: 2px; width: 100%; }

        .login-google-btn,
        .login-guest-btn {
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 12px 14px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-google-btn {
            background: #ffffff;
            color: #1f133b;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .login-guest-btn {
            background: rgba(255,255,255,0.14);
            color: #f5f0ff;
            border: 1px solid rgba(255,255,255,0.12);
        }

        .login-legacy { display: none; }

        .login-error {
            margin-top: 2px;
            font-size: 11px;
            color: #ff8a8a;
            min-height: 14px;
            text-align: center;
        }

        .login-switch {
            margin-top: 4px;
            background: none;
            border: none;
            color: #ffb347;
            font-size: 12px;
            text-align: left;
            cursor: pointer;
            align-self: flex-start;
            padding: 0;
        }

        /* ---------- PROFILE MODAL ---------- */
        .profile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 210;
        }

        .profile-overlay.visible { display: flex; }

        .profile-dialog {
            width: min(86vw, 320px);
            background: linear-gradient(180deg, #2b1c5f 0%, #1a123f 100%);
            border-radius: 26px;
            padding: 20px 18px 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.7);
        }

        .profile-avatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd27f, #ff8e4c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 36px;
            color: #3b2312;
            box-shadow: 0 10px 24px rgba(0,0,0,0.45);
            background-size: cover;
            background-position: center;
        }

        .profile-name {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .profile-btn {
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
        }

        .profile-edit-btn {
            background: rgba(255,255,255,0.14);
            color: #f5f0ff;
            border: 1px solid rgba(255,255,255,0.12);
        }

        .profile-logout-btn {
            background: rgba(255,255,255,0.1);
            color: #f5f0ff;
        }

        .profile-score {
            text-align: center;
            margin-top: 4px;
        }

        .profile-score-value {
            font-size: 14px;
            font-weight: 800;
            color: #ffd966;
        }

        .profile-score-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
        }

        /* ---------- SCORE SCREEN ---------- */
        .score-wrapper .menu-logo { margin-top: 20px; }
        .score-wrapper .menu-level-info { margin-top: 12px; }

        .scoreboard-players {
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .scoreboard-player-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            border-radius: 12px;
            background: rgba(0,0,0,0.25);
            font-size: 12px;
        }

        /* ---- Press feedback for buttons ---- */
        button, .btn, .play-btn, .menu-settings-btn, .menu-button, .hint-button,
        .tutorial-skip-btn, .settings-toggle, .menu-section-btn, .login-switch {
            position: relative;
            transition: transform 120ms ease, filter 120ms ease, box-shadow 120ms ease;
            will-change: transform, filter;
        }

        button::after, .btn::after, .play-btn::after, .menu-settings-btn::after,
        .menu-button::after, .hint-button::after, .tutorial-skip-btn::after,
        .settings-toggle::after, .menu-section-btn::after, .login-switch::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: rgba(255,255,255,0.18);
            opacity: 0;
            transition: opacity 120ms ease;
            pointer-events: none;
        }

        button:active::after, .btn:active::after, .play-btn:active::after,
        .menu-settings-btn:active::after, .menu-button:active::after, .hint-button:active::after,
        .tutorial-skip-btn:active::after, .settings-toggle:active::after, .menu-section-btn:active::after,
        .login-switch:active::after {
            opacity: 1;
        }

        .is-pressed::after { opacity: 1; }
        .is-pressed { transform: translateY(1px) scale(0.98); filter: brightness(1.08) saturate(1.05); }

        .scoreboard-score { font-weight: 700; }

        /* FIX: restore hint counter (press-feedback overwrote .hint-button::after) */
        .hint-button::after{
            content: attr(data-hints);
            position: absolute;
            right: 5px;
            bottom: 4px;
            top: auto;
            left: auto;

            width: auto;
            height: auto;

            background: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;

            opacity: 0.95;
            font-size: 11px;
            font-weight: 800;
            transition: none;
            pointer-events: none;
        }

        /* =========================
     GAME SCREEN â€” new design
     ========================= */

        #gameScreen .game-wrapper {
            background: linear-gradient(180deg, #1a1543 0%, #0a0820 100%);
            grid-template-rows: auto 1fr auto auto auto auto;
            gap: 0;
            padding: var(--safeT) 0 var(--safeB) 0;
        }

        /* Minimal game HUD */
        #gameScreen .game-hud {
            background: none;
            box-shadow: none;
            border-radius: 0;
            padding: 8px 16px;
            overflow: visible;
        }

        #gameScreen .game-hud::before {
            display: none;
        }

        #gameScreen .game-hud .hud-topbar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 10px;
        }

        #gameScreen .game-hud .hud-left-stack {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 4px;
        }

        #gameScreen .game-hud .hud-left-stack .hearts {
            font-size: 18px;
            color: #ff4a4a;
            letter-spacing: -2px;
        }

        #gameScreen .game-hud .hud-left-stack .lives-count {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-left: 2px;
        }

        #gameScreen .game-hud .hud-center-stack {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        #gameScreen .game-hud .hud-star {
            font-size: 20px;
        }

        #gameScreen .game-hud .hud-center-stack .hud-score-val {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: #FFD966;
        }

        #gameScreen .game-hud .hud-right-stack {
            display: flex;
            justify-content: flex-end;
        }

        #gameScreen .game-hud .hud-settings-btn {
            border: none;
            background: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            opacity: 0.7;
        }

        /* Game area â€” full width, contained in 1fr grid row */
        #gameScreen .game {
            border-radius: 0;
            box-shadow: none;
            background: #0a0820;
            width: 100%;
            max-width: 100%;
            height: 100%;
            min-height: 0;
        }

        #gameScreen .game .game-bg {
            object-fit: contain;
            width: 100%;
            height: 100%;
        }

        /* Hide old buttons on game image */
        #gameScreen .game-top-buttons {
            display: none;
        }

        /* Hint button â€” centered, overlapping bottom of game image */
        #gameScreen .game-hint-area {
            display: flex;
            justify-content: center;
            margin-top: -28px;
            position: relative;
            z-index: 10;
            padding: 0 0 6px;
        }

        .hint-btn-new {
            position: relative;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 3px solid rgba(26, 21, 67, 0.6);
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            color: #fff;
        }

        .hint-btn-new:active {
            transform: scale(0.93);
        }

        .hint-btn-new:disabled {
            opacity: 0.4;
            cursor: default;
        }

        /* =========================
     TUTORIAL SCREEN â€” unified design
     ========================= */
        #tutorialScreen .game-wrapper {
            background: none;
            gap: 8px;
            padding: var(--safeT) 0 var(--safeB) 0;
        }

        #tutorialScreen {
            background: linear-gradient(180deg, #1a1543 0%, #0a0820 100%);
        }

        #tutorialScreen .hud {
            background: none;
            box-shadow: none;
            border-radius: 0;
            padding: 8px 16px;
            color: #fff;
        }

        #tutorialScreen .hud::before { display: none; }

        #tutorialScreen .hud-title-row span.title-text {
            font-family: 'Rubik', system-ui, sans-serif;
            font-weight: 700;
            color: #e7c9ff;
        }

        #tutorialScreen .hud-header {
            color: rgba(255,255,255,0.75);
        }

        #tutorialScreen .hud-score {
            color: #FFD966;
        }

        #tutorialScreen .hud-lives .hearts {
            color: #ff6b6b;
        }

        #tutorialScreen .game {
            background: #0a0820;
            border-radius: 14px;
            margin: 0 auto;
            width: min(480px, 92vw);
            box-shadow: 0 10px 30px rgba(0,0,0,0.45);
        }

        #tutorialScreen .game .game-bg {
            object-fit: contain;
        }

        #tutorialScreen .tutorial-skip-btn{
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 6px 14px rgba(0,0,0,0.35);
            color: #fff;
        }

        #tutorialScreen .carousel {
            background: linear-gradient(180deg, rgba(78,52,160,0.9), rgba(48,30,120,0.9));
            box-shadow: 0 -4px 12px rgba(0,0,0,0.5);
        }

        #tutorialScreen .carousel::before {
            background:
                    radial-gradient(circle at 15% 0%, rgba(255,255,255,0.18), transparent 55%),
                    linear-gradient(180deg, rgba(120,94,220,0.9), rgba(74,49,160,0.9));
        }

        #tutorialScreen .carousel-item {
            background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.03));
        }

        #tutorialScreen .tutorial-text {
            margin: 0 12px 8px;
            padding: 10px 12px;
            border-radius: 14px;
            background: rgba(36, 26, 74, 0.9);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 10px 22px rgba(7,4,18,0.45);
            color: rgba(255,255,255,0.85);
        }

        #tutorialScreen .tutorial-guide-overlay {
            background: rgba(10,8,32,0.7);
        }

        #tutorialScreen .tutorial-guide-box {
            background: linear-gradient(180deg, rgba(42,30,92,0.95), rgba(26,18,63,0.95));
            border: 1px solid rgba(255,255,255,0.12);
            color: #fff;
        }

        #tutorialScreen .tutorial-guide-title {
            color: #e7c9ff;
        }

        .hint-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 22px;
            height: 22px;
            border-radius: 11px;
            background: #FFD966;
            color: #1a1543;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* Found counter â€” left aligned */
        #gameScreen .game-found-label {
            text-align: left;
            padding: 6px 16px 6px;
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: rgba(255,255,255,0.85);
        }

        /* Carousel â€” white cards, larger, no golden bg */
        #gameScreen .carousel {
            background: none;
            box-shadow: none;
            border-radius: 0;
            padding: 0 12px;
            height: auto;
            min-height: 0;
            gap: 10px;
        }

        #gameScreen .carousel::before {
            display: none;
        }

        #gameScreen .carousel-item {
            width: 72px;
            height: 72px;
            border-radius: 14px;
            background: #fff;
            padding: 8px;
            box-shadow: none;
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        #gameScreen .carousel-item.found {
            opacity: 0.25;
            filter: grayscale(1);
        }

        #gameScreen .carousel-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            margin: 0;
        }

        #gameScreen .carousel-label {
            display: none;
        }

        /* Ad banner in game */
        #gameScreen .game-ad-banner {
            width: calc(100% - 24px);
            margin: 8px auto 0;
            height: 50px;
            background: rgba(255,255,255,0.92);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #gameScreen .game-ad-banner .ad-placeholder {
            font-size: 13px;
            color: #999;
        }

        /* =========================
     ADS (stub) + overlay actions
     ========================= */

        .btn.secondary{
            background: #3f314a;
            color: #f5e3ff;
        }

        .ad-overlay{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.78);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 500;
            padding: 16px;
        }
        .ad-overlay.visible{ display: flex; }

        .ad-dialog{
            width: min(92vw, 380px);
            background: #15111d;
            border-radius: 18px;
            padding: 16px 16px 14px;
            box-shadow: 0 14px 36px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.12);
        }
        .ad-title{
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 6px;
        }
        .ad-text{
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.35;
            margin-bottom: 12px;
        }
        .ad-actions{
            display: flex;
            gap: 10px;
        }
        .ad-actions .btn{
            flex: 1;
        }


        /* SCORE: bigger bottom back button */
        #scoreScreen #scoreBackBottomButton.play-btn.secondary{
            width: min(360px, 94%);
            padding: 16px 42px;
            font-size: 18px;
            border-radius: 999px;
        }

        /* SCORE: redesigned players list + highlight current user */
        #scoreScreen .scoreboard-players{
            gap: 8px;
        }
        #scoreScreen .scoreboard-player-card{
            padding: 10px 12px;
            border-radius: 14px;
            background: rgba(0,0,0,0.28);
            border: 1px solid rgba(255,255,255,0.10);
            font-size: 12px;
        }
        #scoreScreen .scoreboard-player-card .left{
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #scoreScreen .scoreboard-rank{
            width: 22px;
            text-align: center;
            font-weight: 900;
            opacity: 0.85;
        }
        #scoreScreen .scoreboard-player-card.is-me{
            background: linear-gradient(135deg, rgba(255,226,155,0.25), rgba(0,0,0,0.25));
            border-color: rgba(255,226,155,0.35);
        }
        #scoreScreen .scoreboard-score{
            font-size: 14px;
            font-weight: 900;
        }

        /* ---- EDIT PROFILE OVERLAY ---- */
        .edit-profile-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.72);
            display: none; align-items: flex-end; justify-content: center;
            z-index: 200;
        }
        .edit-profile-overlay.visible { display: flex; }

        .edit-profile-panel {
            width: 100%; max-width: 480px;
            background: linear-gradient(180deg, #1e1650 0%, #120e3a 100%);
            border-radius: 28px 28px 0 0;
            padding: 24px 20px calc(40px + env(safe-area-inset-bottom, 0px));
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            animation: ep-slide-up 0.3s ease-out;
        }
        @keyframes ep-slide-up {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }

        .edit-profile-header {
            display: flex; align-items: center; justify-content: center;
            position: relative; width: 100%;
        }
        .edit-profile-title {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 18px; font-weight: 700; color: #fff;
        }
        .edit-profile-close-btn {
            position: absolute; right: 0;
            width: 36px; height: 36px; border-radius: 50%;
            border: none; background: rgba(255,255,255,0.15);
            color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            padding: 0;
        }
        .edit-profile-close-btn:active { transform: scale(0.93); }

        .edit-profile-avatar-wrap {
            position: relative; cursor: pointer;
            width: 96px; height: 96px; flex-shrink: 0;
        }
        .edit-profile-avatar {
            width: 96px; height: 96px; border-radius: 50%;
            background: linear-gradient(135deg,#ffd27f,#ff8e4c);
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; font-weight: 700; color: #3b2312;
            background-size: cover; background-position: center;
            border: 3px solid rgba(255,255,255,0.2);
            user-select: none;
        }
        .edit-profile-avatar-edit-icon {
            position: absolute; bottom: 2px; right: 2px;
            width: 28px; height: 28px; border-radius: 50%;
            background: #fff;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        .edit-profile-field {
            width: 100%; display: flex; flex-direction: column; gap: 8px;
        }
        .edit-profile-label {
            font-family: 'Rubik', system-ui, sans-serif;
            font-size: 14px; color: rgba(255,255,255,0.6); padding-left: 4px;
        }
        .edit-profile-input {
            width: 100%; padding: 18px 16px;
            border-radius: 16px; border: 2px solid rgba(100,80,200,0.5);
            background: rgba(50,30,120,0.7);
            color: #fff; font-family: 'Rubik', system-ui, sans-serif;
            font-size: 16px; font-weight: 600; outline: none;
            -webkit-appearance: none;
        }
        .edit-profile-input::placeholder { color: rgba(255,255,255,0.35); }
        .edit-profile-input:focus { border-color: rgba(140,100,255,0.9); }

        .edit-profile-save-btn {
            width: 100%; padding: 18px;
            border-radius: 999px; border: none;
            background: rgba(220,215,255,0.95);
            color: #1a1243; font-family: 'Rubik', system-ui, sans-serif;
            font-size: 16px; font-weight: 700; cursor: pointer;
            margin-top: 8px;
        }
        .edit-profile-save-btn:active { transform: scale(0.98); }
        .edit-profile-save-btn:disabled { opacity: 0.6; cursor: default; }
    </style>
</head>
<body>

<div id="splashScreen" class="screen active">
    <div class="splash-wrapper">
        <div class="splash-logo-block">
            <svg class="splash-logo-icon" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Magnifying glass handle -->
                <rect x="72" y="82" width="12" height="30" rx="6" transform="rotate(-45 72 82)" fill="#c9a0dc"/>
                <!-- Magnifying glass body -->
                <circle cx="52" cy="58" r="28" stroke="#8b5cf6" stroke-width="6" fill="none"/>
                <circle cx="52" cy="58" r="20" fill="#2d1b69"/>
                <!-- Eye -->
                <ellipse cx="52" cy="60" rx="12" ry="9" fill="#c9a0dc"/>
                <circle cx="52" cy="59" r="5" fill="#1a1043"/>
                <circle cx="54" cy="57" r="2" fill="#fff"/>
                <!-- Hat brim -->
                <ellipse cx="52" cy="32" rx="30" ry="6" fill="#7c3aed"/>
                <!-- Hat dome -->
                <path d="M30 32 C30 32 34 8 52 8 C70 8 74 32 74 32" fill="#8b5cf6"/>
                <!-- Hat band -->
                <rect x="32" y="28" width="40" height="5" rx="2" fill="#6d28d9"/>
                <!-- Hat tip fold -->
                <path d="M62 12 C62 12 72 18 74 28" stroke="#9f67ff" stroke-width="2" fill="none" stroke-linecap="round"/>
            </svg>
            <div class="splash-title">Hidden</div>
            <div class="splash-subtitle">Objects Quest</div>
        </div>

        <div class="splash-progress-wrapper">
            <div class="splash-progress-track">
                <div class="splash-progress-fill"></div>
                <div class="splash-progress-text">loading...</div>
            </div>
        </div>
    </div>
</div>

<!-- LOGIN MODAL -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-dialog">
        <div class="login-icon" aria-hidden="true">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                <path d="M10 17l5-5-5-5" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M13 12H3" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
        </div>
        <div class="login-title" id="loginTitle">Welcome back</div>
        <div class="login-subtitle" id="loginSubtitle">Log in to save your score and profile.</div>

        <button class="login-google-btn" id="loginGoogleBtn">
            <span style="display:inline-flex;width:20px;height:20px;border-radius:50%;background:#fff;align-items:center;justify-content:center;font-weight:800;color:#4285F4;">G</span>
            Continue with Google
        </button>
        <button class="login-guest-btn" id="loginAutofillBtn">
            Continue as Guest
        </button>

        <div class="login-legacy">
            <div class="login-avatar-row" id="loginAvatarRow">
                <div class="login-avatar-large" id="loginAvatar">P</div>
                <div class="login-player-name" id="loginPlayerNameLabel">Player</div>
            </div>

            <div class="login-field" id="registerNameField" style="display:none;">
                <label for="registerName">Player name</label>
                <input id="registerName" type="text" placeholder="Your name (optional)" autocomplete="off" />
            </div>

            <input id="avatarFileInput" type="file" accept="image/*" style="display:none" />

            <div class="login-field">
                <label for="loginEmail">Email</label>
                <input id="loginEmail" type="email" placeholder="admin@gmail.com" autocomplete="off" />
            </div>
            <div class="login-field">
                <label for="loginPassword">Password</label>
                <input id="loginPassword" type="password" placeholder="admin" />
            </div>

            <button class="btn login-btn" id="loginSubmitBtn">Log in</button>
            <button class="login-switch" id="switchAuthModeBtn">
                No account? Register
            </button>
        </div>

        <div class="login-error" id="loginError"></div>
    </div>
</div>

<!-- PROFILE MODAL -->
<div class="profile-overlay" id="profileOverlay">
    <div class="profile-dialog">
        <div class="profile-avatar" id="profileAvatar">P</div>
        <div class="profile-name" id="profileName">ProfileName</div>
        <button class="profile-btn profile-edit-btn" id="profileEditBtn">Edit profile</button>
        <button class="profile-btn profile-logout-btn" id="profileLogoutBtn">Log out</button>
        <div class="profile-score">
            <div class="profile-score-value" id="profileScoreValue">0</div>
            <div class="profile-score-label">Total score</div>
        </div>
    </div>
</div>

<!-- EDIT PROFILE OVERLAY -->
<div class="edit-profile-overlay" id="editProfileOverlay">
    <div class="edit-profile-panel">
        <div class="edit-profile-header">
            <span class="edit-profile-title">Edit profile</span>
            <button class="edit-profile-close-btn" id="editProfileCloseBtn" aria-label="Close">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M1 1l12 12M13 1L1 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>

        <div class="edit-profile-avatar-wrap" id="editProfileAvatarWrap">
            <div class="edit-profile-avatar" id="editProfileAvatarEl">P</div>
            <div class="edit-profile-avatar-edit-icon">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="#333" stroke-width="2" stroke-linecap="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="#333" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <input type="file" id="editAvatarInput" accept="image/*" style="display:none">
        </div>

        <div class="edit-profile-field">
            <label class="edit-profile-label" for="editProfileNameInput">User name</label>
            <input class="edit-profile-input" id="editProfileNameInput" type="text" placeholder="ProfileName" maxlength="40">
        </div>

        <button class="edit-profile-save-btn" id="editProfileSaveBtn">Save changes</button>
    </div>
</div>

<!-- TUTORIAL SCREEN -->
<div id="tutorialScreen" class="screen">
    <div class="game-wrapper tutorial-wrapper">
        <div class="hud">
            <div class="hud-title-row">
                <span class="title-text">How to play</span>
            </div>
            <div class="hud-header">
        <span class="hud-progress">
          Tap these objects on the picture
        </span>
                <span class="hud-score">
          Score: <span id="scoreValue">0</span>
        </span>
                <span class="hud-lives">
          Hints:
          <span class="hearts" id="tutorialHintsCount">2</span>
        </span>
            </div>
        </div>

        <div class="game" id="tutorialGame">
            <button class="tutorial-skip-btn" id="tutorialSkipBtn">Skip</button>

            <div class="game-top-buttons">
                <button class="hint-button" id="tutorialHintButton" data-hints="2"></button>
            </div>

            <img src="https://stage-configs.artintgames.com/v1/storage/view/9/room_bg.webp" class="game-bg" alt="Tutorial room" id="tutorialBg" draggable="false">

            <img src="https://stage-configs.artintgames.com/v1/storage/view/9/book.webp"
                 class="t-item"
                 data-name="Book"
                 data-x="604"
                 data-y="940"
                 data-w="132"
                 data-h="198"
                 draggable="false">

            <img src="https://stage-configs.artintgames.com/v1/storage/view/9/car.webp"
                 class="t-item"
                 data-name="Car"
                 data-x="-8"
                 data-y="401"
                 data-w="78"
                 data-h="117"
                 draggable="false">

            <img src="https://stage-configs.artintgames.com/v1/storage/view/9/camera.webp"
                 class="t-item"
                 data-name="Camera"
                 data-x="42"
                 data-y="799"
                 data-w="79"
                 data-h="119"
                 draggable="false">

            <div class="tutorial-guide-overlay" id="tutorialGuideOverlay">
                <div class="tutorial-guide-box">
                    <div class="tutorial-guide-title">Find the objects</div>
                    <div class="tutorial-guide-text">
                        Tap the highlighted object on the picture, then find the remaining ones.
                    </div>
                </div>
            </div>

            <div class="overlay" id="tutorialOverlay">
                <div class="overlay-title">Nice! ðŸŽ‰</div>
                <div class="overlay-text">
                    Youâ€™ve found all example objects.<br/>Now youâ€™re ready to play!
                </div>
                <button class="btn" id="tutorialContinueBtn">Continue</button>
            </div>
        </div>

        <div class="carousel" id="tutorialCarousel"></div>

        <div class="tutorial-text">
            <p>â€¢ At the bottom you see the objects to find.</p>
            <p>â€¢ Tap the same objects on the picture.</p>
            <p>â€¢ If itâ€™s hard, tap the ðŸ’¡ button to highlight one object.</p>
        </div>
    </div>
</div>

<!-- MAIN MENU -->
<div id="menuScreen" class="screen">
    <div class="menu-wrapper">
        <div class="menu-header">
            <button class="menu-profile-btn" id="menuProfileButton" aria-label="Profile">
                <div class="menu-login-icon" id="menuLoginIcon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M10 17l5-5-5-5" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13 12H3" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="player-info" id="menuPlayerInfo">
                    <div class="player-avatar" id="menuPlayerAvatar">P</div>
                    <div class="player-name" id="menuPlayerName">Player</div>
                </div>
            </button>
            <button class="menu-settings-btn" id="mainSettingsButton">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <div class="menu-content">
            <div class="menu-logo-row">
                <svg class="menu-logo-icon-small" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="72" y="82" width="12" height="30" rx="6" transform="rotate(-45 72 82)" fill="#c9a0dc"/>
                    <circle cx="52" cy="58" r="28" stroke="#8b5cf6" stroke-width="6" fill="none"/>
                    <circle cx="52" cy="58" r="20" fill="#2d1b69"/>
                    <ellipse cx="52" cy="60" rx="12" ry="9" fill="#c9a0dc"/>
                    <circle cx="52" cy="59" r="5" fill="#1a1043"/>
                    <circle cx="54" cy="57" r="2" fill="#fff"/>
                    <ellipse cx="52" cy="32" rx="30" ry="6" fill="#7c3aed"/>
                    <path d="M30 32 C30 32 34 8 52 8 C70 8 74 32 74 32" fill="#8b5cf6"/>
                    <rect x="32" y="28" width="40" height="5" rx="2" fill="#6d28d9"/>
                    <path d="M62 12 C62 12 72 18 74 28" stroke="#9f67ff" stroke-width="2" fill="none" stroke-linecap="round"/>
                </svg>
                <div class="menu-logo-text-row">
                    <div class="menu-logo-title-main">Hidden</div>
                    <div class="menu-logo-subtitle">Objects Quest</div>
                </div>
            </div>

            <div class="menu-level-badge">
                <div class="level-circle">
                    <div class="level-number" id="menuLevelNumber">1</div>
                    <div class="level-text">Current level</div>
                </div>
            </div>

            <div class="menu-score">
                <div class="menu-score-row">
                    <span class="score-star">â­</span>
                    <span class="score-value" id="menuScoreValue">0</span>
                </div>
                <div class="score-label">Total score</div>
            </div>

            <button class="menu-play-button" id="playButton">PLAY</button>
        </div>

        <div class="menu-ad-banner">
            <div class="ad-placeholder">Ad banner</div>
        </div>

        <!-- Hidden elements for JS compatibility -->
        <div class="menu-compat-hidden">
            <div id="menuLevelLabel">Level 1</div>
            <div id="menuLevelTitle">Cartoon Room</div>
            <div id="menuLevelDesc">Find all hidden objects in this cozy cartoon living room.</div>
            <button id="startFromBeginningButton">Start from beginning</button>
            <button id="scoreboardButton">Scoreboard</button>
        </div>
    </div>
</div>

<!-- SCORE SCREEN -->
<div id="scoreScreen" class="screen">
    <div class="menu-wrapper score-wrapper">
        <div class="menu-header">
            <button class="menu-profile-btn score-profile-btn" id="scoreProfileButton" aria-label="Profile">
                <div class="player-info">
                    <div class="player-avatar" id="scorePlayerAvatar">P</div>
                    <div class="player-name" id="scorePlayerName">Player</div>
                </div>
            </button>
            <div class="menu-header-title">Scores</div>
            <button class="menu-settings-btn" id="scoreBackButton">â†</button>
        </div>

        <div class="menu-content">
            <div class="menu-level-info">
                <div class="menu-level-label">Your total score</div>
                <div class="menu-level-title" id="scoreTotalValue">0</div>
                <div class="menu-level-desc">
                    In future updates, this screen will show a leaderboard of all players.
                </div>
            </div>

            <div class="menu-level-info">
                <div class="menu-level-label">Players</div>
                <!-- âœ… now dynamically rendered (includes current player) -->
                <div class="scoreboard-players" id="scoreboardPlayers"></div>
            </div>
        </div>

        <div class="play-btn-wrapper">
            <button class="play-btn secondary" id="scoreBackBottomButton">Back to menu</button>
        </div>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
    <div class="game-wrapper">
        <!-- Minimal HUD -->
        <div class="hud game-hud">
            <div class="hud-topbar">
                <div class="hud-left-stack">
                    <span class="hearts">â¤</span>
                    <span class="lives-count" id="livesHearts">3</span>
                </div>
                <div class="hud-center-stack">
                    <span class="hud-star">â­</span>
                    <span class="hud-score-val" id="scoreValueGame">0</span>
                </div>
                <div class="hud-right-stack">
                    <button class="hud-settings-btn" id="menuButton" aria-label="Settings">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Game image area -->
        <div class="game" id="game">
            <div class="game-top-buttons">
                <button class="hint-button" id="hintButton" data-hints="2"></button>
            </div>

            <img src="https://stage-configs.artintgames.com/v1/storage/view/9/room_bg.webp" class="game-bg" alt="room" id="roomBg" draggable="false">

            <div class="overlay" id="overlay">
                <div class="overlay-card">
                    <div class="overlay-title" id="overlayTitle">You need more lives</div>
                    <div class="overlay-icon" id="overlayIcon">
                        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M40 70s-28-16.8-28-35c0-9.94 7.06-18 16-18 5.94 0 9.92 3.2 12 6.4C42.08 20.2 46.06 17 52 17c8.94 0 16 8.06 16 18 0 18.2-28 35-28 35z" fill="#ff4a6e"/>
                            <path d="M40 70s-28-16.8-28-35c0-9.94 7.06-18 16-18 5.94 0 9.92 3.2 12 6.4" fill="#ff6b8a" opacity="0.6"/>
                        </svg>
                    </div>
                    <div class="overlay-text" id="overlayText"></div>
                    <div class="overlay-actions">
                        <button class="btn overlay-btn-primary" id="reviveBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="margin-right:6px;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><polygon points="10,8 16,12 10,16" fill="currentColor"/></svg>
                            Get 3 lives
                        </button>
                        <button class="btn overlay-btn-secondary" id="restartBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px;"><path d="M1 4v6h6M23 20v-6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            Restart
                        </button>
                    </div>
                </div>

                <div class="overlay-win" id="overlayWin">
                    <div class="win-top">
                        <div class="win-player" id="winPlayerButton" role="button" aria-label="Profile">
                            <div class="win-avatar" id="winPlayerAvatar">P</div>
                            <div class="win-name" id="winPlayerName">Player</div>
                        </div>
                        <button class="win-settings-btn" id="winSettingsBtn" aria-label="Settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7z" stroke="white" stroke-width="2"/>
                                <path d="M19.4 15a7.8 7.8 0 0 0 .1-6l2-1.2-2-3.4-2.3 1a7.8 7.8 0 0 0-5.2-2.2L11.2 1h-4l-.8 2.2a7.8 7.8 0 0 0-4 2.6l-2.4-1-2 3.4 2 1.2a7.8 7.8 0 0 0 0 6l-2 1.2 2 3.4 2.4-1a7.8 7.8 0 0 0 4 2.6l.8 2.2h4l.8-2.2a7.8 7.8 0 0 0 5.2-2.2l2.3 1 2-3.4-2-1.2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>

                    <div class="win-title" id="winTitle">Level Completed!</div>

                    <div class="win-image" id="winImage" aria-label="Level image"></div>

                    <div class="win-actions-row">
                        <button class="win-action-btn" id="winRateBtn">
                            <span>ðŸ‘</span>
                            <span>Rate us</span>
                        </button>
                        <button class="win-action-btn" id="winShareBtn">
                            <span>â†—</span>
                            <span>Share</span>
                        </button>
                    </div>

                    <div class="win-score">
                        <div class="win-score-main">
                            <span>â­</span>
                            <span id="winScoreValue">0</span>
                        </div>
                        <div class="win-score-sub">Total score</div>
                    </div>

                    <button class="win-next-btn" id="winNextBtn">Next level</button>

                    <div class="win-ad">Ad banner</div>
                </div>
            </div>
        </div>

        <!-- Hint button (below image) -->
        <div class="game-hint-area">
            <button class="hint-btn-new" id="hintBtnNew" aria-label="Hint">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                    <path d="M9 18h6M12 2a7 7 0 00-4 12.7V16a1 1 0 001 1h6a1 1 0 001-1v-1.3A7 7 0 0012 2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="hint-badge" id="hintBadge">2</span>
            </button>
        </div>

        <!-- Found counter -->
        <div class="game-found-label">
            <span id="foundCount">0</span>/<span id="totalCount">0</span> found
        </div>

        <!-- Carousel -->
        <div class="carousel" id="carousel"></div>

        <!-- Ad banner -->
        <div class="game-ad-banner">
            <div class="ad-placeholder">Ad banner</div>
        </div>

        <!-- Hidden compat elements for JS -->
        <div class="menu-compat-hidden" style="display:none;">
            <div id="gamePlayerAvatar">P</div>
            <div id="gamePlayerName">Player</div>
            <div id="hudLevelValue">Level 1</div>
        </div>
    </div>
</div>

<!-- SETTINGS OVERLAY -->
<div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel" id="settingsPanel">
        <!-- Header -->
        <div class="settings-header">
            <div class="settings-title">Settings</div>
            <button class="settings-close" id="settingsCloseBtn" aria-label="Close settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="white" stroke-width="2.5" stroke-linecap="round"/></svg>
            </button>
        </div>

        <div class="settings-content">
            <!-- General -->
            <div class="settings-section" id="settingsSectionGeneral">
                <div class="settings-section-title">General</div>
                <div class="settings-row">
                    <div class="settings-row-left">
                        <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M3 12h18M12 3a15 15 0 0 1 0 18M12 3a15 15 0 0 0 0 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span class="settings-label">Language</span>
                    </div>
                    <button id="languageButton" class="settings-pill" disabled>English</button>
                </div>
            </div>

            <!-- Sound toggles -->
            <div class="settings-section" id="settingsSectionSound">
                <div class="settings-section-title">Sound</div>
                <div class="settings-row">
                    <div class="settings-row-left">
                        <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M11 5L6 9H2v6h4l5 4V5z" stroke="#c084fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.54 8.46a5 5 0 010 7.07M19.07 4.93a10 10 0 010 14.14" stroke="#c084fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <span class="settings-label">Sounds</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="soundToggle" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="settings-row">
                    <div class="settings-row-left">
                        <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M9 18V5l12-2v13" stroke="#c084fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="6" cy="18" r="3" stroke="#c084fc" stroke-width="2"/><circle cx="18" cy="16" r="3" stroke="#c084fc" stroke-width="2"/></svg>
                        <span class="settings-label">Music</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="musicToggle">
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Links -->
            <div class="settings-section" id="settingsSectionLinks">
                <div class="settings-section-title">Info</div>
                <div class="settings-links" id="settingsLinks">
                    <div class="settings-link-item" data-link="rate">
                        <div class="settings-row-left">
                            <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.27 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z" stroke="#c084fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <span class="settings-link-label">Rate us</span>
                        </div>
                        <svg class="settings-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 18l6-6-6-6" stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="settings-link-item" data-link="support">
                        <div class="settings-row-left">
                            <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 18v-6a9 9 0 0118 0v6" stroke="#c084fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 19a2 2 0 01-2 2h-1a2 2 0 01-2-2v-3a2 2 0 012-2h3v5zM3 19a2 2 0 002 2h1a2 2 0 002-2v-3a2 2 0 00-2-2H3v5z" stroke="#c084fc" stroke-width="2"/></svg>
                            <span class="settings-link-label">Help and Support</span>
                        </div>
                        <svg class="settings-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 18l6-6-6-6" stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="settings-link-item" data-link="privacy">
                        <div class="settings-row-left">
                            <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="3" y="11" width="18" height="11" rx="2" stroke="#c084fc" stroke-width="2"/><path d="M7 11V7a5 5 0 0110 0v4" stroke="#c084fc" stroke-width="2" stroke-linecap="round"/></svg>
                            <span class="settings-link-label">Privacy Policy</span>
                        </div>
                        <svg class="settings-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 18l6-6-6-6" stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
          <div class="settings-link-item" data-link="terms">
            <div class="settings-row-left">
              <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" stroke="#c084fc" stroke-width="2"/><path d="M7 7h10M7 12h10M7 17h6" stroke="#c084fc" stroke-width="2" stroke-linecap="round"/></svg>
              <span class="settings-link-label">Terms of use</span>
            </div>
            <svg class="settings-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 18l6-6-6-6" stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="settings-link-item" data-link="exit">
            <div class="settings-row-left">
              <svg class="settings-row-icon" width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M6 6l12 12M18 6L6 18" stroke="#c084fc" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="settings-link-label">Exit to menu</span>
            </div>
            <svg class="settings-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 18l6-6-6-6" stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
        </div>
      </div>

            <!-- Account -->
            <div class="settings-section settings-account-card" id="settingsSectionAccount">
                <div class="settings-account-guest" id="settingsAccountGuest">
                    <div class="settings-account-icon" aria-hidden="true">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                            <path d="M10 17l5-5-5-5" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M13 12H3" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="settings-account-title">Sign up</div>
                    <div class="settings-account-status">Not logged in</div>
                    <button id="loginGoogleButton" class="settings-account-btn google">
                        <span style="display:inline-flex;width:20px;height:20px;border-radius:50%;background:#fff;align-items:center;justify-content:center;font-weight:800;color:#4285F4;">G</span>
                        Continue with Google
                    </button>
                    <button id="loginGuestButton" class="settings-account-btn guest">Continue as Guest</button>
                </div>

                <div class="settings-account-logged" id="settingsAccountLogged" style="display:none;">
                    <div class="settings-section-title">Account</div>
                    <div class="settings-status-row">
                        <span class="settings-status-label">Status</span>
                        <span id="authStatus" class="settings-status">Logged in (token)</span>
                    </div>
                    <button id="logoutButton" class="settings-account-btn logout">Logout</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- REWARDED AD STUB (modal) -->
<div class="ad-overlay" id="adOverlay">
    <div class="ad-dialog">
        <div class="ad-title" id="adTitle">Ad</div>
        <div class="ad-text" id="adText">
            This is a stub. Press â€œGet rewardâ€ to instantly receive the reward.
        </div>
        <div class="ad-actions">
            <button class="btn secondary" id="adCancelBtn">Cancel</button>
            <button class="btn" id="adRewardBtn">Get reward</button>
        </div>
    </div>
</div>

<script>
    async function startAiGame() {
        console.log('[GAME] startAiGame entered, cordova:', !!window.cordova);
        const splashScreen   = document.getElementById('splashScreen');
        const tutorialScreen = document.getElementById('tutorialScreen');
        const menuScreen     = document.getElementById('menuScreen');
        const gameScreen     = document.getElementById('gameScreen');
        const scoreScreen    = document.getElementById('scoreScreen');

        const playButton   = document.getElementById('playButton');
        const startFromBeginningButton = document.getElementById('startFromBeginningButton');
        const mainSettingsButton = document.getElementById('mainSettingsButton');
        const scoreboardButton   = document.getElementById('scoreboardButton');

        const menuLevelLabel = document.getElementById('menuLevelLabel');
        const menuLevelTitle = document.getElementById('menuLevelTitle');
        const menuLevelDesc  = document.getElementById('menuLevelDesc');
        const menuLevelNumber = document.getElementById('menuLevelNumber');
        const menuScoreValue  = document.getElementById('menuScoreValue');

        const game         = document.getElementById('game');
        const bg           = document.getElementById('roomBg');
        const foundCountEl = document.getElementById('foundCount');
        const totalCountEl = document.getElementById('totalCount');
        const livesHearts  = document.getElementById('livesHearts');
        const hudLevelValue = document.getElementById('hudLevelValue');
        const overlay      = document.getElementById('overlay');
        const overlayTitle = document.getElementById('overlayTitle');
        const overlayText  = document.getElementById('overlayText');
        const restartBtn   = document.getElementById('restartBtn');
        const reviveBtn    = document.getElementById('reviveBtn');
        const winNextBtn   = document.getElementById('winNextBtn');
        const winTitleEl   = document.getElementById('winTitle');
        const winScoreValueEl = document.getElementById('winScoreValue');
        const winImageEl   = document.getElementById('winImage');
        const winPlayerAvatar = document.getElementById('winPlayerAvatar');
        const winPlayerNameEl = document.getElementById('winPlayerName');
        const winSettingsBtn = document.getElementById('winSettingsBtn');
        const winPlayerButton = document.getElementById('winPlayerButton');
        const winRateBtn = document.getElementById('winRateBtn');
        const winShareBtn = document.getElementById('winShareBtn');
        const carousel     = document.getElementById('carousel');
        const menuButton   = document.getElementById('menuButton');
        const hintButton   = document.getElementById('hintButton');
        const hintBtnNew   = document.getElementById('hintBtnNew');
        const hintBadge    = document.getElementById('hintBadge');

        const settingsOverlay  = document.getElementById('settingsOverlay');
        const settingsCloseBtn = document.getElementById('settingsCloseBtn');
        const soundToggle      = document.getElementById('soundToggle');
        const musicToggle      = document.getElementById('musicToggle');
        const settingsLinks    = document.getElementById('settingsLinks');

        // Settings sections
        const settingsSectionLinks   = document.getElementById('settingsSectionLinks');
        const settingsSectionActions = document.getElementById('settingsSectionActions');
        const settingsSectionGeneral = document.getElementById('settingsSectionGeneral');
        const settingsSectionAccount = document.getElementById('settingsSectionAccount');

        // Auth elements
        const loginGuestButton  = document.getElementById('loginGuestButton');
        const loginGoogleButton = document.getElementById('loginGoogleButton');
        const logoutButton      = document.getElementById('logoutButton');
        const authStatusEl      = document.getElementById('authStatus');
        const settingsAccountGuest = document.getElementById('settingsAccountGuest');
        const settingsAccountLogged = document.getElementById('settingsAccountLogged');

        // Ad stub UI
        const adOverlay   = document.getElementById('adOverlay');
        const adTitleEl   = document.getElementById('adTitle');
        const adTextEl    = document.getElementById('adText');
        const adCancelBtn = document.getElementById('adCancelBtn');
        const adRewardBtn = document.getElementById('adRewardBtn');

        const tutorialGame        = document.getElementById('tutorialGame');
        const tutorialBg          = document.getElementById('tutorialBg');
        const tutorialItems       = document.querySelectorAll('.t-item');
        const tutorialCarousel    = document.getElementById('tutorialCarousel');
        const tutorialHintButton  = document.getElementById('tutorialHintButton');
        const tutorialHintsCount  = document.getElementById('tutorialHintsCount');
        const tutorialOverlay     = document.getElementById('tutorialOverlay');
        const tutorialContinueBtn = document.getElementById('tutorialContinueBtn');
        const tutorialGuideOverlay = document.getElementById('tutorialGuideOverlay');
        const tutorialSkipBtn     = document.getElementById('tutorialSkipBtn');

        // SCORE UI
        const scoreValueTutorial = document.getElementById('scoreValue');
        const scoreValueGame     = document.getElementById('scoreValueGame');
        const scoreTotalValueEl  = document.getElementById('scoreTotalValue');
        const scoreBackButton    = document.getElementById('scoreBackButton');
        const scoreBackBottomButton = document.getElementById('scoreBackBottomButton');
        const scoreboardPlayersEl = document.getElementById('scoreboardPlayers'); // âœ… new

        // LOGIN UI
        const loginOverlay     = document.getElementById('loginOverlay');
        const loginTitleEl     = document.getElementById('loginTitle');
        const loginSubtitleEl  = document.getElementById('loginSubtitle');
        const loginEmailInput  = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginSubmitBtn   = document.getElementById('loginSubmitBtn');
        const loginAutofillBtn = document.getElementById('loginAutofillBtn');
        const loginGoogleBtn   = document.getElementById('loginGoogleBtn');
        const loginErrorText   = document.getElementById('loginError');
        const loginAvatar      = document.getElementById('loginAvatar');
        const loginPlayerNameLabel = document.getElementById('loginPlayerNameLabel');
        const registerNameField   = document.getElementById('registerNameField');
        const registerNameInput   = document.getElementById('registerName');
        const switchAuthModeBtn   = document.getElementById('switchAuthModeBtn');
        const avatarFileInput     = document.getElementById('avatarFileInput');
        const loginAvatarRow      = document.getElementById('loginAvatarRow');

        // PLAYER INFO
        const menuProfileButton = document.getElementById('menuProfileButton');
        const scoreProfileButton = document.getElementById('scoreProfileButton');
        const menuLoginIcon = document.getElementById('menuLoginIcon');
        const menuPlayerInfo = document.getElementById('menuPlayerInfo');
        const menuPlayerAvatar = document.getElementById('menuPlayerAvatar');
        const menuPlayerName   = document.getElementById('menuPlayerName');
        const gamePlayerAvatar = document.getElementById('gamePlayerAvatar');
        const gamePlayerName   = document.getElementById('gamePlayerName');
        const scorePlayerAvatar = document.getElementById('scorePlayerAvatar');
        const scorePlayerName   = document.getElementById('scorePlayerName');

        // PROFILE MODAL UI
        const profileOverlay = document.getElementById('profileOverlay');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileNameEl = document.getElementById('profileName');
        const profileEditBtn = document.getElementById('profileEditBtn');
        const profileLogoutBtn = document.getElementById('profileLogoutBtn');
        const profileScoreValue = document.getElementById('profileScoreValue');

        // EDIT PROFILE OVERLAY UI
        const editProfileOverlay   = document.getElementById('editProfileOverlay');
        const editProfileCloseBtn  = document.getElementById('editProfileCloseBtn');
        const editProfileAvatarWrap= document.getElementById('editProfileAvatarWrap');
        const editProfileAvatarEl  = document.getElementById('editProfileAvatarEl');
        const editAvatarInput      = document.getElementById('editAvatarInput');
        const editProfileNameInput = document.getElementById('editProfileNameInput');
        const editProfileSaveBtn   = document.getElementById('editProfileSaveBtn');

        let tutorialFound = 0;
        let tutorialHints = 2;
        let tutorialGuideActive = false;
        let tutorialFocusItem = null;

        const BG_WIDTH  = 1024;
        const BG_HEIGHT = 1536;

        const SOUND_KEY       = 'findit_sound_enabled';
        const MUSIC_KEY       = 'findit_music_enabled';
        const PROGRESS_KEY    = 'findit_max_level';
        const SCORE_KEY       = 'findit_total_score';

        const PLAYER_NAME_KEY    = 'findit_player_name';
        const PLAYER_EMAIL_KEY   = 'findit_player_email';
        const PLAYER_AVATAR_KEY  = 'findit_player_avatar';
        const PLAYER_PASSWORD_KEY = 'findit_player_password';
        const AUTH_TYPE_KEY      = 'findit_auth_type';

        // NEW: in-progress (level session) save key
        const INPROGRESS_KEY = 'findit_inprogress_v1';

        // AUDIO LAZY LOADING
        const AUDIO_URLS = {
            menuMusic: 'https://stage-configs.artintgames.com/v1/storage/view/9/hidden_object_menu_loop_fixed.mp4',
            levelMusic: 'https://stage-configs.artintgames.com/v1/storage/view/9/hidden_object_bg_loop.mp4',
            hit: 'https://stage-configs.artintgames.com/v1/storage/view/9/hit.mp3',
            miss: 'https://stage-configs.artintgames.com/v1/storage/view/9/miss.mp3',
            win: 'https://stage-configs.artintgames.com/v1/storage/view/9/win.mp3',
            lose: 'https://stage-configs.artintgames.com/v1/storage/view/9/lose.mp3'
        };
        const audioCache = {};

        function getAudio(key) {
            if (!audioCache[key] && AUDIO_URLS[key]) {
                audioCache[key] = new Audio(AUDIO_URLS[key]);
                if (key === 'menuMusic' || key === 'levelMusic') {
                    audioCache[key].loop = true;
                    audioCache[key].volume = (key === 'menuMusic') ? 0.02 : 0.2;
                } else if (key === 'hit' || key === 'miss') {
                    audioCache[key].volume = 0.5;
                } else {
                    audioCache[key].volume = 0.6;
                }
            }
            return audioCache[key];
        }

        // Sound key constants for playSound()
        const soundHit = 'hit';
        const soundMiss = 'miss';
        const soundWin = 'win';
        const soundLose = 'lose';

        let currentMusic = null;

        // Fallback LEVELS (offline-safe)
const _itemSvg = (color, label) =>
    'data:image/svg+xml,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">` +
      `<rect width="80" height="80" fill="${color}" rx="12"/>` +
      `<text x="40" y="54" font-size="32" text-anchor="middle" fill="white" font-family="sans-serif">${label}</text></svg>`
    );
const _bgSvg = (label) =>
    'data:image/svg+xml,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1536">` +
      `<defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">` +
      `<stop offset="0%" stop-color="#1a1543"/><stop offset="100%" stop-color="#0a0820"/></linearGradient></defs>` +
      `<rect width="1024" height="1536" fill="url(#g)"/>` +
      `<text x="512" y="720" font-size="64" text-anchor="middle" fill="rgba(255,255,255,0.15)" font-family="sans-serif">${label}</text>` +
      `</svg>`
    );
const TESTPIC_FALLBACK_LEVELS = [
    { id: 1, key: 'fallback-1', menuTitle: 'Test Level 1', bg: _bgSvg('Level 1'),
      items: [
        { name: 'Item A', src: _itemSvg('#e74c3c', 'A'), x: 120, y: 200, w: 80, h: 80 },
        { name: 'Item B', src: _itemSvg('#f39c12', 'B'), x: 600, y: 480, w: 80, h: 80 },
        { name: 'Item C', src: _itemSvg('#3498db', 'C'), x: 350, y: 900, w: 80, h: 80 },
      ]},
    { id: 2, key: 'fallback-2', menuTitle: 'Test Level 2', bg: _bgSvg('Level 2'),
      items: [
        { name: 'Item D', src: _itemSvg('#9b59b6', 'D'), x: 200, y: 300,  w: 80, h: 80 },
        { name: 'Item E', src: _itemSvg('#1abc9c', 'E'), x: 700, y: 700,  w: 80, h: 80 },
        { name: 'Item F', src: _itemSvg('#2ecc71', 'F'), x: 450, y: 1100, w: 80, h: 80 },
      ]},
];

// Load LEVELS from remote config via initConfigs (fallback on failure)
let LEVELS;
try {
    const configResult = await coreSDK.initConfigs({
        version: '2.0.0',
        keys: ['testpic-init']
    });
    LEVELS = configResult.get('testpic-init.LEVELS') || TESTPIC_FALLBACK_LEVELS;
    console.log('[GAME] LEVELS from config, count:', LEVELS.length);
} catch (e) {
    console.error('[GAME] initConfigs failed, using fallback LEVELS:', e && (e.message || e));
    LEVELS = TESTPIC_FALLBACK_LEVELS;
}

let currentLevelIndex = 0;
        let maxUnlockedLevel  = 1;
        let items = [];


        let foundCount  = 0;
        let lives       = 3;
        const maxLives  = 3;

        // ===== Rewarded ads stubs config =====
        const MAX_AD_REVIVES_PER_LEVEL = 1;
        let adRevivesLeft = MAX_AD_REVIVES_PER_LEVEL;

        // ===== AppLovin ads helpers (Cordova only) =====
        const isCordovaEnv = () => !!window.cordova;

        function showBannerAd() {
            console.log('[ADS] showBannerAd called | coreSDK defined:', typeof coreSDK !== 'undefined',
                '| coreSDK.ads:', !!coreSDK?.ads,
                '| coreSDK.ads.showAd:', typeof coreSDK?.ads?.showAd);
            if (!coreSDK?.ads?.showAd) {
                console.warn('[ADS] showBannerAd: coreSDK.ads.showAd Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð°Ð½Ð½ÐµÑ€');
                return;
            }
            console.log('[ADS] showBannerAd: Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ showAd("banner", "find_object_banner")');
            coreSDK.ads.showAd('banner', 'find_object_banner')
                .then(r => console.log('[ADS] showBannerAd result:', JSON.stringify(r)))
                .catch(e => console.error('[ADS] showBannerAd error:', e && e.message, e));
        }

        async function showInterstitialAd() {
            console.log('[ADS] showInterstitialAd called | coreSDK.ads.showAd:', typeof coreSDK?.ads?.showAd);
            if (!coreSDK?.ads?.showAd) {
                console.warn('[ADS] showInterstitialAd: coreSDK.ads.showAd Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼');
                return;
            }
            try {
                console.log('[ADS] showInterstitialAd: Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ showAd("interstitial", "find_object_inter")');
                const r = await coreSDK.ads.showAd('interstitial', 'find_object_inter');
                console.log('[ADS] showInterstitialAd result:', JSON.stringify(r));
            } catch (e) {
                console.error('[ADS] showInterstitialAd error:', e && e.message, e);
            }
        }

        function showRewardedAd(onReward) {
            console.log('[ADS] showRewardedAd called | coreSDK.ads.showAd:', typeof coreSDK?.ads?.showAd);
            if (coreSDK?.ads?.showAd) {
                console.log('[ADS] showRewardedAd: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SDK showAd("rewarded", "reward")');
                coreSDK.ads.showAd('rewarded', 'reward', (result) => {
                    console.log('[ADS] showRewardedAd result:', JSON.stringify(result));
                    if (result.canReward) onReward();
                });
            } else {
                console.warn('[ADS] showRewardedAd: coreSDK Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ UI');
                showRewardedAdStub({
                    title: 'Rewarded Ad (stub)',
                    text: 'Press "Get reward" to receive a reward.',
                    onReward,
                });
            }
        }

        // ===== Re-apply ads config AFTER initConfigs =====
        // initConfigs() triggers configsupdated â†’ onConfigUpdated() reads server config that has no 'ads' key
        // â†’ adsConfig = null, enabled = false. We must re-inject the mock config here.
        if (typeof APPLOVIN_ADS_CONFIG !== 'undefined' && coreSDK?.ads?.setMockConfig) {
            console.log('[ADS] re-applying setMockConfig Ð¿Ð¾ÑÐ»Ðµ initConfigs()...');
            try {
                coreSDK.ads.setMockConfig(APPLOVIN_ADS_CONFIG);
                await coreSDK.ads.init();
                console.log('[ADS] re-apply OK â€” ads.enabled Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ true');
            } catch(e) {
                console.error('[ADS] re-apply failed:', e && e.message);
            }
        } else {
            console.warn('[ADS] re-apply Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½ â€” cordova:', !!window.cordova,
                '| APPLOVIN_ADS_CONFIG defined:', typeof APPLOVIN_ADS_CONFIG !== 'undefined',
                '| setMockConfig:', typeof coreSDK?.ads?.setMockConfig);
        }

        // Show banner immediately (preloaded by SDK)
        console.log('[ADS] startAiGame: Ð²Ñ‹Ð·Ð¾Ð² showBannerAd()');
        showBannerAd();

        let gameOver    = false;
        let soundEnabled = true;
        let musicEnabled = true;
        let hintsLeft   = 2;
        const maxHints  = 2;
        let overlayMode = 'restart';

        let totalScore = 0;

        let playerName = 'Player';
        let playerEmail = '';
        let playerAvatarSymbol = '';
        let authTypeLocal = null;
        let authMode = 'login';

        let pendingAdReward = null; // callback for ad stub

        // =========================
        // Storage wrapper with KV + localStorage fallback
        // =========================
        let useKvStorage = true; // Try KV first, fallback to localStorage if it fails

        const storage = {
            async get(key) {
                if (useKvStorage) {
                    try {
                        const result = await coreSDK.kv.get(key);
                        if (result && typeof result === 'object') {
                            if (Object.prototype.hasOwnProperty.call(result, key)) {
                                return { value: result[key] };
                            }
                            if (Object.prototype.hasOwnProperty.call(result, 'value')) {
                                return { value: result.value };
                            }
                        }
                        return { value: result ?? null };
                    } catch (e) {
                        console.warn('[Storage] KV failed, using localStorage:', e.message);
                        useKvStorage = false;
                    }
                }
                // localStorage fallback
                const value = localStorage.getItem(key);
                return { value };
            },

            async set(key, value) {
                if (useKvStorage) {
                    try {
                        await coreSDK.kv.set({ [key]: value });
                        return;
                    } catch (e) {
                        console.warn('[Storage] KV failed, using localStorage:', e.message);
                        useKvStorage = false;
                    }
                }
                // localStorage fallback
                localStorage.setItem(key, value);
            },

            async delete(key) {
                if (useKvStorage) {
                    try {
                        await coreSDK.kv.delete(key);
                        return;
                    } catch (e) {
                        console.warn('[Storage] KV failed, using localStorage:', e.message);
                        useKvStorage = false;
                    }
                }
                // localStorage fallback
                localStorage.removeItem(key);
            },

            async getMany(keys) {
                if (useKvStorage) {
                    try {
                        const results = await coreSDK.kv.getMany(keys);
                        const obj = {};
                        if (Array.isArray(results)) {
                            keys.forEach((key, index) => {
                                const entry = results[index];
                                obj[key] = entry && Object.prototype.hasOwnProperty.call(entry, 'value') ? entry.value : entry ?? null;
                            });
                            return obj;
                        }
                        if (results && typeof results === 'object') {
                            keys.forEach((key) => {
                                const entry = results[key];
                                obj[key] = entry && Object.prototype.hasOwnProperty.call(entry, 'value') ? entry.value : entry ?? null;
                            });
                            return obj;
                        }
                        keys.forEach((key) => { obj[key] = null; });
                        return obj;
                    } catch (e) {
                        console.warn('[Storage] KV failed, using localStorage:', e.message);
                        useKvStorage = false;
                    }
                }
                // localStorage fallback
                const obj = {};
                keys.forEach(key => {
                    obj[key] = localStorage.getItem(key);
                });
                return obj;
            }
        };

        function safeParseJSON(str) {
            try { return JSON.parse(str); } catch (e) { return null; }
        }

        async function getInProgressState() {
            try {
                const { value } = await storage.get(INPROGRESS_KEY);
                if (!value) return null;
                const obj = safeParseJSON(value);
                if (!obj || typeof obj !== 'object') return null;
                return obj;
            } catch (e) {
                return null;
            }
        }

        async function clearInProgress() {
            try { await storage.delete(INPROGRESS_KEY); } catch (e) {}
        }

        // Save only when level NOT finished
        async function saveInProgress(reason) {
            if (!gameScreen.classList.contains('active')) return;

            const level = LEVELS[currentLevelIndex];
            if (!level) return;

            if (foundCount >= items.length) {
                await clearInProgress();
                return;
            }

            const foundNames = items
                .filter(it => it.dataset.found === 'true')
                .map(it => String(it.dataset.name || ''));

            const nothingToSave =
                foundNames.length === 0 &&
                lives === maxLives &&
                hintsLeft === maxHints &&
                adRevivesLeft === MAX_AD_REVIVES_PER_LEVEL &&
                !gameOver;

            if (nothingToSave) {
                await clearInProgress();
                return;
            }

            const payload = {
                version: 1,
                savedAt: Date.now(),
                reason: reason || 'manual',
                levelId: level.id,
                levelKey: level.key,
                levelIndex: currentLevelIndex,

                foundNames,
                lives,
                hintsLeft,
                adRevivesLeft,
                gameOver: !!gameOver
            };

            try { await storage.set(INPROGRESS_KEY, JSON.stringify(payload)); } catch (e) {}
        }

        async function hasInProgressForLevel(levelIndex) {
            const st = await getInProgressState();
            if (!st) return false;
            const lvl = LEVELS[levelIndex];
            if (!lvl) return false;
            return st.levelId === lvl.id && st.levelKey === lvl.key;
        }

        // Apply saved state AFTER buildLevel has created items + carousel
        async function restoreInProgressIfAny(levelIndex) {
            const st = await getInProgressState();
            const lvl = LEVELS[levelIndex];
            if (!st || !lvl) return false;

            if (st.levelId !== lvl.id || st.levelKey !== lvl.key) return false;

            const foundSet = new Set(Array.isArray(st.foundNames) ? st.foundNames : []);
            const savedLives = Number.isFinite(st.lives) ? Math.max(0, Math.min(maxLives, st.lives)) : maxLives;
            const savedHints = Number.isFinite(st.hintsLeft) ? Math.max(0, Math.min(maxHints, st.hintsLeft)) : maxHints;
            const savedAdRevives = Number.isFinite(st.adRevivesLeft) ? Math.max(0, Math.min(MAX_AD_REVIVES_PER_LEVEL, st.adRevivesLeft)) : MAX_AD_REVIVES_PER_LEVEL;

            foundCount = 0;
            lives = savedLives;
            hintsLeft = savedHints;
            adRevivesLeft = savedAdRevives;
            gameOver = !!st.gameOver;

            overlay.classList.remove('visible', 'win', 'lose');
            if (reviveBtn) reviveBtn.style.display = 'none';

            items.forEach(item => {
                item.classList.remove('hint-highlight');
                const isFound = foundSet.has(String(item.dataset.name || ''));
                item.dataset.found = isFound ? 'true' : 'false';

                if (isFound) {
                    foundCount++;
                    item.style.opacity = '0';
                    item.style.transform = 'scale(0.8)';
                    item.style.pointerEvents = 'none';
                    if (item._carouselItem) item._carouselItem.classList.add('found');
                } else {
                    item.style.opacity = '1';
                    item.style.transform = '';
                    item.style.pointerEvents = gameOver ? 'none' : 'auto';
                    if (item._carouselItem) item._carouselItem.classList.remove('found');
                }
            });

            foundCountEl.textContent = String(foundCount);
            totalCountEl.textContent = String(items.length);

            updateLivesUI();
            updateHintUI();
            updateScoreUI();
            updateGameLevelLabel();

            return true;
        }

        function setActiveScreen(screenEl) {
            [splashScreen, tutorialScreen, menuScreen, gameScreen, scoreScreen].forEach(el => {
                if (!el) return;
                el.classList.toggle('active', el === screenEl);
            });

            requestAnimationFrame(() => {
                layoutItems();
                layoutTutorialItems();
            });
        }

        function stopCurrentMusic() {
            if (currentMusic) {
                try { currentMusic.pause(); } catch (e) {}
            }
        }

        function getLevelMusic(levelIndex) {
            return getAudio('levelMusic');
        }

        function startMenuMusic() {
            if (!musicEnabled) return;
            const menuMusic = getAudio('menuMusic');
            if (currentMusic && currentMusic !== menuMusic) {
                try { currentMusic.pause(); } catch (e) {}
            }
            currentMusic = menuMusic;
            if (menuMusic && menuMusic.paused) {
                menuMusic.play().catch(() => {});
            }
        }

        function startLevelMusic(index) {
            if (!musicEnabled) return;
            const m = getLevelMusic(index);
            if (!m) return;
            if (currentMusic && currentMusic !== m) {
                try { currentMusic.pause(); } catch (e) {}
            }
            currentMusic = m;
            if (m.paused) {
                m.play().catch(() => {});
            }
        }

        async function loadScore() {
            try {
                const { value } = await storage.get(SCORE_KEY);
                if (value !== null) {
                    const n = parseInt(value, 10);
                    if (Number.isFinite(n) && n >= 0) totalScore = n;
                }
            } catch (e) { totalScore = 0; }
        }

        async function saveScore() {
            try { await storage.set(SCORE_KEY, String(totalScore)); } catch (e) {}
            saveGameState().catch(() => {});
        }

        // ===== GAMESTATE via SDK =====
        async function loadGameState() {
            try {
                const result = await coreSDK.gamestate.get();
                const meta = result && result.meta;
                if (meta && typeof meta === 'object') {
                    if (Number.isFinite(meta.maxUnlockedLevel))
                        maxUnlockedLevel = Math.min(Math.max(1, meta.maxUnlockedLevel), LEVELS.length);
                    if (Number.isFinite(meta.totalScore) && meta.totalScore >= 0)
                        totalScore = meta.totalScore;
                    if (meta.soundEnabled !== undefined)
                        soundEnabled = !!meta.soundEnabled;
                    if (meta.musicEnabled !== undefined)
                        musicEnabled = !!meta.musicEnabled;
                }
                console.log('[GameState] Loaded:', { maxUnlockedLevel, totalScore, soundEnabled, musicEnabled });
            } catch (e) {
                console.warn('[GameState] load failed, KV fallback:', e.message);
                return false;
            }
            return true;
        }

        async function saveGameState() {
            try {
                await coreSDK.gamestate.update({
                    maxUnlockedLevel,
                    totalScore,
                    soundEnabled,
                    musicEnabled
                });
                console.log('[GameState] Saved:', { maxUnlockedLevel, totalScore, soundEnabled, musicEnabled });
            } catch (e) {
                console.warn('[GameState] save failed, KV fallback:', e.message);
                try { await storage.set(PROGRESS_KEY, String(maxUnlockedLevel)); } catch (_) {}
                try { await storage.set(SCORE_KEY, String(totalScore)); } catch (_) {}
            }
        }

        // âœ… scoreboard (includes current player)
        function getStubPlayers(){
            return [
                { name: 'Alice', avatar: 'A', score: 0 },
                { name: 'Bob',   avatar: 'B', score: 0 },
                { name: 'Carol', avatar: 'C', score: 0 },
                { name: 'Dan',   avatar: 'D', score: 0 }
            ];
        }

        function getMyPlayerEntry(){
            const name = (playerName || 'Player').trim();
            const initial = name.charAt(0).toUpperCase() || 'P';
            return { name, avatar: initial, score: totalScore, isMe: true };
        }

        function renderScoreboard(){
            if (!scoreboardPlayersEl) return;

            const my = getMyPlayerEntry();
            const others = getStubPlayers();

            const normalizedMy = my.name.toLowerCase();
            const merged = [my, ...others.filter(p => (p.name || '').toLowerCase() !== normalizedMy)];

            merged.sort((a,b) => (b.score||0) - (a.score||0));

            scoreboardPlayersEl.innerHTML = '';

            merged.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'scoreboard-player-card' + (p.isMe ? ' is-me' : '');

                const left = document.createElement('div');
                left.className = 'left';

                const rank = document.createElement('div');
                rank.className = 'scoreboard-rank';
                rank.textContent = String(idx + 1);

                const info = document.createElement('div');
                info.className = 'player-info';

                const av = document.createElement('div');
                av.className = 'player-avatar';

                if (p.isMe && playerAvatarSymbol && playerAvatarSymbol.startsWith('data:image/')) {
                    av.style.backgroundImage = 'url(' + playerAvatarSymbol + ')';
                    av.textContent = '';
                } else {
                    av.style.backgroundImage = '';
                    av.textContent = (p.avatar || 'P').toUpperCase();
                }

                const nm = document.createElement('div');
                nm.className = 'player-name';
                nm.textContent = p.name + (p.isMe ? ' (you)' : '');

                info.appendChild(av);
                info.appendChild(nm);

                left.appendChild(rank);
                left.appendChild(info);

                const score = document.createElement('div');
                score.className = 'scoreboard-score';
                score.textContent = String(p.score || 0);

                card.appendChild(left);
                card.appendChild(score);

                scoreboardPlayersEl.appendChild(card);
            });
        }

        function updateScoreUI() {
            if (scoreValueTutorial) scoreValueTutorial.textContent = totalScore;
            if (scoreValueGame)     scoreValueGame.textContent     = totalScore;
            if (scoreTotalValueEl)  scoreTotalValueEl.textContent  = totalScore;
            if (menuScoreValue)     menuScoreValue.textContent     = totalScore;
            if (winScoreValueEl)    winScoreValueEl.textContent    = totalScore;
            if (profileScoreValue)  profileScoreValue.textContent  = totalScore;
            renderScoreboard();
        }

        function addScore(points) {
            totalScore += points;
            updateScoreUI();
            saveScore().catch(() => {});
        }

        function deriveNameFromEmail(email) {
            if (!email) return 'Player';
            const before = email.split('@')[0] || 'Player';
            return before.charAt(0).toUpperCase() + before.slice(1);
        }

        function updatePlayerUI() {
            const name = playerName || 'Player';
            const fallbackInitial = name.trim().charAt(0).toUpperCase() || 'P';
            const avatarSource = playerAvatarSymbol;

            function applyAvatar(el) {
                if (!el) return;
                el.style.backgroundImage = '';
                if (avatarSource && avatarSource.startsWith('data:image/')) {
                    el.style.backgroundImage = 'url(' + avatarSource + ')';
                    el.textContent = '';
                } else {
                    el.textContent = avatarSource || fallbackInitial;
                }
            }

            applyAvatar(loginAvatar);
            if (loginPlayerNameLabel) loginPlayerNameLabel.textContent = name;

            applyAvatar(menuPlayerAvatar);
            if (menuPlayerName) menuPlayerName.textContent = name;

            applyAvatar(gamePlayerAvatar);
            if (gamePlayerName) gamePlayerName.textContent = name;

            applyAvatar(profileAvatar);
            if (profileNameEl) profileNameEl.textContent = name;

            applyAvatar(winPlayerAvatar);
            if (winPlayerNameEl) winPlayerNameEl.textContent = name;

            applyAvatar(scorePlayerAvatar);
            if (scorePlayerName) scorePlayerName.textContent = name;

            renderScoreboard();
        }

        async function loadPlayerFromStorage() {
            try {
                const data = await storage.getMany([
                    PLAYER_NAME_KEY,
                    PLAYER_EMAIL_KEY,
                    PLAYER_AVATAR_KEY,
                    AUTH_TYPE_KEY
                ]);

                if (data[PLAYER_NAME_KEY]) playerName = data[PLAYER_NAME_KEY];
                if (data[PLAYER_EMAIL_KEY]) playerEmail = data[PLAYER_EMAIL_KEY];
                if (data[PLAYER_AVATAR_KEY]) playerAvatarSymbol = data[PLAYER_AVATAR_KEY];
                if (data[AUTH_TYPE_KEY]) authTypeLocal = data[AUTH_TYPE_KEY];
            } catch (e) {}
        }

        async function setAuthTypeLocal(type) {
            authTypeLocal = type;
            try { await storage.set(AUTH_TYPE_KEY, type); } catch (e) {}
        }

        function showLoginOverlay() {
            authMode = 'login';
            applyAuthMode();
            loginEmailInput.value = playerEmail || '';
            loginPasswordInput.value = '';
            registerNameInput.value = '';
            loginErrorText.textContent = '';
            loginOverlay.classList.add('visible');
            document.body.classList.add('login-active');
        }

        function hideLoginOverlay() {
            loginOverlay.classList.remove('visible');
            document.body.classList.remove('login-active');
        }

        // Tutorial done logic (global, once per install)
        const TUTORIAL_DONE_KEY = 'findit_tutorial_done_global';

        async function hasUserCompletedTutorial() {
            try {
                const local = localStorage.getItem(TUTORIAL_DONE_KEY);
                if (local === 'true') return true;
            } catch (_) {}
            try {
                const { value } = await storage.get(TUTORIAL_DONE_KEY);
                if (value === 'true') {
                    try { localStorage.setItem(TUTORIAL_DONE_KEY, 'true'); } catch (_) {}
                    return true;
                }
            } catch(e) {}
            return false;
        }

        async function markUserCompletedTutorial() {
            try { localStorage.setItem(TUTORIAL_DONE_KEY, 'true'); } catch (_) {}
            try { await storage.set(TUTORIAL_DONE_KEY, 'true'); } catch(e) {}
        }

        async function goAfterLogin() {
            if (await hasUserCompletedTutorial()) {
                setActiveScreen(menuScreen);
                applyLevelInfoToMenu(currentLevelIndex);
                updateScoreUI();
                updatePlayerUI();
                startMenuMusic();
                return;
            }
            initTutorial();
        }

        async function performLogin(email, password) {
            loginErrorText.textContent = '';

            if (!email || !password) {
                loginErrorText.textContent = 'Enter email and password.';
                return;
            }

            let storedEmail = null;
            let storedPassword = null;
            let storedName = null;
            let storedAvatar = null;

            try {
                const data = await storage.getMany([PLAYER_EMAIL_KEY, PLAYER_PASSWORD_KEY, PLAYER_NAME_KEY, PLAYER_AVATAR_KEY]);
                storedEmail = data[PLAYER_EMAIL_KEY];
                storedPassword = data[PLAYER_PASSWORD_KEY];
                storedName = data[PLAYER_NAME_KEY];
                storedAvatar = data[PLAYER_AVATAR_KEY];
            } catch (e) {}

            if (storedEmail && storedPassword && email === storedEmail && password === storedPassword) {
                playerEmail = storedEmail;
                playerName  = storedName || deriveNameFromEmail(storedEmail);
                playerAvatarSymbol = storedAvatar || '';
                updatePlayerUI();
                hideLoginOverlay();
                goAfterLogin().catch(() => {});
                return;
            }

            if (email === 'admin@gmail.com' && password === 'admin') {
                playerEmail = email;
                playerName  = deriveNameFromEmail(email);
                playerAvatarSymbol = '';
                updatePlayerUI();
                hideLoginOverlay();
                goAfterLogin().catch(() => {});
                return;
            }

            loginErrorText.textContent = 'Invalid credentials.';
        }

        async function performRegistration(nameInput, email, password) {
            loginErrorText.textContent = '';

            if (!email || !password) {
                loginErrorText.textContent = 'Enter email and password.';
                return;
            }

            const name = nameInput || deriveNameFromEmail(email);
            const avatar = playerAvatarSymbol || '';

            try {
                await storage.set(PLAYER_EMAIL_KEY, email);
                await storage.set(PLAYER_PASSWORD_KEY, password);
                await storage.set(PLAYER_NAME_KEY, name);
                await storage.set(PLAYER_AVATAR_KEY, avatar);
            } catch (e) {}

            playerEmail = email;
            playerName = name;
            playerAvatarSymbol = avatar;

            updatePlayerUI();
            hideLoginOverlay();
            goAfterLogin();
        }

        function applyAuthMode() {
            if (loginTitleEl) loginTitleEl.textContent = 'Sign up';
            if (loginSubtitleEl) loginSubtitleEl.textContent = 'Choose how you want to continue.';
            if (registerNameField) registerNameField.style.display = 'none';
            if (loginSubmitBtn) loginSubmitBtn.style.display = 'none';
            if (switchAuthModeBtn) switchAuthModeBtn.style.display = 'none';
            if (loginAvatarRow) loginAvatarRow.style.display = 'none';
            if (loginAutofillBtn) loginAutofillBtn.style.display = 'flex';
            if (loginGoogleBtn) loginGoogleBtn.style.display = 'flex';
        }

        // Boot flow
        setTimeout(() => {
            (async () => {
                await ensureGuestAuth();
                applyAuthUI();
                updatePlayerUI();

                if (await hasUserCompletedTutorial()) {
                    setActiveScreen(menuScreen);
                    applyLevelInfoToMenu(currentLevelIndex);
                    updateScoreUI();
                    startMenuMusic();
                } else {
                    setActiveScreen(tutorialScreen);
                    initTutorial();
                }
            })().catch(() => {});
        }, 1500);

        function applyLevelInfoToMenu(index) {
            const level = LEVELS[index];
            menuLevelLabel.textContent = `Level ${level.id}`;
            menuLevelTitle.textContent = level.menuTitle;
            menuLevelDesc.textContent  = level.menuDescription;
            if (menuLevelNumber) menuLevelNumber.textContent = level.id;
        }

        async function setSoundEnabled(value) {
            soundEnabled = value;
            if (soundToggle) soundToggle.checked = soundEnabled;
            try { await storage.set(SOUND_KEY, String(soundEnabled)); } catch (e) {}
            saveGameState().catch(() => {});
        }

        async function setMusicEnabled(value) {
            musicEnabled = value;
            if (musicToggle) musicToggle.checked = musicEnabled;
            try { await storage.set(MUSIC_KEY, String(musicEnabled)); } catch (e) {}
            saveGameState().catch(() => {});

            if (!musicEnabled) {
                stopCurrentMusic();
            } else {
                if (menuScreen.classList.contains('active') || scoreScreen.classList.contains('active')) {
                    startMenuMusic();
                } else if (gameScreen.classList.contains('active')) {
                    startLevelMusic(currentLevelIndex);
                }
            }
        }

        function playSound(key) {
            if (!soundEnabled || !key) return;
            const audio = getAudio(key);
            if (!audio) return;
            try { audio.currentTime = 0; audio.play().catch(() => {}); } catch (e) {}
        }

        // Rewarded Ad Stub
        function showRewardedAdStub({ title, text, onReward }) {
            pendingAdReward = (typeof onReward === 'function') ? onReward : null;
            if (adTitleEl) adTitleEl.textContent = title || 'Ad';
            if (adTextEl)  adTextEl.textContent  = text  || 'Ad stub';
            if (adOverlay) adOverlay.classList.add('visible');
        }

        function hideRewardedAdStub() {
            if (adOverlay) adOverlay.classList.remove('visible');
            pendingAdReward = null;
        }

        adCancelBtn && adCancelBtn.addEventListener('click', () => hideRewardedAdStub());
        adRewardBtn && adRewardBtn.addEventListener('click', () => {
            const cb = pendingAdReward;
            hideRewardedAdStub();
            if (typeof cb === 'function') cb();
        });

        adOverlay && adOverlay.addEventListener('click', (e) => {
            if (!e.target.closest('.ad-dialog')) hideRewardedAdStub();
        });

        function updateLivesUI() {
            livesHearts.textContent = lives;
        }

        function updateHintUI() {
            hintButton.dataset.hints = hintsLeft;
            hintButton.disabled = gameOver || settingsOverlay.classList.contains('visible');
            if (hintBadge) hintBadge.textContent = hintsLeft;
            if (hintBtnNew) hintBtnNew.disabled = gameOver || settingsOverlay.classList.contains('visible');
        }

        function updateGameLevelLabel(){
            if (!hudLevelValue) return;
            const lvl = LEVELS[currentLevelIndex];
            hudLevelValue.textContent = lvl ? `Level ${lvl.id}` : 'Level';
        }

        // contain mapping
        function getContainMapping(containerEl, bgW, bgH) {
            const cw = containerEl.clientWidth;
            const ch = containerEl.clientHeight;
            if (!cw || !ch) return { scale: 1, offsetX: 0, offsetY: 0, renderW: cw, renderH: ch };

            const scale = Math.min(cw / bgW, ch / bgH);
            const renderW = bgW * scale;
            const renderH = bgH * scale;
            const offsetX = (cw - renderW) / 2;
            const offsetY = (ch - renderH) / 2;

            return { scale, offsetX, offsetY, renderW, renderH };
        }

        function layoutItems() {
            if (!items || items.length === 0) return;

            const map = getContainMapping(game, BG_WIDTH, BG_HEIGHT);

            items.forEach(item => {
                const x = parseFloat(item.dataset.x) || 0;
                const y = parseFloat(item.dataset.y) || 0;
                const w = parseFloat(item.dataset.w) || 150;
                const h = parseFloat(item.dataset.h) || 150;

                item.style.left   = (map.offsetX + x * map.scale) + 'px';
                item.style.top    = (map.offsetY + y * map.scale) + 'px';
                item.style.width  = (w * map.scale) + 'px';
                item.style.height = (h * map.scale) + 'px';
            });
        }

        function initGameLayout() {
            game.style.aspectRatio = BG_WIDTH + ' / ' + BG_HEIGHT;
            layoutItems();
        }

        if (bg.complete) initGameLayout();
        else bg.addEventListener('load', initGameLayout);

        function layoutTutorialItems() {
            const map = getContainMapping(tutorialGame, BG_WIDTH, BG_HEIGHT);

            tutorialItems.forEach(item => {
                const x = parseFloat(item.dataset.x) || 0;
                const y = parseFloat(item.dataset.y) || 0;
                const w = parseFloat(item.dataset.w) || 150;
                const h = parseFloat(item.dataset.h) || 150;

                item.style.left   = (map.offsetX + x * map.scale) + 'px';
                item.style.top    = (map.offsetY + y * map.scale) + 'px';
                item.style.width  = (w * map.scale) + 'px';
                item.style.height = (h * map.scale) + 'px';
            });
        }

        function initTutorialLayout() {
            tutorialGame.style.aspectRatio = BG_WIDTH + ' / ' + BG_HEIGHT;
            layoutTutorialItems();
        }

        if (tutorialBg.complete) initTutorialLayout();
        else tutorialBg.addEventListener('load', initTutorialLayout);

        let resizeRAF;
        window.addEventListener('resize', () => {
            if (resizeRAF) cancelAnimationFrame(resizeRAF);
            resizeRAF = requestAnimationFrame(() => {
                layoutItems();
                layoutTutorialItems();
            });
        });

        async function loadProgress() {
            try {
                const { value } = await storage.get(PROGRESS_KEY);
                if (value !== null) {
                    const n = parseInt(value, 10);
                    if (Number.isFinite(n)) maxUnlockedLevel = Math.min(Math.max(1, n), LEVELS.length);
                }
            } catch (e) { maxUnlockedLevel = 1; }
            currentLevelIndex = maxUnlockedLevel - 1;
        }

        async function saveProgress() {
            try { await storage.set(PROGRESS_KEY, String(maxUnlockedLevel)); } catch (e) {}
            saveGameState().catch(() => {});
        }

        async function unlockLevel(levelNumber) {
            if (levelNumber > maxUnlockedLevel) {
                maxUnlockedLevel = Math.min(levelNumber, LEVELS.length);
                await saveProgress();
            }
        }

        (async function initAllStorage() {
            // Try loading progress from gamestate SDK first
            const gsLoaded = await loadGameState();

            if (!gsLoaded) {
                // Fallback: load from KV storage
                try {
                    const data = await storage.getMany([SOUND_KEY, MUSIC_KEY, PROGRESS_KEY, SCORE_KEY]);

                    soundEnabled = data[SOUND_KEY] === null ? true : data[SOUND_KEY] === 'true';
                    musicEnabled = data[MUSIC_KEY] === null ? true : data[MUSIC_KEY] === 'true';

                    if (data[PROGRESS_KEY] !== null) {
                        const n = parseInt(data[PROGRESS_KEY], 10);
                        if (Number.isFinite(n)) maxUnlockedLevel = Math.min(Math.max(1, n), LEVELS.length);
                    }

                    if (data[SCORE_KEY] !== null) {
                        const n = parseInt(data[SCORE_KEY], 10);
                        if (Number.isFinite(n) && n >= 0) totalScore = n;
                    }
                } catch (e) {
                    soundEnabled = true;
                    musicEnabled = true;
                    maxUnlockedLevel = 1;
                    totalScore = 0;
                }
            } else {
                // Load sound setting from KV as well (in case gamestate doesn't have it yet)
                try {
                    const { value } = await storage.get(SOUND_KEY);
                    if (value !== null) soundEnabled = value === 'true';
                } catch (_) {}
                try {
                    const { value } = await storage.get(MUSIC_KEY);
                    if (value !== null) musicEnabled = value === 'true';
                } catch (_) {}
            }

            currentLevelIndex = maxUnlockedLevel - 1;

            await setSoundEnabled(soundEnabled);
            await setMusicEnabled(musicEnabled);
            await loadPlayerFromStorage();
            applyLevelInfoToMenu(currentLevelIndex);
            updateScoreUI();
            updatePlayerUI();
            updateGameLevelLabel();
        })();

        function buildLevel(levelIndex) {
            const level = LEVELS[levelIndex];
            currentLevelIndex = levelIndex;

            updateGameLevelLabel();

            bg.src = level.bg;

            document.querySelectorAll('.item').forEach(el => el.remove());
            carousel.innerHTML = '';
            items = [];

            level.items.forEach(cfg => {
                const img = document.createElement('img');
                img.className = 'item';
                img.src = cfg.src;
                img.alt = cfg.name;
                img.dataset.name = cfg.name;
                img.dataset.x = cfg.x;
                img.dataset.y = cfg.y;
                img.dataset.w = cfg.w;
                img.dataset.h = cfg.h;
                img.draggable = false;

                game.appendChild(img);
                items.push(img);

                const slide = document.createElement('div');
                slide.className = 'carousel-item';

                const icon = document.createElement('img');
                icon.className = 'carousel-icon';
                icon.src = cfg.src;
                icon.alt = cfg.name;

                const label = document.createElement('div');
                label.className = 'carousel-label';
                label.textContent = cfg.name;

                slide.appendChild(icon);
                slide.appendChild(label);

                img._carouselItem = slide;
                carousel.appendChild(slide);
            });

            totalCountEl.textContent = items.length;
            layoutItems();
        }

        const overlayIcon = document.getElementById('overlayIcon');
        const adPlayIcon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="margin-right:6px;flex-shrink:0"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><polygon points="10,8 16,12 10,16" fill="currentColor"/></svg>';
        const refreshIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px;flex-shrink:0"><path d="M1 4v6h6M23 20v-6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        const heartSvg = '<svg width="80" height="80" viewBox="0 0 80 80" fill="none"><path d="M40 70s-28-16.8-28-35c0-9.94 7.06-18 16-18 5.94 0 9.92 3.2 12 6.4C42.08 20.2 46.06 17 52 17c8.94 0 16 8.06 16 18 0 18.2-28 35-28 35z" fill="#ff4a6e"/><path d="M40 70s-28-16.8-28-35c0-9.94 7.06-18 16-18 5.94 0 9.92 3.2 12 6.4" fill="#ff6b8a" opacity="0.6"/></svg>';
        const trophySvg = '<svg width="80" height="80" viewBox="0 0 80 80" fill="none"><path d="M24 16h32v20c0 8.84-7.16 16-16 16s-16-7.16-16-16V16z" fill="#FFD43B"/><path d="M24 16h32v20c0 8.84-7.16 16-16 16" fill="#FFE066" opacity="0.6"/><rect x="34" y="52" width="12" height="8" rx="2" fill="#FFD43B"/><rect x="28" y="58" width="24" height="6" rx="3" fill="#FFD43B"/><path d="M24 20H14c0 8 6 14 14 14v-4c-4 0-8-4-8-10h4z" fill="#FFD43B" opacity="0.7"/><path d="M56 20h10c0 8-6 14-14 14v-4c4 0 8-4 8-10h-4z" fill="#FFD43B" opacity="0.7"/></svg>';

        function updateWinImage() {
            if (!winImageEl) return;
            const level = LEVELS[currentLevelIndex];
            const url = (level && level.bg) ? level.bg : (bg ? bg.src : '');
            if (url) winImageEl.style.backgroundImage = 'url(' + url + ')';
        }

        function showOverlay(title, text, type) {
            overlayTitle.textContent = title;
            overlayText.textContent  = text;
            if (winTitleEl) winTitleEl.textContent = title;
            overlay.classList.remove('win', 'lose');
            overlay.classList.add('visible');

            if (type === 'lose') {
                overlay.classList.add('lose');
                playSound(soundLose);
                overlayMode = 'restart';
                overlayIcon.innerHTML = heartSvg;
                overlayIcon.style.display = '';
                restartBtn.innerHTML = refreshIcon + 'Restart';

                if (reviveBtn) {
                    reviveBtn.style.display = (adRevivesLeft > 0) ? 'flex' : 'none';
                    reviveBtn.innerHTML = adPlayIcon + `Get 3 lives`;
                }

            } else if (type === 'win') {
                if (reviveBtn) reviveBtn.style.display = 'none';
                overlayIcon.innerHTML = trophySvg;
                overlayIcon.style.display = '';

                const isLast = (currentLevelIndex === LEVELS.length - 1);
                const nextLabel = isLast ? 'Play again' : 'Next level';

                if (isLast) {
                    overlayMode = 'restart';
                    restartBtn.innerHTML = refreshIcon + 'Play again';
                } else {
                    overlayMode = 'next-level';
                    restartBtn.innerHTML = 'â–¶ Next level';
                }

                if (winNextBtn) winNextBtn.textContent = nextLabel;
                updateWinImage();

                overlay.classList.add('win');
                playSound(soundWin);
            }

            gameOver = true;
            items.forEach(item => item.style.pointerEvents = 'none');
            updateHintUI();
        }

        function showMissMarker(evt) {
            const rect = game.getBoundingClientRect();
            const x = evt.clientX - rect.left;
            const y = evt.clientY - rect.top;

            const marker = document.createElement('div');
            marker.className = 'miss-marker';
            marker.style.left = x + 'px';
            marker.style.top  = y + 'px';

            game.appendChild(marker);

            requestAnimationFrame(() => marker.classList.add('visible'));

            setTimeout(() => { marker.remove(); }, 400);
        }

        function resetLevelState() {
            foundCount = 0;
            lives      = maxLives;
            hintsLeft  = maxHints;
            gameOver   = false;

            adRevivesLeft = MAX_AD_REVIVES_PER_LEVEL;
            if (reviveBtn) reviveBtn.style.display = 'none';

            foundCountEl.textContent = '0';
            totalCountEl.textContent = items.length;

            updateLivesUI();
            updateHintUI();
            updateScoreUI();
            updateGameLevelLabel();

            overlay.classList.remove('visible', 'win', 'lose');

            items.forEach(item => {
                item.dataset.found = 'false';
                item.style.opacity = '1';
                item.style.transform = '';
                item.style.pointerEvents = 'auto';
                item.classList.remove('hint-highlight');
            });

            carousel.querySelectorAll('.carousel-item').forEach(slide => slide.classList.remove('found'));
        }

        // Event delegation for item clicks
        game.addEventListener('click', (e) => {
            const item = e.target.closest('.item');
            if (!item) return;
            onItemClick(item);
        });

        function onItemClick(item) {
            if (gameOver) return;
            if (settingsOverlay.classList.contains('visible')) return;
            if (item.dataset.found === 'true') return;

            item.dataset.found = 'true';
            foundCount++;
            foundCountEl.textContent = foundCount;

            playSound(soundHit);
            addScore(10);

            item.style.opacity = '0';
            item.style.transform = 'scale(0.8)';
            item.style.pointerEvents = 'none';

            if (item._carouselItem) item._carouselItem.classList.add('found');

            saveInProgress('found').catch(() => {});

            if (foundCount === items.length) {
                unlockLevel(currentLevelIndex + 2).catch(() => {});
                saveProgress().catch(() => {});
                clearInProgress().catch(() => {});

                setTimeout(() => {
                    const isLast = (currentLevelIndex === LEVELS.length - 1);
                    if (isLast) {
                        showOverlay('You found everything! ðŸŽ‰', 'Great job! All objects have been collected.', 'win');
                    } else {
                        const nextLevel = LEVELS[currentLevelIndex + 1];
                        showOverlay(
                            `Level ${LEVELS[currentLevelIndex].id} complete!`,
                            `Next level "${nextLevel.menuTitle}" unlocked.`,
                            'win'
                        );
                    }
                }, 250);
            }
        }

        game.addEventListener('click', (evt) => {
            if (gameOver) return;
            if (settingsOverlay.classList.contains('visible')) return;
            if (evt.target.classList.contains('item')) return;
            if (evt.target.closest('.overlay')) return;
            if (evt.target.closest('.settings-overlay')) return;
            if (evt.target === menuButton || evt.target === hintButton) return;

            lives--;
            updateLivesUI();
            showMissMarker(evt);
            playSound(soundMiss);

            saveInProgress('miss').catch(() => {});

            if (lives <= 0) {
                showOverlay('You need more lives', '', 'lose');
                saveInProgress('lose').catch(() => {});
            }
        });

        // Revive (extra life) via ad stub
        reviveBtn && reviveBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!gameOver) return;
            if (adRevivesLeft <= 0) return;

            showRewardedAd(() => {
                adRevivesLeft = Math.max(0, adRevivesLeft - 1);

                lives = 1;
                updateLivesUI();

                gameOver = false;
                overlay.classList.remove('visible', 'win', 'lose');

                items.forEach(item => {
                    if (item.dataset.found !== 'true') item.style.pointerEvents = 'auto';
                });

                updateHintUI();

                if (reviveBtn) {
                    reviveBtn.style.display = (adRevivesLeft > 0) ? 'block' : 'none';
                    reviveBtn.textContent = `Watch ad â€” get +1 life (${adRevivesLeft})`;
                }

                saveInProgress('revive').catch(() => {});
            });
        });

        async function handleRestartAction() {
            clearInProgress().catch(() => {});

            if (overlayMode === 'next-level' && currentLevelIndex < LEVELS.length - 1) {
                await showInterstitialAd();
                currentLevelIndex++;
                applyLevelInfoToMenu(currentLevelIndex);
                buildLevel(currentLevelIndex);
                resetLevelState();
                startLevelMusic(currentLevelIndex);
                requestAnimationFrame(layoutItems);
            } else {
                resetLevelState();
                startLevelMusic(currentLevelIndex);
                requestAnimationFrame(layoutItems);
            }
        }

        restartBtn && restartBtn.addEventListener('click', handleRestartAction);
        winNextBtn && winNextBtn.addEventListener('click', handleRestartAction);

        // ===== EDIT PROFILE =====
        let editProfilePendingAvatar = null;

        function openEditProfile() {
            const status = getCurrentAuthStatus();
            if (!status || status.authType !== 'google') return;
            editProfileNameInput.value = playerName || '';
            editProfilePendingAvatar = null;
            if (playerAvatarSymbol && playerAvatarSymbol.startsWith('data:image/')) {
                editProfileAvatarEl.style.backgroundImage = 'url(' + playerAvatarSymbol + ')';
                editProfileAvatarEl.textContent = '';
            } else {
                editProfileAvatarEl.style.backgroundImage = '';
                editProfileAvatarEl.textContent = (playerName || 'P').charAt(0).toUpperCase();
            }
            if (profileOverlay) profileOverlay.classList.remove('visible');
            editProfileOverlay.classList.add('visible');
            setTimeout(() => editProfileNameInput.focus(), 300);
        }

        function closeEditProfile() {
            editProfileOverlay.classList.remove('visible');
            editProfilePendingAvatar = null;
        }

        async function saveEditProfile() {
            const newName = editProfileNameInput.value.trim();
            if (!newName) {
                editProfileNameInput.focus();
                return;
            }
            editProfileSaveBtn.disabled = true;
            editProfileSaveBtn.textContent = 'Saving...';

            try {
                await coreSDK.profile.update({ base: { name: newName } });
                console.log('[Profile] SDK update success:', newName);
            } catch (e) {
                console.warn('[Profile] SDK update failed, KV only:', e.message);
            }

            playerName = newName;
            try { await storage.set(PLAYER_NAME_KEY, newName); } catch (_) {}

            if (editProfilePendingAvatar) {
                playerAvatarSymbol = editProfilePendingAvatar;
                try { await storage.set(PLAYER_AVATAR_KEY, editProfilePendingAvatar); } catch (_) {}
            }

            updatePlayerUI();
            closeEditProfile();

            editProfileSaveBtn.disabled = false;
            editProfileSaveBtn.textContent = 'Save changes';
        }

        // ===== AUTH FUNCTIONS =====
        function getCurrentAuthStatus() {
            const hasAuth = !!(coreSDK?.systemParams && coreSDK.systemParams.authToken);
            let type = hasAuth ? authTypeLocal : null;
            // If we have an auth token but no stored type, treat it as Guest by default.
            if (hasAuth && !type) type = 'guest';
            return {
                isAuthenticated: hasAuth,
                authType: type,
                isAnonymous: type === 'guest'
            };
        }

        function updateMenuProfileUI(status) {
            const loggedIn = !!(status && status.isAuthenticated && status.authType === 'google');
            if (menuLoginIcon) menuLoginIcon.style.display = loggedIn ? 'none' : 'grid';
            if (menuPlayerInfo) menuPlayerInfo.style.display = loggedIn ? 'flex' : 'none';
        }

        function applyAuthUI() {
            const status = getCurrentAuthStatus();
            const isGuest = !!(status && status.isAuthenticated && status.authType === 'guest');
            const isGoogle = !!(status && status.isAuthenticated && status.authType === 'google');

            // Guest button: show for guests or unauthenticated (allows staying guest)
            const showGuest = !status || !status.isAuthenticated || isGuest;
            // Google button: show if not authenticated OR if guest (can upgrade)
            const showGoogle = !status || !status.isAuthenticated || isGuest;
            // Logout button: only for Google users
            const showLogout = isGoogle;

            if (settingsAccountGuest) settingsAccountGuest.style.display = showLogout ? 'none' : 'flex';
            if (settingsAccountLogged) settingsAccountLogged.style.display = showLogout ? 'flex' : 'none';

            loginGuestButton.style.display = showGuest ? 'flex' : 'none';
            loginGoogleButton.style.display = showGoogle ? 'flex' : 'none';
            logoutButton.style.display = showLogout ? 'flex' : 'none';
            updateMenuProfileUI(status);

            // Update status message
            let message = 'Not logged in';
            if (status && status.isAuthenticated) {
                if (isGoogle) {
                    message = 'Logged in with Google';
                    authStatusEl.classList.add('logged-in');
                } else if (isGuest || status.isAnonymous) {
                    message = 'Logged in as Guest. You can upgrade to Google.';
                    authStatusEl.classList.add('logged-in');
                } else {
                    message = `Logged in (${status.authType || 'unknown'})`;
                    authStatusEl.classList.add('logged-in');
                }
            } else {
                authStatusEl.classList.remove('logged-in');
            }
            authStatusEl.textContent = message;

            if (profileEditBtn) profileEditBtn.style.display = isGoogle ? '' : 'none';
            if (profileLogoutBtn) profileLogoutBtn.style.display = isGoogle ? '' : 'none';
        }

        function setAuthLoading(isLoading) {
            loginGuestButton.disabled = isLoading;
            loginGoogleButton.disabled = isLoading;
            logoutButton.disabled = isLoading;
            if (isLoading) {
                authStatusEl.textContent = 'Loading...';
            }
        }

        async function ensureGuestAuth() {
            if (!authTypeLocal) {
                try {
                    const { value } = await storage.get(AUTH_TYPE_KEY);
                    if (value) authTypeLocal = value;
                } catch (_) {}
            }

            const status = getCurrentAuthStatus();
            if (status && status.isAuthenticated) {
                if (!authTypeLocal) await setAuthTypeLocal('guest');
                return getCurrentAuthStatus();
            }
            try {
                await coreSDK.loginAsGuest();
                await setAuthTypeLocal('guest');
                if (!playerName || playerName === 'Player') {
                    playerName = 'Guest';
                    try { await storage.set(PLAYER_NAME_KEY, playerName); } catch (_) {}
                }
                updatePlayerUI();
            } catch (err) {
                console.error('Guest login error:', err);
            }
            return getCurrentAuthStatus();
        }

        async function handleGuestLogin() {
            try {
                setAuthLoading(true);
                await coreSDK.loginAsGuest();
                await setAuthTypeLocal('guest');
                if (!playerName || playerName === 'Player') {
                    playerName = 'Guest';
                    try { await storage.set(PLAYER_NAME_KEY, playerName); } catch (_) {}
                }
                updatePlayerUI();
                applyAuthUI();
            } catch (err) {
                console.error('Guest login error:', err);
                authStatusEl.textContent = 'Login failed';
            } finally {
                setAuthLoading(false);
            }
        }

        async function handleGoogleLogin() {
            try {
                setAuthLoading(true);
                const { credential } = await coreSDK.getGoogleIdToken();
                await coreSDK.loginWithGoogle(credential);
                await setAuthTypeLocal('google');
                applyAuthUI();
            } catch (err) {
                console.error('Google login error:', err);
                authStatusEl.textContent = 'Login failed';
            } finally {
                setAuthLoading(false);
            }
        }

        async function handleLogout() {
            try {
                setAuthLoading(true);
                await coreSDK.logout();
            } catch (err) {
                // 404 means the endpoint isn't implemented yet â€” treat as success and clear locally
                console.warn('[Logout] SDK call failed (probably 404), clearing local auth:', err.message);
            } finally {
                // Always clear auth state locally regardless of server response
                if (coreSDK.systemParams) coreSDK.systemParams.authToken = null;
                setAuthLoading(false);
                await ensureGuestAuth();
                applyAuthUI();
                updatePlayerUI();
            }
        }

        // Auth event listeners
        loginGuestButton.addEventListener('click', handleGuestLogin);
        loginGoogleButton.addEventListener('click', handleGoogleLogin);
        logoutButton.addEventListener('click', handleLogout);

        // Initialize auth UI on load
        applyAuthUI();

        function openSettings(context) {
            settingsOverlay.classList.add('visible');
            settingsOverlay.dataset.context = context;

            if (settingsSectionLinks)   settingsSectionLinks.style.display = 'flex';

            updateHintUI();
        }

        function handleProfileOpen() {
            const status = getCurrentAuthStatus();
            if (status && status.isAuthenticated && status.authType === 'google') {
                if (profileOverlay) profileOverlay.classList.add('visible');
            } else {
                showLoginOverlay();
            }
        }

        winSettingsBtn && winSettingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openSettings('game');
        });

        menuProfileButton && menuProfileButton.addEventListener('click', (e) => {
            e.stopPropagation();
            handleProfileOpen();
        });

        scoreProfileButton && scoreProfileButton.addEventListener('click', (e) => {
            e.stopPropagation();
            handleProfileOpen();
        });

        winPlayerButton && winPlayerButton.addEventListener('click', (e) => {
            e.stopPropagation();
            handleProfileOpen();
        });

        profileOverlay && profileOverlay.addEventListener('click', (e) => {
            if (!e.target.closest('.profile-dialog')) {
                profileOverlay.classList.remove('visible');
            }
        });

        profileEditBtn && profileEditBtn.addEventListener('click', () => {
            openEditProfile();
        });

        profileLogoutBtn && profileLogoutBtn.addEventListener('click', () => {
            handleLogout().catch(() => {});
            if (profileOverlay) profileOverlay.classList.remove('visible');
        });

        // Edit Profile overlay listeners
        editProfileCloseBtn && editProfileCloseBtn.addEventListener('click', closeEditProfile);

        editProfileOverlay && editProfileOverlay.addEventListener('click', (e) => {
            if (!e.target.closest('.edit-profile-panel')) closeEditProfile();
        });

        editProfileSaveBtn && editProfileSaveBtn.addEventListener('click', () => {
            saveEditProfile().catch(() => {});
        });

        editProfileAvatarWrap && editProfileAvatarWrap.addEventListener('click', () => {
            if (editAvatarInput) editAvatarInput.click();
        });

        editAvatarInput && editAvatarInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                editProfilePendingAvatar = ev.target.result;
                editProfileAvatarEl.style.backgroundImage = 'url(' + editProfilePendingAvatar + ')';
                editProfileAvatarEl.textContent = '';
            };
            reader.readAsDataURL(file);
            editAvatarInput.value = '';
        });

        menuButton.addEventListener('click', (e) => { e.stopPropagation(); openSettings('game'); });
        mainSettingsButton.addEventListener('click', (e) => { e.stopPropagation(); openSettings('menu'); });

        settingsCloseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsOverlay.classList.remove('visible');
            updateHintUI();
        });

        settingsOverlay.addEventListener('click', (e) => {
            if (!e.target.closest('.settings-panel')) {
                settingsOverlay.classList.remove('visible');
                updateHintUI();
            }
        });

        if (settingsLinks) {
            settingsLinks.addEventListener('click', (e) => {
                const item = e.target.closest('.settings-link-item');
                if (!item) return;
                const link = item.dataset.link;
                if (link === 'exit') {
                    settingsOverlay.classList.remove('visible');
                    setActiveScreen(menuScreen);
                    applyLevelInfoToMenu(currentLevelIndex);
                    updateScoreUI();
                    startMenuMusic();
                }
            });
        }

        soundToggle && soundToggle.addEventListener('click', () => setSoundEnabled(!soundEnabled).catch(() => {}));
        musicToggle && musicToggle.addEventListener('click', () => setMusicEnabled(!musicEnabled).catch(() => {}));

        // Hint logic (game): if 0 -> show ad stub, reward +1 hint and use immediately
        function useHintNow() {
            if (gameOver) return;
            if (settingsOverlay.classList.contains('visible')) return;
            if (hintsLeft <= 0) return;

            const remaining = items.filter(item => item.dataset.found !== 'true');
            if (remaining.length === 0) return;

            const target = remaining[Math.floor(Math.random() * remaining.length)];
            target.classList.add('hint-highlight');

            hintsLeft--;
            updateHintUI();
            saveInProgress('hint').catch(() => {});

            setTimeout(() => target.classList.remove('hint-highlight'), 1600);
        }

        hintButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (gameOver) return;
            if (settingsOverlay.classList.contains('visible')) return;

            const remaining = items.filter(item => item.dataset.found !== 'true');
            if (remaining.length === 0) return;

            if (hintsLeft <= 0) {
                showRewardedAd(() => {
                    hintsLeft = Math.min(maxHints, hintsLeft + 1);
                    updateHintUI();
                    saveInProgress('ad_hint').catch(() => {});
                    useHintNow();
                });
                return;
            }

            useHintNow();
        });

        // New hint button (below image) â€” delegates to same logic
        if (hintBtnNew) {
            hintBtnNew.addEventListener('click', (e) => {
                e.stopPropagation();
                hintButton.click();
            });
        }

        carousel.addEventListener('wheel', (e) => {
            if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                e.preventDefault();
                carousel.scrollLeft += e.deltaY;
            }
        }, { passive: false });

        function updateTutorialHintUI() {
            tutorialHintButton.dataset.hints = tutorialHints;
            tutorialHintsCount.textContent = tutorialHints;
            tutorialHintButton.disabled = tutorialOverlay.classList.contains('visible');
        }

        // build tutorial carousel once
        tutorialItems.forEach((item, index) => {
            const slide = document.createElement('div');
            slide.className = 'carousel-item';

            const icon = document.createElement('img');
            icon.className = 'carousel-icon';
            icon.src = item.getAttribute('src');
            icon.alt = item.dataset.name || `Item ${index + 1}`;

            const label = document.createElement('div');
            label.className = 'carousel-label';
            label.textContent = item.dataset.name || `Item ${index + 1}`;

            slide.appendChild(icon);
            slide.appendChild(label);

            item._carouselItem = slide;
            tutorialCarousel.appendChild(slide);
        });

        function startTutorialGuide() {
            tutorialGuideActive = true;
            tutorialFocusItem = tutorialItems[0];
            if (!tutorialFocusItem) return;
            tutorialGuideOverlay.classList.add('visible');
            tutorialFocusItem.classList.add('tutorial-focus', 'hint-highlight');
        }

        tutorialItems.forEach(item => {
            item.addEventListener('click', () => {
                if (tutorialOverlay.classList.contains('visible')) return;

                if (tutorialGuideActive && item !== tutorialFocusItem) return;
                if (item.dataset.found === 'true') return;

                item.dataset.found = 'true';
                tutorialFound++;

                playSound(soundHit);

                item.style.opacity = '0';
                item.style.transform = 'scale(0.8)';
                item.style.pointerEvents = 'none';

                if (item._carouselItem) item._carouselItem.classList.add('found');

                if (tutorialGuideActive && item === tutorialFocusItem) {
                    tutorialGuideActive = false;
                    tutorialGuideOverlay.classList.remove('visible');
                    item.classList.remove('tutorial-focus', 'hint-highlight');
                }

                if (tutorialFound === tutorialItems.length) tutorialOverlay.classList.add('visible');
            });
        });

        // Tutorial hint logic: if 0 -> show ad stub, reward +1 hint and use immediately
        function useTutorialHintNow(){
            if (tutorialHints <= 0) return;
            if (tutorialOverlay.classList.contains('visible')) return;

            const remaining = Array.from(tutorialItems).filter(item => item.dataset.found !== 'true');
            if (remaining.length === 0) return;

            const target = remaining[Math.floor(Math.random() * remaining.length)];
            target.classList.add('hint-highlight');

            tutorialHints--;
            updateTutorialHintUI();

            setTimeout(() => target.classList.remove('hint-highlight'), 1600);
        }

        tutorialHintButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (tutorialOverlay.classList.contains('visible')) return;

            const remaining = Array.from(tutorialItems).filter(item => item.dataset.found !== 'true');
            if (remaining.length === 0) return;

            if (tutorialHints <= 0) {
                showRewardedAd(() => {
                    tutorialHints = Math.min(2, tutorialHints + 1);
                    updateTutorialHintUI();
                    useTutorialHintNow();
                });
                return;
            }

            useTutorialHintNow();
        });

        function finishTutorialToMenu(){
            markUserCompletedTutorial().catch(() => {});

            tutorialOverlay.classList.remove('visible');
            tutorialGuideOverlay.classList.remove('visible');
            if (tutorialFocusItem) tutorialFocusItem.classList.remove('tutorial-focus', 'hint-highlight');
            setActiveScreen(menuScreen);
            applyLevelInfoToMenu(currentLevelIndex);
            startMenuMusic();
        }

        tutorialContinueBtn.addEventListener('click', finishTutorialToMenu);
        tutorialSkipBtn.addEventListener('click', (e) => { e.stopPropagation(); finishTutorialToMenu(); });

        function initTutorial() {
            tutorialFound = 0;
            tutorialHints = 2;
            tutorialGuideActive = false;
            tutorialFocusItem = null;

            tutorialItems.forEach(it => {
                it.dataset.found = 'false';
                it.style.opacity = '1';
                it.style.transform = '';
                it.style.pointerEvents = 'auto';
                it.classList.remove('tutorial-focus', 'hint-highlight');
                if (it._carouselItem) it._carouselItem.classList.remove('found');
            });

            updateTutorialHintUI();
            initTutorialLayout();
            updateScoreUI();
            updatePlayerUI();
            startTutorialGuide();
            requestAnimationFrame(layoutTutorialItems);
        }

        loginSubmitBtn.addEventListener('click', () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (authMode === 'login') performLogin(email, password).catch(() => {});
            else performRegistration(registerNameInput.value.trim(), email, password).catch(() => {});
        });

        loginAutofillBtn.addEventListener('click', async () => {
            loginErrorText.textContent = '';
            playerEmail = '';
            if (!playerName || playerName === 'Player') playerName = 'Guest';
            try {
                await coreSDK.loginAsGuest();
                await setAuthTypeLocal('guest');
                try { await storage.set(PLAYER_NAME_KEY, playerName); } catch (_) {}
            } catch (err) {
                console.warn('Guest SDK login failed:', err);
            }
            applyAuthUI();
            updatePlayerUI();
            hideLoginOverlay();
            goAfterLogin().catch(() => {});
        });

        loginGoogleBtn.addEventListener('click', async () => {
            loginErrorText.textContent = '';
            try {
                const { credential } = await coreSDK.getGoogleIdToken();
                await coreSDK.loginWithGoogle(credential);
                await setAuthTypeLocal('google');
                applyAuthUI();
                updatePlayerUI();
                hideLoginOverlay();
                goAfterLogin().catch(() => {});
            } catch (err) {
                console.error('Google login error:', err);
                loginErrorText.textContent = 'Google login failed. Try again.';
            }
        });

        switchAuthModeBtn.addEventListener('click', () => {
            authMode = authMode === 'login' ? 'register' : 'login';
            applyAuthMode();
        });

        function handleAuthEnter(e) {
            if (e.key === 'Enter') {
                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value.trim();
                if (authMode === 'login') performLogin(email, password).catch(() => {});
                else performRegistration(registerNameInput.value.trim(), email, password).catch(() => {});
            }
        }

        loginEmailInput.addEventListener('keydown', handleAuthEnter);
        loginPasswordInput.addEventListener('keydown', handleAuthEnter);
        registerNameInput.addEventListener('keydown', handleAuthEnter);

        loginAvatar.addEventListener('click', () => {
            if (authMode !== 'register') return;
            avatarFileInput && avatarFileInput.click();
        });

        avatarFileInput && avatarFileInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const dataUrl = ev.target.result;
                if (typeof dataUrl === 'string') {
                    playerAvatarSymbol = dataUrl;
                    updatePlayerUI();
                }
            };
            reader.readAsDataURL(file);
        });

        scoreboardButton && scoreboardButton.addEventListener('click', () => {
            setActiveScreen(scoreScreen);
            updateScoreUI();
            startMenuMusic();
        });

        function backToMenuFromScore() {
            setActiveScreen(menuScreen);
            updateScoreUI();
            startMenuMusic();
        }

        scoreBackButton && scoreBackButton.addEventListener('click', backToMenuFromScore);
        scoreBackBottomButton && scoreBackBottomButton.addEventListener('click', backToMenuFromScore);

        async function startGameWithRestore(levelIndex) {
            setActiveScreen(gameScreen);
            buildLevel(levelIndex);

            const restored = await restoreInProgressIfAny(levelIndex);
            if (!restored) {
                resetLevelState();
                if (!await hasInProgressForLevel(levelIndex)) await clearInProgress();
            }

            startLevelMusic(levelIndex);
            requestAnimationFrame(layoutItems);
        }

        playButton.addEventListener('click', () => {
            startGameWithRestore(currentLevelIndex).catch(() => {});
        });

        // DEBUG button: start level 1 instantly from any screen
        const debugBtn = document.getElementById('debugStartLevel1Btn');
        if (debugBtn) {
            debugBtn.style.display = 'block';
            debugBtn.addEventListener('click', () => {
                currentLevelIndex = 0;
                maxUnlockedLevel = Math.max(maxUnlockedLevel, 1);
                startGameWithRestore(0).catch(() => {});
            });
        }

        // âœ… confirm popup (English)
        startFromBeginningButton.addEventListener('click', () => {
            const ok = confirm('Do you really want to reset progress?');
            if (!ok) return;

            (async () => {
                await clearInProgress();

                maxUnlockedLevel = 1;
                currentLevelIndex = 0;
                await saveProgress();
                applyLevelInfoToMenu(currentLevelIndex);
                await startGameWithRestore(currentLevelIndex);
            })().catch(() => {});
        });

        (function enablePressFeedback(){
            let currentPressed = null;

            function getBtn(target){
                return target && target.closest && target.closest('button, .btn, .play-btn, .menu-settings-btn, .menu-button, .hint-button, .tutorial-skip-btn, .settings-toggle, .menu-section-btn, .login-switch');
            }

            document.addEventListener('pointerdown', (e) => {
                const b = getBtn(e.target);
                if (!b || b.disabled) return;
                if (currentPressed && currentPressed !== b) {
                    currentPressed.classList.remove('is-pressed');
                }
                currentPressed = b;
                b.classList.add('is-pressed');
            }, true);

            function clearPressed(){
                if (currentPressed) {
                    currentPressed.classList.remove('is-pressed');
                    currentPressed = null;
                }
            }
            document.addEventListener('pointerup', clearPressed, true);
            document.addEventListener('pointercancel', clearPressed, true);
            document.addEventListener('pointerleave', clearPressed, true);

            document.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                const b = getBtn(document.activeElement);
                if (!b || b.disabled) return;
                if (currentPressed && currentPressed !== b) {
                    currentPressed.classList.remove('is-pressed');
                }
                currentPressed = b;
                b.classList.add('is-pressed');
            }, true);
            document.addEventListener('keyup', (e) => {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                clearPressed();
            }, true);
        })();

        // auto-save on leaving/hiding
        window.addEventListener('pagehide', () => {
            if (gameScreen.classList.contains('active') && foundCount < items.length) {
                saveInProgress('pagehide').catch(() => {});
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                if (gameScreen.classList.contains('active') && foundCount < items.length) {
                    saveInProgress('hidden').catch(() => {});
                }
            }
        });
    }
</script>
<script src="cordova.js"></script>
<script>
    (function (w) {
        console.log('[AppLovinMediator] loaded');

        class AppLovinMediator {
            constructor() {
                this.ready = new Map();
                this.loading = new Map();
                this.adViews = new Set();
                this.initialized = false;
                this.initPromise = null;
                this.max = null;
                this.loadTimeoutMs = 15000;
                this.showTimeoutMs = 15000;
            }

            async init(adsConfig) {
                if (this.initialized) return;
                if (this.initPromise) return this.initPromise;

                this.initPromise = (async () => {
                    await this.waitForDeviceReady();

                    const sdk = await this.waitForSdk(15000);
                    if (!sdk) {
                        throw new Error('APPLOVIN_MAX_NOT_AVAILABLE');
                    }

                    this.loadTimeoutMs =
                        adsConfig?.defaults?.loadTimeoutMs ?? this.loadTimeoutMs;
                    this.showTimeoutMs =
                        adsConfig?.defaults?.showTimeoutMs ?? this.showTimeoutMs;

                    const sdkKey = adsConfig?.mediators?.applovin?.sdkKey;
                    if (!sdkKey) {
                        throw new Error('SDK_KEY_MISSING');
                    }

                    await new Promise(resolve => {
                        sdk.initialize(sdkKey, () => {
                            console.log('[AppLovin] initialized');
                            sdk.setTestDeviceAdvertisingIds(['EMULATOR']);
                            resolve();
                        });
                    });

                    this.max = sdk;
                    this.initialized = true;
                })();

                return this.initPromise;
            }

            async load(type, placement, placementConfig) {
                if (!['rewarded', 'interstitial', 'banner'].includes(type)) return;
                if (!this.initialized || !this.max) {
                    if (this.initPromise) {
                        await this.initPromise;
                    }
                    if (!this.initialized || !this.max) {
                        throw new Error('NOT_INITIALIZED');
                    }
                }

                const envConfig =
                    placementConfig?.cordova ||
                    placementConfig?.android ||
                    placementConfig?.ios ||
                    placementConfig;
                const adUnitId = envConfig?.adUnitId;
                if (!adUnitId) {
                    throw new Error('AD_UNIT_ID_MISSING');
                }

                if (this.ready.get(placement)) return;

                const inFlight = this.loading.get(adUnitId);
                if (inFlight) return inFlight;

                const loadPromise = new Promise((resolve, reject) => {
                    const timeoutMs = this.getTimeoutMs(
                        placementConfig,
                        'loadTimeoutMs',
                        this.loadTimeoutMs
                    );

                    const onLoaded = evt => {
                        if (evt?.adUnitId !== adUnitId) return;
                        this.ready.set(placement, true);
                        cleanup();
                        resolve();
                    };

                    const onFailed = evt => {
                        if (evt?.adUnitId && evt.adUnitId !== adUnitId) return;
                        cleanup();
                        reject(new Error('LOAD_FAILED'));
                    };

                    let loadedEvent = null;
                    let failedEvent = null;
                    let timeoutId = null;

                    const cleanup = () => {
                        if (timeoutId) clearTimeout(timeoutId);
                        if (loadedEvent) {
                            window.removeEventListener(loadedEvent, onLoaded);
                        }
                        if (failedEvent) {
                            window.removeEventListener(failedEvent, onFailed);
                        }
                    };

                    if (type === 'rewarded') {
                        loadedEvent = 'OnRewardedAdLoadedEvent';
                        failedEvent = 'OnRewardedAdLoadFailedEvent';
                        window.addEventListener(loadedEvent, onLoaded);
                        window.addEventListener(failedEvent, onFailed);
                        timeoutId = setTimeout(() => {
                            cleanup();
                            reject(new Error('LOAD_TIMEOUT'));
                        }, timeoutMs);
                        this.max.loadRewardedAd(adUnitId);
                        return;
                    }

                    if (type === 'interstitial') {
                        loadedEvent = 'OnInterstitialLoadedEvent';
                        failedEvent = 'OnInterstitialLoadFailedEvent';
                        window.addEventListener(loadedEvent, onLoaded);
                        window.addEventListener(failedEvent, onFailed);
                        timeoutId = setTimeout(() => {
                            cleanup();
                            reject(new Error('LOAD_TIMEOUT'));
                        }, timeoutMs);
                        this.max.loadInterstitial(adUnitId);
                        return;
                    }

                    const format = this.getAdViewFormat(placementConfig);
                    loadedEvent =
                        format === 'mrec'
                            ? 'OnMRecAdLoadedEvent'
                            : 'OnBannerAdLoadedEvent';
                    failedEvent =
                        format === 'mrec'
                            ? 'OnMRecAdLoadFailedEvent'
                            : 'OnBannerAdLoadFailedEvent';

                    window.addEventListener(loadedEvent, onLoaded);
                    window.addEventListener(failedEvent, onFailed);
                    timeoutId = setTimeout(() => {
                        cleanup();
                        reject(new Error('LOAD_TIMEOUT'));
                    }, timeoutMs);
                    this.ensureAdViewCreated(adUnitId, format, placement, placementConfig);
                }).finally(() => {
                    this.loading.delete(adUnitId);
                });

                this.loading.set(adUnitId, loadPromise);
                return loadPromise;
            }

            show(type, placement, placementConfig, done) {
                if (!this.initialized || !this.max) {
                    done({ status: 'NOT_READY', canReward: false });
                    return;
                }

                const envConfig =
                    placementConfig?.cordova ||
                    placementConfig?.android ||
                    placementConfig?.ios ||
                    placementConfig;
                const adUnitId = envConfig?.adUnitId;
                if (!adUnitId) {
                    done({ status: 'NOT_READY', canReward: false });
                    return;
                }

                if (type === 'banner') {
                    const format = this.getAdViewFormat(placementConfig);
                    const isReady = this.ready.get(placement);
                    if (!isReady) {
                        done({ status: 'NOT_READY', canReward: false });
                        return;
                    }

                    this.ensureAdViewCreated(adUnitId, format, placement, placementConfig);

                    if (format === 'mrec') {
                        this.max.showMRec(adUnitId);
                    } else {
                        this.max.showBanner(adUnitId);
                    }

                    done({ status: 'COMPLETED', canReward: false });
                    return;
                }

                if (type === 'interstitial') {
                    const isReady =
                        this.ready.get(placement) ||
                        this.max.isInterstitialReady(adUnitId);

                    if (!isReady) {
                        done({ status: 'NOT_READY', canReward: false });
                        return;
                    }

                    let finished = false;

                    const finish = res => {
                        if (finished) return;
                        finished = true;
                        this.ready.set(placement, false);
                        cleanup();
                        done(res);
                    };

                    const onFailedToDisplay = evt => {
                        if (evt?.adUnitId && evt.adUnitId !== adUnitId) return;
                        finish({ status: 'SHOW_FAILED', canReward: false, errorMessage: evt?.errorMessage || 'SHOW_FAILED' });
                    };

                    const onHidden = evt => {
                        if (evt?.adUnitId && evt.adUnitId !== adUnitId) return;
                        this.ready.set(placement, false);
                        finish({ status: 'COMPLETED', canReward: false });
                    };

                    let timeoutId = null;

                    const cleanup = () => {
                        if (timeoutId) clearTimeout(timeoutId);
                        window.removeEventListener('OnInterstitialAdFailedToDisplayEvent', onFailedToDisplay);
                        window.removeEventListener('OnInterstitialHiddenEvent', onHidden);
                    };

                    window.addEventListener('OnInterstitialAdFailedToDisplayEvent', onFailedToDisplay);
                    window.addEventListener('OnInterstitialHiddenEvent', onHidden);

                    console.log('[AppLovinMediator] Showing interstitial â€” close with Back button or X to continue');
                    // Show real AppLovin interstitial; game resumes only after OnInterstitialHiddenEvent fires
                    // (user must close the ad via Back button or X â€” there is no programmatic close API)
                    this.max.showInterstitial(adUnitId, placement);
                    return;
                }

                if (type !== 'rewarded') {
                    done({ status: 'NOT_READY', canReward: false });
                    return;
                }

                const isReady =
                    this.ready.get(placement) || this.max.isRewardedAdReady(adUnitId);

                if (!isReady) {
                    done({ status: 'NOT_READY', canReward: false });
                    return;
                }

                let finished = false;
                let rewarded = false;

                const finish = res => {
                    if (finished) return;
                    finished = true;
                    this.ready.set(placement, false);
                    cleanup();
                    done(res);
                };

                const onReward = evt => {
                    if (evt?.adUnitId && evt.adUnitId !== adUnitId) return;
                    rewarded = true;
                    finish({ status: 'REWARD_GRANTED', canReward: true, rewardType: placementConfig.rewardType, rewardAmount: placementConfig.rewardAmount });
                };

                const onFailedToDisplay = evt => {
                    if (evt?.adUnitId && evt.adUnitId !== adUnitId) return;
                    finish({ status: 'SHOW_FAILED', canReward: false, errorMessage: evt?.errorMessage || 'SHOW_FAILED' });
                };

                const onHidden = evt => {
                    if (evt?.adUnitId && evt.adUnitId !== adUnitId) return;
                    this.ready.set(placement, false);
                    if (!rewarded) {
                        finish({ status: 'CLOSED', canReward: false });
                    }
                };

                let timeoutId = null;

                const cleanup = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    window.removeEventListener('OnRewardedAdReceivedRewardEvent', onReward);
                    window.removeEventListener('OnRewardedAdFailedToDisplayEvent', onFailedToDisplay);
                    window.removeEventListener('OnRewardedAdHiddenEvent', onHidden);
                };

                window.addEventListener('OnRewardedAdReceivedRewardEvent', onReward);
                window.addEventListener('OnRewardedAdFailedToDisplayEvent', onFailedToDisplay);
                window.addEventListener('OnRewardedAdHiddenEvent', onHidden);

                timeoutId = setTimeout(() => {
                    finish({ status: 'TIMEOUT', canReward: false });
                }, this.getTimeoutMs(placementConfig, 'showTimeoutMs', this.showTimeoutMs));

                this.max.showRewardedAd(adUnitId, placement);
            }

            getAdViewFormat(placementConfig) {
                const envConfig =
                    placementConfig?.cordova ||
                    placementConfig?.android ||
                    placementConfig?.ios ||
                    placementConfig;
                const format =
                    envConfig?.adViewFormat ||
                    envConfig?.format ||
                    placementConfig?.adViewFormat ||
                    placementConfig?.format ||
                    'banner';
                return format === 'mrec' ? 'mrec' : 'banner';
            }

            getAdViewPosition(placementConfig, format) {
                const envConfig =
                    placementConfig?.cordova ||
                    placementConfig?.android ||
                    placementConfig?.ios ||
                    placementConfig;
                const position =
                    envConfig?.adViewPosition ||
                    envConfig?.position ||
                    envConfig?.bannerPosition ||
                    envConfig?.mrecPosition ||
                    placementConfig?.adViewPosition ||
                    placementConfig?.position ||
                    placementConfig?.bannerPosition ||
                    placementConfig?.mrecPosition;
                if (position) return position;
                return format === 'mrec' ? 'centered' : 'bottom_center';
            }

            getTimeoutMs(placementConfig, key, fallback) {
                const envConfig =
                    placementConfig?.cordova ||
                    placementConfig?.android ||
                    placementConfig?.ios ||
                    placementConfig;
                const value = envConfig?.[key] ?? placementConfig?.[key];
                if (typeof value === 'number' && value > 0) return value;
                return fallback;
            }

            ensureAdViewCreated(adUnitId, format, placement, placementConfig) {
                if (this.adViews.has(adUnitId)) return;

                const position = this.getAdViewPosition(placementConfig, format);
                if (format === 'mrec') {
                    this.max.createMRec(adUnitId, position);
                    this.max.setMRecPlacement(adUnitId, placement);
                } else {
                    this.max.createBanner(adUnitId, position);
                    this.max.setBannerPlacement(adUnitId, placement);
                }

                this.adViews.add(adUnitId);
            }

            waitForSdk(timeoutMs) {
                const current = () =>
                    w.applovin ||
                    w.AppLovinMAX ||
                    this.safeCordovaRequire('cordova-plugin-applovin-max.AppLovinMAX');
                const existing = current();
                if (existing) return Promise.resolve(existing);

                return new Promise(resolve => {
                    const start = Date.now();
                    const timer = setInterval(() => {
                        const sdk = current();
                        if (sdk || Date.now() - start >= timeoutMs) {
                            clearInterval(timer);
                            resolve(sdk || null);
                        }
                    }, 100);
                });
            }

            waitForDeviceReady() {
                if (w.cordova?.channel?.onDeviceReady && w.cordova.channel.onDeviceReady.fired) {
                    return Promise.resolve();
                }
                return new Promise(resolve =>
                    document.addEventListener('deviceready', resolve, { once: true })
                );
            }

            safeCordovaRequire(moduleId) {
                if (!w.cordova?.require) return null;
                try {
                    return w.cordova.require(moduleId);
                } catch (err) {
                    return null;
                }
            }
        }

        w.AppLovinMediator = () => {
            if (!w.__applovinMediator) {
                w.__applovinMediator = new AppLovinMediator();
            }
            return w.__applovinMediator;
        };
    })(window);
</script>
<!-- Mock mediator for browser testing (no-op in Cordova) -->
<script>
    (function(w) {
        if (w.cordova) return; // skip in real APK

        class MockAdMediator {
            constructor() {
                this.adViews = new Map();
            }

            async init() {
                console.log('[MockAd] init() called');
            }

            async load(type, placement) {
                console.log('[MockAd] load() called â€” type:', type, 'placement:', placement);
                return new Promise(resolve => setTimeout(resolve, 300));
            }

            show(type, placement, config, done) {
                console.log('[MockAd] show() called â€” type:', type, 'placement:', placement, 'config:', JSON.stringify(config));
                if (type === 'banner') {
                    console.log('[MockAd] Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð±Ð°Ð½Ð½ÐµÑ€-Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ Ð´Ð»Ñ placement:', placement);
                    this._showBannerView(placement, config);
                    done({ status: 'COMPLETED', type, placement, canReward: false, timestamp: Date.now() });
                    return;
                }
                console.log('[MockAd] Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ overlay-Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ Ð´Ð»Ñ type:', type);
                this._renderOverlay(type, placement, config, done);
            }

            _showBannerView(placement, config) {
                if (this.adViews.has(placement)) {
                    console.log('[MockAd] Ð±Ð°Ð½Ð½ÐµÑ€ ÑƒÐ¶Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½ Ð´Ð»Ñ placement:', placement, 'â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼');
                    return;
                }
                const isMrec = (config?.cordova?.adViewFormat || config?.web?.adViewFormat || '') === 'mrec';
                const label = (isMrec ? 'MREC' : 'BANNER') + ' Â· ' + placement;

                // Fill existing ad placeholder containers instead of creating a fixed overlay
                const selectors = isMrec
                    ? '.win-ad, .menu-ad-banner, .game-ad-banner'
                    : '.menu-ad-banner, .game-ad-banner, .win-ad';
                const containers = document.querySelectorAll(selectors);
                containers.forEach(container => {
                    container.textContent = label;
                    container.style.cssText += ';background:#222;color:#fff;font:600 13px system-ui;display:flex;align-items:center;justify-content:center;border-radius:10px;';
                });
                console.log('[MockAd] Ð±Ð°Ð½Ð½ÐµÑ€-Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ð»Ð°', containers.length, 'ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² â€” placement:', placement);
                this.adViews.set(placement, Array.from(containers));
            }

            _renderOverlay(type, placement, config, done) {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:2147483647;font-family:system-ui';

                const card = document.createElement('div');
                card.style.cssText = 'background:#fff;border-radius:14px;padding:24px;width:300px;display:flex;flex-direction:column;gap:12px';
                card.innerHTML = `
                <div style="font:700 17px system-ui">Mock Ad</div>
                <div style="color:#666;font-size:13px">type: <b>${type}</b> Â· placement: <b>${placement}</b></div>
            `;

                const btns = document.createElement('div');
                btns.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px';

                const addBtn = (label, status, primary) => {
                    const b = document.createElement('button');
                    b.textContent = label;
                    b.style.cssText = `border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font:600 13px system-ui;background:${primary ? '#111' : '#eee'};color:${primary ? '#fff' : '#111'}`;
                    b.onclick = e => { e.stopPropagation(); overlay.remove(); done({ status, type, placement, canReward: status === 'REWARD_GRANTED', timestamp: Date.now() }); };
                    btns.appendChild(b);
                };

                addBtn('Complete', 'COMPLETED', true);
                if (type === 'rewarded') addBtn('Reward', 'REWARD_GRANTED', true);
                addBtn('Cancel', 'CANCELLED', false);

                card.appendChild(btns);
                overlay.appendChild(card);
                overlay.onclick = () => { overlay.remove(); done({ status: 'CANCELLED', type, placement, canReward: false, timestamp: Date.now() }); };
                card.onclick = e => e.stopPropagation();
                document.body.appendChild(overlay);
            }
        }

        w.MockAdMediator = () => {
            if (!w.__mockAdMediator) {
                console.log('[MockAd] ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ MockAdMediator');
                w.__mockAdMediator = new MockAdMediator();
            }
            return w.__mockAdMediator;
        };
    })(window);
</script>
<script src="game-sdk.umd.js"></script>
<script>
    var APPLOVIN_ADS_CONFIG = {
        enabled: true,
        defaults: {
            preloadOnStart: true,
            loadTimeoutMs: 30000,
            showTimeoutMs: 60000,
        },
        mediators: {
            applovin: {
                sdkKey: 'VB_0zSp_AExpJn74kcSysTwAMgnwt8wLq2TUvGUU9LxLT3HCmDiFMRQhEnowdyOOWK1fDsgn5XkIM0zpXqT2Fi',
            },
            mock: {},
        },
        placements: {
            aoa: {
                type: 'interstitial',
                cordova: { mediator: 'applovin', adUnitId: 'ec645817ca73545e' },
                web: { mediator: 'mock', adUnitId: 'mock_aoa' },
            },
            find_object_inter: {
                type: 'interstitial',
                cordova: { mediator: 'applovin', adUnitId: '599eb0c0de95ab11' },
                web: { mediator: 'mock', adUnitId: 'mock_inter' },
            },
            reward: {
                type: 'rewarded',
                cordova: { mediator: 'applovin', adUnitId: 'd2d8ec71ef348184' },
                web: { mediator: 'mock', adUnitId: 'mock_reward' },
            },
            find_object_banner: {
                type: 'banner',
                cordova: { mediator: 'applovin', adUnitId: '2bcee5347a2c6bd6' },
                web: { mediator: 'mock', adUnitId: 'mock_banner' },
            },
        },
    };

    (function() {
        const MAX_RETRIES = 20;
        let retries = 0;

        function registerMediators() {
            // Register mediators BEFORE init so they're in the registry when initAds runs
            if (!coreSDK.ads || typeof coreSDK.ads.registerMediator !== 'function') {
                console.warn('[ADS] coreSDK.ads or registerMediator not available');
                return;
            }
            if (window.cordova) {
                console.log('[ADS] AppLovinMediator on window:', !!window.AppLovinMediator);
                if (window.AppLovinMediator) {
                    coreSDK.ads.registerMediator('applovin', window.AppLovinMediator);
                    console.log('[ADS] applovin mediator registered');
                }
            } else {
                if (window.MockAdMediator) {
                    coreSDK.ads.registerMediator('mock', window.MockAdMediator);
                    console.log('[ADS] mock mediator registered');
                }
            }
        }

        function applyAdsConfig() {
            // setMockConfig must be called AFTER init â€” refreshAll during init overwrites configState
            // Calling it after init triggers onConfigUpdated() in AdManager via configsupdated event
            if (coreSDK.ads && coreSDK.ads.setMockConfig) {
                coreSDK.ads.setMockConfig(APPLOVIN_ADS_CONFIG);
                console.log('[ADS] setMockConfig applied post-init OK');
            } else {
                console.warn('[ADS] setMockConfig not available on coreSDK.ads');
            }
        }

        function doInit() {
            var initOpts = {
                app: "test-frontend",
                version: '1.0.108',
            };
            if (window.cordova) {
                initOpts.configUrl  = 'https://stage-configs.artintgames.com';
                initOpts.authUrl    = 'https://stage-auth.artintgames.com';
                initOpts.profileUrl = 'https://stage-profile.artintgames.com';
            }
            console.log('[INIT] coreSDK.init opts:', JSON.stringify(initOpts));
            // Register mediators before init so they're in registry when initAds runs
            registerMediators();
            Promise.resolve(coreSDK.init(initOpts))
                .then(function(state) {
                    console.log('[INIT] SUCCESS uid:', state && state.user && state.user.uid);
                    // setMockConfig AFTER init (refreshAll during init overwrites configState).
                    // Then re-call ads.init() because the first initAds() exited early (no config),
                    // so the configsupdated listener was never registered.
                    if (coreSDK.ads && coreSDK.ads.setMockConfig) {
                        coreSDK.ads.setMockConfig(APPLOVIN_ADS_CONFIG);
                        console.log('[ADS] setMockConfig OK, re-initing AdManager...');
                        return Promise.resolve(coreSDK.ads.init())
                            .then(function() { console.log('[ADS] ads.init() re-run OK'); })
                            .catch(function(e) { console.warn('[ADS] ads.init() re-run failed:', e && e.message); });
                    }
                })
                .then(function() {
                    console.log('[ADS] ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ startAiGame â€” coreSDK.ads:', !!coreSDK?.ads, 'showAd:', typeof coreSDK?.ads?.showAd);
                    startAiGame();
                })
                .catch(function(err) {
                    console.error('[INIT] FAILED:', err && (err.message || String(err)));
                    console.warn('[ADS] startAiGame Ð²Ñ‹Ð·Ð²Ð°Ð½ Ð¿Ð¾ÑÐ»Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ SDK â€” coreSDK.ads:', !!coreSDK?.ads, 'showAd:', typeof coreSDK?.ads?.showAd);
                    startAiGame();
                });
        }

        function tryInitSDK() {
            console.log('[BOOT] attempt=' + retries + ' coreSDK:', typeof coreSDK !== 'undefined', 'cordova:', !!window.cordova);
            if (typeof coreSDK !== 'undefined') {
                if (window.cordova) {
                    console.log('[BOOT] waiting for deviceready...');
                    document.addEventListener('deviceready', function() {
                        console.log('[BOOT] deviceready fired!');
                        document.body.classList.add('is-cordova');
                        doInit();
                    }, { once: true });
                } else {
                    doInit();
                }
            } else if (retries < MAX_RETRIES) {
                retries++;
                setTimeout(tryInitSDK, 500);
            } else {
                console.error('[BOOT] âŒ SDK ÐÐ• Ð—ÐÐ“Ð Ð£Ð—Ð˜Ð›Ð¡Ð¯ Ð·Ð° ' + (MAX_RETRIES * 500) + 'Ð¼Ñ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ URL ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° SDK Ð² Ñ‚ÐµÐ³Ðµ <script src="...">. startAiGame() ÐÐ• Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹Ð·Ð²Ð°Ð½, Ñ€ÐµÐºÐ»Ð°Ð¼Ð° ÐÐ• Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚ÑÑ.');
            }
        }
        tryInitSDK();
    })();
</script>
<script>
(function() {
  if (!window.cordova) return;
  var FALLBACK_WEB_CLIENT_ID = '660405658458-a7nlkksb8s2b8341bubgien9ojgei5f9.apps.googleusercontent.com';
  var MAX_TRIES = 30;
  var TRY_DELAY_MS = 300;

  function resolveWebClientId() {
    try {
      if (typeof coreSDK !== 'undefined' && typeof coreSDK.loadOAuthConfig === 'function' && typeof coreSDK.getGoogleClientId === 'function') {
        return coreSDK.loadOAuthConfig()
          .then(function() { return coreSDK.getGoogleClientId() || FALLBACK_WEB_CLIENT_ID; })
          .catch(function() { return FALLBACK_WEB_CLIENT_ID; });
      }
    } catch (e) {}
    return Promise.resolve(FALLBACK_WEB_CLIENT_ID);
  }

  function installOverride() {
    if (!window.plugins || !window.plugins.googleplus) {
      console.warn('[GoogleAuth] cordova-plugin-googleplus not available');
      return false;
    }
    if (typeof coreSDK === 'undefined') {
      return false;
    }
    coreSDK.getGoogleIdToken = function() {
      return resolveWebClientId().then(function(webClientId) {
        return new Promise(function(resolve, reject) {
          window.plugins.googleplus.login(
            { webClientId: webClientId, offline: true },
            function(obj) {
              console.log('[GoogleAuth] native login OK:', obj.email);
              resolve({ credential: obj.idToken });
            },
            function(err) {
              console.error('[GoogleAuth] native login failed:', err);
              reject(new Error('Google Sign-In failed: ' + String(err)));
            }
          );
        });
      });
    };
    console.log('[GoogleAuth] Cordova native Google Sign-In override installed');
    return true;
  }

  document.addEventListener('deviceready', function() {
    if (installOverride()) return;
    var tries = 0;
    var timer = setInterval(function() {
      tries += 1;
      if (installOverride() || tries >= MAX_TRIES) {
        clearInterval(timer);
        if (tries >= MAX_TRIES) {
          console.warn('[GoogleAuth] coreSDK not available after retries; override not installed');
        }
      }
    }, TRY_DELAY_MS);
  }, { once: true });
})();
</script>
</body>
</html>
